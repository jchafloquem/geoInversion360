import{a as At}from"./chunk-53W5VINP.js";import{a as Rs}from"./chunk-FVCUBGKZ.js";import{a as ie,c as Vs}from"./chunk-2KT2ZI22.js";import{b as Fs}from"./chunk-XJWOA2PX.js";import{A as Ls,a as xt,b as ce,c as Qe,f as Es,g as Be,i as Os,j as vs,k as Ss,l as Is,m as re,p as Ds,q as yt,r as Bs,s as Ns,z as _}from"./chunk-BMJVGRDY.js";import"./chunk-PTXLSCMJ.js";import{b as rr,c as Cs,d as sr,e as Ps,f as ws}from"./chunk-ISHQZQES.js";import"./chunk-RNSOHYED.js";import"./chunk-HBSQWDA6.js";import"./chunk-AZQXDF5K.js";import{a as Ms}from"./chunk-QJQYLZHX.js";import{c as Y,d as Tt,e as _t,g as Z}from"./chunk-ZYBGZLJ2.js";import"./chunk-7FVU4GPM.js";import"./chunk-PCE3ZAVU.js";import"./chunk-GMW3QDVG.js";import{a as er,d as tr}from"./chunk-7KE3QZH7.js";import{c as cs,d as ms}from"./chunk-37H4LYIE.js";import{h as ls,i as us,j as _e}from"./chunk-SRPI622Y.js";import{a as hs}from"./chunk-RHABF3KL.js";import{a as xe,b as ys,c as bs}from"./chunk-47V2EQBG.js";import{a as De}from"./chunk-3Q427ME6.js";import"./chunk-VLZLY64K.js";import{b as ps,e as ds,h as gs,j as Ts,k as As,l as xs}from"./chunk-JQEUH42O.js";import{a as Jt}from"./chunk-U436ZYW5.js";import{b as gt}from"./chunk-PW4AR57W.js";import{a as $,b as Ae,e as ue,f as _s,g as H,i as Ke}from"./chunk-OW7DVBQB.js";import"./chunk-X2T2CBLR.js";import"./chunk-IFFYADB3.js";import{b as fs}from"./chunk-LHY2TOIB.js";import"./chunk-I3S324BU.js";import{a as Jr,c as ot}from"./chunk-YWOXCT5Q.js";import{a as L}from"./chunk-I46GU3Q4.js";import{a as O}from"./chunk-H5IJXG2U.js";import{d as Zr}from"./chunk-2EA2KAER.js";import"./chunk-2NH7HOKA.js";import{c as ne,i as K,j as Q,k as le,l as we,n as Te,w as Wt,x as es,z as te}from"./chunk-ZAQLF7TN.js";import{a as ts,c as pt}from"./chunk-BQGKYIFD.js";import{b as ns,e as Zt}from"./chunk-5Z4RIO4Y.js";import{b as as,d as os,f as $t,i as Yt}from"./chunk-Z6XPPWSB.js";import"./chunk-VV6VBK4L.js";import"./chunk-GXZQZHAF.js";import{a as rs,g as Xt,n as ss}from"./chunk-MJ4RSERD.js";import{a as Kt,b as is,c as Qt}from"./chunk-BVW6ULEA.js";import{a as nt,b as dt}from"./chunk-7C6Z24SS.js";import{D as Yr,a as Wr,b as Xr,c as We,d as at,o as Kr,p as Xe,s as Qr,t as $r}from"./chunk-3M7QKELQ.js";import"./chunk-J57HR4DB.js";import"./chunk-PJQZD5QI.js";import{a as Hr,e as qe,h as kr,i as jr,k as ft}from"./chunk-BYQI7UDX.js";import{b as qr}from"./chunk-Z5Q76SB7.js";import{d as kt,s as jt,t as qt}from"./chunk-5QLB7ZJ7.js";import"./chunk-E5R4OI7X.js";import"./chunk-LM5MGO7W.js";import"./chunk-TCCAOREC.js";import"./chunk-BCREO4Q5.js";import"./chunk-SO6OJFOM.js";import"./chunk-DG5QI6E2.js";import{o as Ht}from"./chunk-TMZNSBQB.js";import{B as Ce,C as zt,D as st,E as it,F as ge,G as Ur,I as Gr,K as Pe,L as zr,a as M,b as je,c as pe,d as rt,e as Vr,j as q,k as Ie,l as U,m as W,n as oe,p as Gt,u as X,v as de,x as Fr}from"./chunk-ZGLJFDS6.js";import"./chunk-RSDQHAJX.js";import"./chunk-OFVMJORF.js";import"./chunk-2FYXACXP.js";import"./chunk-RP7XSKHE.js";import{a as Br}from"./chunk-VV7MGXTC.js";import{c as Ut}from"./chunk-IXNVQC76.js";import"./chunk-5TSEU5EE.js";import"./chunk-VC35VCVT.js";import"./chunk-MT7BXRRQ.js";import{a as Nr}from"./chunk-NNKLK2DS.js";import{_ as Dr,aa as Lr,w as Ft,x as wr}from"./chunk-BRGZVJPZ.js";import{C as Pr}from"./chunk-Z5NXR7SL.js";import"./chunk-7JLWSSXP.js";import{a as T}from"./chunk-W3WDPWBE.js";import{g as Ir,h as Lt,k as Vt,m as Cr}from"./chunk-JKP4I6UL.js";import{c as Or,d as vr}from"./chunk-TZHKPIVH.js";import"./chunk-JPDAKIWT.js";import{a as Sr}from"./chunk-W6LY37E4.js";import{q as ht,s as ke}from"./chunk-BRWS572J.js";import{A as Rr,D as Er,a as yr,o as br,q as ze,s as He,v as Mr}from"./chunk-AKNRR36C.js";import{a as j,b as fe,g as k}from"./chunk-JEGVIFEP.js";function $e(t){if(t==null)return null;let e=t.offset!=null?t.offset:cs,r=t.rotation!=null?t.rotation:0,s=t.scale!=null?t.scale:ms,n=dt(1,0,0,0,1,0,e[0],e[1],1),a=dt(Math.cos(r),-Math.sin(r),0,Math.sin(r),Math.cos(r),0,0,0,1),o=dt(s[0],0,0,0,s[1],0,0,0,1),l=nt();return Xt(l,a,o),Xt(l,n,l),l}var ir=class{constructor(){this.geometries=new Array,this.materials=new Array,this.textures=new Array}},bt=class{constructor(e,r,s){this.name=e,this.lodThreshold=r,this.pivotOffset=s,this.stageResources=new ir,this.numberOfVertices=0}};function Us(t){if(t.length<Er)return Array.from(t);if(Rr(t))return Float64Array.from(t);if(!("BYTES_PER_ELEMENT"in t))return Array.from(t);switch(t.BYTES_PER_ELEMENT){case 1:return Uint8Array.from(t);case 2:return Mr(t)?Uint16Array.from(t):Int16Array.from(t);case 4:return Float32Array.from(t);default:return Float64Array.from(t)}}var Mt=class t{constructor(e,r,s){this.primitiveIndices=e,this._numIndexPerPrimitive=r,this.position=s,this._children=void 0,L(e.length>=1),L(s.size===3||s.size===4);let{data:n,size:a,indices:o}=s;L(o.length%this._numIndexPerPrimitive==0),L(o.length>=e.length*this._numIndexPerPrimitive);let l=e.length,i=a*o[this._numIndexPerPrimitive*e[0]];Ne.clear(),Ne.push(i);let c=pe(n[i],n[i+1],n[i+2]),u=je(c);for(let h=0;h<l;++h){let p=this._numIndexPerPrimitive*e[h];for(let b=0;b<this._numIndexPerPrimitive;++b){i=a*o[p+b],Ne.push(i);let d=n[i];c[0]=Math.min(d,c[0]),u[0]=Math.max(d,u[0]),d=n[i+1],c[1]=Math.min(d,c[1]),u[1]=Math.max(d,u[1]),d=n[i+2],c[2]=Math.min(d,c[2]),u[2]=Math.max(d,u[2])}}this.bbMin=c,this.bbMax=u;let m=it(M(),this.bbMin,this.bbMax,.5);this.radius=.5*Math.max(Math.max(u[0]-c[0],u[1]-c[1]),u[2]-c[2]);let f=this.radius*this.radius;for(let h=0;h<Ne.length;++h){i=Ne.at(h);let p=n[i]-m[0],b=n[i+1]-m[1],d=n[i+2]-m[2],D=p*p+b*b+d*d;if(D<=f)continue;let I=Math.sqrt(D),w=.5*(I-this.radius);this.radius=this.radius+w,f=this.radius*this.radius;let B=w/I;m[0]+=p*B,m[1]+=b*B,m[2]+=d*B}this.center=m,Ne.clear()}getChildren(){if(this._children||Fr(this.bbMin,this.bbMax)<=1)return this._children;let e=it(M(),this.bbMin,this.bbMax,.5),r=this.primitiveIndices.length,s=new Uint8Array(r),n=new Array(8);for(let u=0;u<8;++u)n[u]=0;let{data:a,size:o,indices:l}=this.position;for(let u=0;u<r;++u){let m=0,f=this._numIndexPerPrimitive*this.primitiveIndices[u],h=o*l[f],p=a[h],b=a[h+1],d=a[h+2];for(let D=1;D<this._numIndexPerPrimitive;++D){h=o*l[f+D];let I=a[h],w=a[h+1],B=a[h+2];I<p&&(p=I),w<b&&(b=w),B<d&&(d=B)}p<e[0]&&(m|=1),b<e[1]&&(m|=2),d<e[2]&&(m|=4),s[u]=m,++n[m]}let i=0;for(let u=0;u<8;++u)n[u]>0&&++i;if(i<2)return;let c=new Array(8);for(let u=0;u<8;++u)c[u]=n[u]>0?new Uint32Array(n[u]):void 0;for(let u=0;u<8;++u)n[u]=0;for(let u=0;u<r;++u){let m=s[u];c[m][n[m]++]=this.primitiveIndices[u]}this._children=new Array;for(let u=0;u<8;++u)c[u]!==void 0&&this._children.push(new t(c[u],this._numIndexPerPrimitive,this.position));return this._children}static prune(){Ne.prune()}},Ne=new Sr({deallocator:null});function Ni(t){return t?{p0:je(t.p0),p1:je(t.p1),p2:je(t.p2)}:{p0:M(),p1:M(),p2:M()}}function zs(t,e,r){return oe(ar,e,t),oe(Gs,r,t),.5*q(st(ar,ar,Gs))}var _o=new er(Ms),Ao=new er(()=>Ni()),ar=M(),Gs=M();function Hs(t,e){if(!t)return!1;let{size:r,data:s,indices:n}=t;U(e,0,0,0),U(J,0,0,0);let a=0,o=0;for(let l=0;l<n.length-2;l+=3){let i=n[l]*r,c=n[l+1]*r,u=n[l+2]*r;U(G,s[i],s[i+1],s[i+2]),U(me,s[c],s[c+1],s[c+2]),U(Rt,s[u],s[u+1],s[u+2]);let m=zs(G,me,Rt);m?(W(G,G,me),W(G,G,Rt),X(G,G,1/3*m),W(e,e,G),a+=m):(W(J,J,G),W(J,J,me),W(J,J,Rt),o+=3)}return(o!==0||a!==0)&&(a!==0?(X(e,e,1/a),!0):o!==0&&(X(e,J,1/o),!0))}function ks(t,e){if(!t)return!1;let{size:r,data:s,indices:n}=t;U(e,0,0,0);let a=-1,o=0;for(let l=0;l<n.length;l++){let i=n[l]*r;a!==i&&(e[0]+=s[i],e[1]+=s[i+1],e[2]+=s[i+2],o++),a=i}return o>1&&X(e,e,1/o),o>0}function js(t,e,r){if(!t)return!1;U(r,0,0,0),U(J,0,0,0);let s=0,n=0,{size:a,data:o,indices:l}=t,i=l.length-1,c=i+(e?2:0);for(let u=0;u<c;u+=2){let m=u<i?u+1:0,f=l[u<i?u:i]*a,h=l[m]*a;G[0]=o[f],G[1]=o[f+1],G[2]=o[f+2],me[0]=o[h],me[1]=o[h+1],me[2]=o[h+2],X(G,W(G,G,me),.5);let p=zr(G,me);p>0?(W(r,r,X(G,G,p)),s+=p):s===0&&(W(J,J,G),n++)}return s!==0?(X(r,r,1/s),!0):n!==0&&(X(r,J,1/n),!0)}var G=M(),me=M(),Rt=M(),J=M();var Et=class{constructor(e){this.channel=e,this.id=Pr()}};function qs(t,e){return t==null&&(t=[]),t.push(e),t}function Ws(t,e){if(t==null)return null;let r=t.filter(s=>s!==e);return r.length===0?null:r}var Co=M(),Po=new Float32Array(6);var Ye=class t extends xt{constructor(e,r,s=null,n=ce.Mesh,a=null,o=-1){super(),this.material=e,this.mapPositions=s,this.type=n,this.objectAndLayerIdColor=a,this.edgeIndicesLength=o,this.visible=!0,this._attributes=new Map,this._boundingInfo=null;for(let[l,i]of r)this._attributes.set(l,fe(j({},i),{indices:ts(i.indices)})),l===O.POSITION&&(this.edgeIndicesLength=this.edgeIndicesLength<0?this._attributes.get(l).indices.length:this.edgeIndicesLength)}instantiate(e={}){let r=new t(e.material||this.material,[],this.mapPositions,this.type,this.objectAndLayerIdColor,this.edgeIndicesLength);return this._attributes.forEach((s,n)=>{s.exclusive=!1,r._attributes.set(n,s)}),r._boundingInfo=this._boundingInfo,r.transformation=e.transformation||this.transformation,r}get attributes(){return this._attributes}getMutableAttribute(e){let r=this._attributes.get(e);return r&&!r.exclusive&&(r=fe(j({},r),{exclusive:!0,data:Us(r.data)}),this._attributes.set(e,r)),r}setAttributeData(e,r){let s=this._attributes.get(e);s&&this._attributes.set(e,fe(j({},s),{exclusive:!0,data:r}))}get indexCount(){return this._attributes.values().next().value.indices?.length??0}get faceCount(){return this.indexCount/3}get boundingInfo(){return this._boundingInfo==null&&(this._boundingInfo=this._calculateBoundingInfo()),this._boundingInfo}computeAttachmentOrigin(e){return!!(this.type===ce.Mesh?this._computeAttachmentOriginTriangles(e):this.type===ce.Line?this._computeAttachmentOriginLines(e):this._computeAttachmentOriginPoints(e))&&(this._transformation!=null&&ge(e,e,this._transformation),!0)}_computeAttachmentOriginTriangles(e){let r=this.attributes.get(O.POSITION);return Hs(r,e)}_computeAttachmentOriginLines(e){let r=this.attributes.get(O.POSITION);return js(r,Li(this.material.parameters,r),e)}_computeAttachmentOriginPoints(e){let r=this.attributes.get(O.POSITION);return ks(r,e)}invalidateBoundingInfo(){this._boundingInfo=null}_calculateBoundingInfo(){let e=this.attributes.get(O.POSITION);if(!e||e.indices.length===0)return null;let r=this.type===ce.Mesh?3:1;L(e.indices.length%r==0,"Indexing error: "+e.indices.length+" not divisible by "+r);let s=pt(e.indices.length/r);return new Mt(s,r,e)}get transformation(){return this._transformation??Qt}set transformation(e){this._transformation=e&&e!==Qt?is(e):null}addHighlight(){let e=new Et(_s.Highlight);return this.highlights=qs(this.highlights,e),e}removeHighlight(e){this.highlights=Ws(this.highlights,e)}};function Li(t,e){return!(!("isClosed"in t)||!t.isClosed)&&e.indices.length>2}function Ks(){return Xs??=k(this,null,function*(){let t=yield import("./chunk-OFIRVIA2.js"),e=yield t.default({locateFile:r=>Nr(`esri/libs/basisu/${r}`)});return e.initializeBasis(),e}),Xs}var Xs;var ye;(function(t){t[t.ETC1_RGB=0]="ETC1_RGB",t[t.ETC2_RGBA=1]="ETC2_RGBA",t[t.BC1_RGB=2]="BC1_RGB",t[t.BC3_RGBA=3]="BC3_RGBA",t[t.BC4_R=4]="BC4_R",t[t.BC5_RG=5]="BC5_RG",t[t.BC7_M6_RGB=6]="BC7_M6_RGB",t[t.BC7_M5_RGBA=7]="BC7_M5_RGBA",t[t.PVRTC1_4_RGB=8]="PVRTC1_4_RGB",t[t.PVRTC1_4_RGBA=9]="PVRTC1_4_RGBA",t[t.ASTC_4x4_RGBA=10]="ASTC_4x4_RGBA",t[t.ATC_RGB=11]="ATC_RGB",t[t.ATC_RGBA=12]="ATC_RGBA",t[t.FXT1_RGB=17]="FXT1_RGB",t[t.PVRTC2_4_RGB=18]="PVRTC2_4_RGB",t[t.PVRTC2_4_RGBA=19]="PVRTC2_4_RGBA",t[t.ETC2_EAC_R11=20]="ETC2_EAC_R11",t[t.ETC2_EAC_RG11=21]="ETC2_EAC_RG11",t[t.RGBA32=13]="RGBA32",t[t.RGB565=14]="RGB565",t[t.BGR565=15]="BGR565",t[t.RGBA4444=16]="RGBA4444"})(ye||(ye={}));var se=null,Ot=null;function Qs(){return k(this,null,function*(){return Ot==null&&(Ot=Ks(),se=yield Ot),Ot})}function $s(t,e){if(se==null)return t.byteLength;let r=new se.BasisFile(new Uint8Array(t)),s=Js(r)?Zs(r.getNumLevels(0),r.getHasAlpha(),r.getImageWidth(0,0),r.getImageHeight(0,0),e):0;return r.close(),r.delete(),s}function Ys(t,e){if(se==null)return t.byteLength;let r=new se.KTX2File(new Uint8Array(t)),s=ei(r)?Zs(r.getLevels(),r.getHasAlpha(),r.getWidth(),r.getHeight(),e):0;return r.close(),r.delete(),s}function Zs(t,e,r,s,n){let a=ls(e?te.COMPRESSED_RGBA8_ETC2_EAC:te.COMPRESSED_RGB8_ETC2),o=n&&t>1?(4**t-1)/(3*4**(t-1)):1;return Math.ceil(r*s*a*o)}function Js(t){return t.getNumImages()>=1&&!t.isUASTC()}function ei(t){return t.getFaces()>=1&&t.isETC1S()}function ti(t,e,r){return k(this,null,function*(){se==null&&(se=yield Qs());let s=new se.BasisFile(new Uint8Array(r));if(!Js(s))return null;s.startTranscoding();let n=si(t,e,s.getNumLevels(0),s.getHasAlpha(),s.getImageWidth(0,0),s.getImageHeight(0,0),(a,o)=>s.getImageTranscodedSizeInBytes(0,a,o),(a,o,l)=>s.transcodeImage(l,0,a,o,0,0));return s.close(),s.delete(),n})}function ri(t,e,r){return k(this,null,function*(){se==null&&(se=yield Qs());let s=new se.KTX2File(new Uint8Array(r));if(!ei(s))return null;s.startTranscoding();let n=si(t,e,s.getLevels(),s.getHasAlpha(),s.getWidth(),s.getHeight(),(a,o)=>s.getImageTranscodedSizeInBytes(a,0,0,o),(a,o,l)=>s.transcodeImage(l,a,0,0,o,0,-1,-1));return s.close(),s.delete(),n})}function si(t,e,r,s,n,a,o,l){let{compressedTextureETC:i,compressedTextureS3TC:c}=t.capabilities,[u,m]=i?s?[ye.ETC2_RGBA,te.COMPRESSED_RGBA8_ETC2_EAC]:[ye.ETC1_RGB,te.COMPRESSED_RGB8_ETC2]:c?s?[ye.BC3_RGBA,te.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[ye.BC1_RGB,te.COMPRESSED_RGB_S3TC_DXT1_EXT]:[ye.RGBA32,Te.RGBA],f=e.hasMipmap?r:Math.min(1,r),h=[];for(let p=0;p<f;p++)h.push(new Uint8Array(o(p,u))),l(p,u,h[p]);return e.internalFormat=m,e.hasMipmap=h.length>1,e.samplingMode=e.hasMipmap?le.LINEAR_MIPMAP_LINEAR:le.LINEAR,e.width=n,e.height=a,new _e(t,e,{type:"compressed",levels:h})}var vt=()=>ht.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil"),Vi=542327876,Fi=131072,Ui=4;function or(t){return t.charCodeAt(0)+(t.charCodeAt(1)<<8)+(t.charCodeAt(2)<<16)+(t.charCodeAt(3)<<24)}function Gi(t){return String.fromCharCode(255&t,t>>8&255,t>>16&255,t>>24&255)}var zi=or("DXT1"),Hi=or("DXT3"),ki=or("DXT5"),ji=31,qi=0,Wi=1,Xi=2,Ki=3,Qi=4,$i=7,Yi=20,Zi=21;function ii(t,e,r){let s=Ji(r,e.hasMipmap??!1);if(s==null)throw new Error("DDS texture data is null");let{textureData:n,internalFormat:a,width:o,height:l}=s;return e.samplingMode=n.levels.length>1?le.LINEAR_MIPMAP_LINEAR:le.LINEAR,e.hasMipmap=n.levels.length>1,e.internalFormat=a,e.width=o,e.height=l,new _e(t,e,n)}function Ji(t,e){let r=new Int32Array(t,0,ji);if(r[qi]!==Vi)return vt().error("Invalid magic number in DDS header"),null;if(!(r[Yi]&Ui))return vt().error("Unsupported format, must contain a FourCC code"),null;let s=r[Zi],n,a;switch(s){case zi:n=8,a=te.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case Hi:n=16,a=te.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case ki:n=16,a=te.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return vt().error("Unsupported FourCC code:",Gi(s)),null}let o=1,l=r[Qi],i=r[Ki];(3&l||3&i)&&(vt().warn("Rounding up compressed texture size to nearest multiple of 4."),l=l+3&-4,i=i+3&-4);let c=l,u=i,m,f;r[Xi]&Fi&&e!==!1&&(o=Math.max(1,r[$i]));let h=r[Wi]+4,p=[];for(let b=0;b<o;++b)f=(l+3>>2)*(i+3>>2)*n,m=new Uint8Array(t,h,f),p.push(m),h+=f,l=Math.max(1,l>>1),i=Math.max(1,i>>1);return{textureData:{type:"compressed",levels:p},internalFormat:a,width:c,height:u}}function ai(t,e){let a=t.width*t.height;if(a<4096)return t instanceof ImageData?ni(t):t;let o=t.width,l=t.height;do o=Math.ceil(o/2),l=Math.ceil(l/2),a=o*l;while(a>1048576||e!=null&&(o>e||l>e));return nr(t,o,l)}function oi(t,e){let r=Math.max(t.width,t.height);if(r<=e)return t;let s=e/r;return nr(t,Math.round(t.width*s),Math.round(t.height*s))}function nr(t,e,r){if(t instanceof ImageData)return nr(ni(t),e,r);let s=document.createElement("canvas");return s.width=e,s.height=r,s.getContext("2d").drawImage(t,0,0,s.width,s.height),s}function ni(t){let e=document.createElement("canvas");e.width=t.width,e.height=t.height;let r=e.getContext("2d");if(r==null)throw new ke("Failed to create 2d context from HTMLCanvasElement");return r.putImageData(t,0,0),e}var Ze=class extends xt{get parameters(){return this._parameters}constructor(e,r){super(),this._data=e,this.type=ce.Texture,this._glTexture=null,this._loadingPromise=null,this._loadingController=null,this.events=new Br,this._parameters=j(j({},ta),r),this._startPreload(e)}dispose(){this.unload(),this._data=this.frameUpdate=void 0}_startPreload(e){e!=null&&(e instanceof HTMLVideoElement?(this.frameUpdate=r=>this._frameUpdate(e,r),this._startPreloadVideoElement(e)):e instanceof HTMLImageElement&&this._startPreloadImageElement(e))}_startPreloadVideoElement(e){if(!(Ft(e.src)||e.preload==="auto"&&e.crossOrigin)){e.preload="auto",e.crossOrigin="anonymous";let r=!e.paused;if(e.src=e.src,r&&e.autoplay){let s=()=>{e.removeEventListener("canplay",s),e.play()};e.addEventListener("canplay",s)}}}_startPreloadImageElement(e){wr(e.src)||Ft(e.src)||e.crossOrigin||(e.crossOrigin="anonymous",e.src=e.src)}_createDescriptor(e){let r=new us;return r.wrapMode=this._parameters.wrap??we.REPEAT,r.flipped=!this._parameters.noUnpackFlip,r.samplingMode=this._parameters.mipmap?le.LINEAR_MIPMAP_LINEAR:le.LINEAR,r.hasMipmap=!!this._parameters.mipmap,r.preMultiplyAlpha=!!this._parameters.preMultiplyAlpha,r.maxAnisotropy=this._parameters.maxAnisotropy??(this._parameters.mipmap?e.parameters.maxMaxAnisotropy:1),r}get glTexture(){return this._glTexture}get memoryEstimate(){return this._glTexture?.usedMemory||ea(this._data,this._parameters)}load(e){if(this._glTexture)return this._glTexture;if(this._loadingPromise)return this._loadingPromise;let r=this._data;return r==null?(this._glTexture=new _e(e,this._createDescriptor(e),null),this._glTexture):(this._parameters.reloadable||(this._data=void 0),typeof r=="string"?this._loadFromURL(e,r):r instanceof Image?this._loadFromImageElement(e,r):r instanceof HTMLVideoElement?this._loadFromVideoElement(e,r):r instanceof ImageData||r instanceof HTMLCanvasElement?this._loadFromImage(e,r):(ze(r)||He(r))&&this._parameters.encoding===Ke.DDS_ENCODING?this._loadFromDDSData(e,r):(ze(r)||He(r))&&this._parameters.encoding===Ke.KTX2_ENCODING?this._loadFromKTX2(e,r):(ze(r)||He(r))&&this._parameters.encoding===Ke.BASIS_ENCODING?this._loadFromBasis(e,r):He(r)?this._loadFromPixelData(e,r):ze(r)?this._loadFromPixelData(e,new Uint8Array(r)):null)}_frameUpdate(e,r){return this._glTexture==null||e.readyState<lt.HAVE_CURRENT_DATA||r===e.currentTime?r:(this._glTexture.setData(e),this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this._parameters.updateCallback&&this._parameters.updateCallback(),e.currentTime)}_loadFromDDSData(e,r){return this._glTexture=ii(e,this._createDescriptor(e),r),this._glTexture}_loadFromKTX2(e,r){return this._loadAsync(()=>ri(e,this._createDescriptor(e),r).then(s=>(this._glTexture=s,s)))}_loadFromBasis(e,r){return this._loadAsync(()=>ti(e,this._createDescriptor(e),r).then(s=>(this._glTexture=s,s)))}_loadFromPixelData(e,r){L(this._parameters.width>0&&this._parameters.height>0);let s=this._createDescriptor(e);return s.pixelFormat=this._parameters.components===1?Te.LUMINANCE:this._parameters.components===3?Te.RGB:Te.RGBA,s.width=this._parameters.width??0,s.height=this._parameters.height??0,this._glTexture=new _e(e,s,r),this._glTexture}_loadFromURL(e,r){return this._loadAsync(s=>k(this,null,function*(){let n=yield At(r,{signal:s});return Lt(s),this._loadFromImage(e,n)}))}_loadFromImageElement(e,r){return r.complete?this._loadFromImage(e,r):this._loadAsync(s=>k(this,null,function*(){let n=yield Dr(r,r.src,!1,s);return Lt(s),this._loadFromImage(e,n)}))}_loadFromVideoElement(e,r){return r.readyState>=lt.HAVE_CURRENT_DATA?this._loadFromImage(e,r):this._loadFromVideoElementAsync(e,r)}_loadFromVideoElementAsync(e,r){return this._loadAsync(s=>new Promise((n,a)=>{let o=()=>{r.removeEventListener("loadeddata",l),r.removeEventListener("error",i),vr(c)},l=()=>{r.readyState>=lt.HAVE_CURRENT_DATA&&(o(),n(this._loadFromImage(e,r)))},i=u=>{o(),a(u||new ke("Failed to load video"))};r.addEventListener("loadeddata",l),r.addEventListener("error",i);let c=Cr(s,()=>i(Ir()))}))}_loadFromImage(e,r){let s=r;if(!(s instanceof HTMLVideoElement)){let{maxTextureSize:o}=e.parameters;s=this._parameters.downsampleUncompressed?ai(s,o):oi(s,o)}let n=li(s);this._parameters.width=n.width,this._parameters.height=n.height;let a=this._createDescriptor(e);return a.pixelFormat=this._parameters.components===3?Te.RGB:Te.RGBA,a.width=n.width,a.height=n.height,this._glTexture=new _e(e,a,s),this._glTexture}_loadAsync(e){let r=new AbortController;this._loadingController=r;let s=e(r.signal);this._loadingPromise=s;let n=()=>{this._loadingController===r&&(this._loadingController=null),this._loadingPromise===s&&(this._loadingPromise=null)};return s.then(n,n),s}unload(){if(this._glTexture=Or(this._glTexture),this._loadingController!=null){let e=this._loadingController;this._loadingController=null,this._loadingPromise=null,e.abort()}this.events.emit("unloaded")}};function ea(t,e){if(t==null)return 0;if(ze(t)||He(t))return e.encoding===Ke.KTX2_ENCODING?Ys(t,!!e.mipmap):e.encoding===Ke.BASIS_ENCODING?$s(t,!!e.mipmap):t.byteLength;let{width:r,height:s}=t instanceof Image||t instanceof ImageData||t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement?li(t):e;return(e.mipmap?4/3:1)*r*s*(e.components||4)||0}function li(t){return t instanceof HTMLVideoElement?{width:t.videoWidth,height:t.videoHeight}:t}var lt;(function(t){t[t.HAVE_NOTHING=0]="HAVE_NOTHING",t[t.HAVE_METADATA=1]="HAVE_METADATA",t[t.HAVE_CURRENT_DATA=2]="HAVE_CURRENT_DATA",t[t.HAVE_FUTURE_DATA=3]="HAVE_FUTURE_DATA",t[t.HAVE_ENOUGH_DATA=4]="HAVE_ENOUGH_DATA"})(lt||(lt={}));var ta={wrap:{s:we.REPEAT,t:we.REPEAT},mipmap:!0,noUnpackFlip:!1,preMultiplyAlpha:!1,downsampleUncompressed:!1};var ui=rr(ne.SRC_ALPHA,ne.ONE,ne.ONE_MINUS_SRC_ALPHA,ne.ONE_MINUS_SRC_ALPHA),ra=rr(ne.ONE,ne.ZERO,ne.ONE,ne.ONE_MINUS_SRC_ALPHA);function ci(t){return t===re.FrontFace?null:ra}var mi=5e5,sa={factor:-1,units:-2};function hi(t){return t?sa:null}function fi(t,e=K.LESS){return t===re.NONE||t===re.FrontFace?e:K.LEQUAL}function pi(t){return t===re.ColorAlpha?{buffers:[Wt.COLOR_ATTACHMENT0,Wt.COLOR_ATTACHMENT1]}:null}var lr=class{constructor(e=!1,r=!0){this.isVerticalRay=e,this.normalRequired=r}},St=Hr();function di(t,e,r,s,n,a){if(!t.visible)return;let o=Pe(Ta,s,r),l=(c,u,m)=>{a(c,m,u,!1)},i=new lr(!1,e.options.normalRequired);if(t.boundingInfo){L(t.type===ce.Mesh);let c=e.tolerance;gi(t.boundingInfo,r,o,c,n,i,l)}else{let c=t.attributes.get(O.POSITION),u=c.indices;oa(r,o,0,u.length/3,u,c.data,c.stride,n,i,l)}}var ia=M();function gi(t,e,r,s,n,a,o){if(t==null)return;let l=ha(r,ia);if(kr(St,t.bbMin),jr(St,t.bbMax),n?.applyToAabb(St),fa(St,e,l,s)){let{primitiveIndices:i,position:c}=t,u=i?i.length:c.indices.length/3;if(u>da){let m=t.getChildren();if(m!==void 0){for(let f of m)gi(f,e,r,s,n,a,o);return}}aa(e,r,0,u,c.indices,c.data,c.stride,i,n,a,o)}}var ut=M();function aa(t,e,r,s,n,a,o,l,i,c,u){let m=t[0],f=t[1],h=t[2],p=e[0],b=e[1],d=e[2],{normalRequired:D}=c;for(let I=r;I<s;++I){let w=l[I],B=3*w,V=o*n[B],P=a[V],y=a[V+1],E=a[V+2],v=o*n[B+1],R=a[v],A=a[v+1],S=a[v+2],g=o*n[B+2],C=a[g],N=a[g+1],F=a[g+2];i!=null&&([P,y,E]=i.applyToVertex(P,y,E,I),[R,A,S]=i.applyToVertex(R,A,S,I),[C,N,F]=i.applyToVertex(C,N,F,I));let z=R-P,Me=A-y,Re=S-E,Ee=C-P,Oe=N-y,ae=F-E,ve=b*ae-Oe*d,Se=d*Ee-ae*p,Fe=p*Oe-Ee*b,ee=z*ve+Me*Se+Re*Fe;if(Math.abs(ee)<=ga)continue;let Ue=m-P,Bt=f-y,Nt=h-E,Ge=Ue*ve+Bt*Se+Nt*Fe;if(ee>0){if(Ge<0||Ge>ee)continue}else if(Ge>0||Ge<ee)continue;let Tr=Bt*Re-Me*Nt,_r=Nt*z-Re*Ue,Ar=Ue*Me-z*Bt,mt=p*Tr+b*_r+d*Ar;if(ee>0){if(mt<0||Ge+mt>ee)continue}else if(mt>0||Ge+mt<ee)continue;let xr=(Ee*Tr+Oe*_r+ae*Ar)/ee;xr>=0&&u(xr,w,D?ca(z,Me,Re,Ee,Oe,ae,ut):null)}}function oa(t,e,r,s,n,a,o,l,i,c){let u=e,m=_a,f=Math.abs(u[0]),h=Math.abs(u[1]),p=Math.abs(u[2]),b=f>=h?f>=p?0:2:h>=p?1:2,d=b,D=u[d]<0?2:1,I=(b+D)%3,w=(b+(3-D))%3,B=u[I]/u[d],V=u[w]/u[d],P=1/u[d],y=na,E=la,v=ua,{normalRequired:R}=i;for(let A=r;A<s;++A){let S=3*A,g=o*n[S];U(m[0],a[g+0],a[g+1],a[g+2]);let C=o*n[S+1];U(m[1],a[C+0],a[C+1],a[C+2]);let N=o*n[S+2];U(m[2],a[N+0],a[N+1],a[N+2]),l&&(Ie(m[0],l.applyToVertex(m[0][0],m[0][1],m[0][2],A)),Ie(m[1],l.applyToVertex(m[1][0],m[1][1],m[1][2],A)),Ie(m[2],l.applyToVertex(m[2][0],m[2][1],m[2][2],A))),Pe(y,m[0],t),Pe(E,m[1],t),Pe(v,m[2],t);let F=y[I]-B*y[d],z=y[w]-V*y[d],Me=E[I]-B*E[d],Re=E[w]-V*E[d],Ee=v[I]-B*v[d],Oe=v[w]-V*v[d],ae=Ee*Re-Oe*Me,ve=F*Oe-z*Ee,Se=Me*z-Re*F;if((ae<0||ve<0||Se<0)&&(ae>0||ve>0||Se>0))continue;let Fe=ae+ve+Se;if(Fe===0)continue;let ee=ae*(P*y[d])+ve*(P*E[d])+Se*(P*v[d]);if(ee*Math.sign(Fe)<0)continue;let Ue=ee/Fe;Ue>=0&&c(Ue,A,R?ma(m):null)}}var na=M(),la=M(),ua=M();function ca(t,e,r,s,n,a,o){return U(It,t,e,r),U(Ct,s,n,a),st(o,It,Ct),Ce(o,o),o}function ma(t){return Pe(It,t[1],t[0]),Pe(Ct,t[2],t[0]),st(ut,It,Ct),Ce(ut,ut),ut}var It=M(),Ct=M();function ha(t,e){return U(e,1/t[0],1/t[1],1/t[2])}function fa(t,e,r,s){return pa(t,e,r,s,1/0)}function pa(t,e,r,s,n){let a=(t[0]-s-e[0])*r[0],o=(t[3]+s-e[0])*r[0],l=Math.min(a,o),i=Math.max(a,o),c=(t[1]-s-e[1])*r[1],u=(t[4]+s-e[1])*r[1];if(i=Math.min(i,Math.max(c,u)),i<0||(l=Math.max(l,Math.min(c,u)),l>i))return!1;let m=(t[2]-s-e[2])*r[2],f=(t[5]+s-e[2])*r[2];return i=Math.min(i,Math.max(m,f)),!(i<0)&&(l=Math.max(l,Math.min(m,f)),!(l>i)&&l<n)}var da=1e3,ga=1e-7,Ta=M(),_a=[M(),M(),M()];var Je;(function(t){t[t.INTEGRATED_MESH=0]="INTEGRATED_MESH",t[t.OPAQUE_TERRAIN=1]="OPAQUE_TERRAIN",t[t.OPAQUE_MATERIAL=2]="OPAQUE_MATERIAL",t[t.OPAQUE_NO_SSAO_DEPTH=3]="OPAQUE_NO_SSAO_DEPTH",t[t.TRANSPARENT_MATERIAL=4]="TRANSPARENT_MATERIAL",t[t.TRANSPARENT_NO_SSAO_DEPTH=5]="TRANSPARENT_NO_SSAO_DEPTH",t[t.TRANSPARENT_TERRAIN=6]="TRANSPARENT_TERRAIN",t[t.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL=7]="TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL",t[t.OCCLUDED_TERRAIN=8]="OCCLUDED_TERRAIN",t[t.OCCLUDER_MATERIAL=9]="OCCLUDER_MATERIAL",t[t.TRANSPARENT_OCCLUDER_MATERIAL=10]="TRANSPARENT_OCCLUDER_MATERIAL",t[t.OCCLUSION_PIXELS=11]="OCCLUSION_PIXELS",t[t.OPAQUE_ENVIRONMENT=12]="OPAQUE_ENVIRONMENT",t[t.TRANSPARENT_ENVIRONMENT=13]="TRANSPARENT_ENVIRONMENT",t[t.LASERLINES=14]="LASERLINES",t[t.LASERLINES_CONTRAST_CONTROL=15]="LASERLINES_CONTRAST_CONTROL",t[t.HUD_MATERIAL=16]="HUD_MATERIAL",t[t.LABEL_MATERIAL=17]="LABEL_MATERIAL",t[t.LINE_CALLOUTS=18]="LINE_CALLOUTS",t[t.LINE_CALLOUTS_HUD_DEPTH=19]="LINE_CALLOUTS_HUD_DEPTH",t[t.DRAPED_MATERIAL=20]="DRAPED_MATERIAL",t[t.DRAPED_WATER=21]="DRAPED_WATER",t[t.VIEWSHED=22]="VIEWSHED",t[t.VOXEL=23]="VOXEL",t[t.MAX_SLOTS=24]="MAX_SLOTS"})(Je||(Je={}));var ur=class{constructor(e=0){this.offset=e,this.tmpVertex=M()}applyToVertex(e,r,s){let n=U(hr,e,r,s),a=W(Ai,n,this.localOrigin),o=this.offset/q(a);return de(this.tmpVertex,n,a,o),this.tmpVertex}applyToAabb(e){let r=Aa,s=xa,n=ya;for(let i=0;i<3;++i)r[i]=e[0+i]+this.localOrigin[i],s[i]=e[3+i]+this.localOrigin[i],n[i]=r[i];let a=this.applyToVertex(r[0],r[1],r[2]);for(let i=0;i<3;++i)e[i]=a[i],e[i+3]=a[i];let o=i=>{let c=this.applyToVertex(i[0],i[1],i[2]);for(let u=0;u<3;++u)e[u]=Math.min(e[u],c[u]),e[u+3]=Math.max(e[u+3],c[u])};for(let i=1;i<8;++i){for(let c=0;c<3;++c)n[c]=i&1<<c?s[c]:r[c];o(n)}let l=0;for(let i=0;i<3;++i)r[i]*s[i]<0&&(l|=1<<i);if(l!==0&&l!==7){for(let i=0;i<8;++i)if(!(l&i)){for(let c=0;c<3;++c)n[c]=l&1<<c?0:i&1<<c?r[c]:s[c];o(n)}}for(let i=0;i<3;++i)e[i]-=this.localOrigin[i],e[i+3]-=this.localOrigin[i];return e}},cr=class{constructor(e=0){this.componentLocalOriginLength=0,this._totalOffset=0,this._offset=0,this._tmpVertex=M(),this._tmpMbs=tr(),this._tmpObb=new ys,this._resetOffset(e)}_resetOffset(e){this._offset=e,this._totalOffset=e}set offset(e){this._resetOffset(e)}get offset(){return this._offset}set componentOffset(e){this._totalOffset=this._offset+e}set localOrigin(e){this.componentLocalOriginLength=q(e)}applyToVertex(e,r,s){let n=U(hr,e,r,s),a=U(Ai,e,r,s+this.componentLocalOriginLength),o=this._totalOffset/q(a);return de(this._tmpVertex,n,a,o),this._tmpVertex}applyToAabb(e){let r=this.componentLocalOriginLength,s=e[0],n=e[1],a=e[2]+r,o=e[3],l=e[4],i=e[5]+r,c=Math.abs(s),u=Math.abs(n),m=Math.abs(a),f=Math.abs(o),h=Math.abs(l),p=Math.abs(i),b=.5*(1+Math.sign(s*o))*Math.min(c,f),d=.5*(1+Math.sign(n*l))*Math.min(u,h),D=.5*(1+Math.sign(a*i))*Math.min(m,p),I=Math.max(c,f),w=Math.max(u,h),B=Math.max(m,p),V=Math.sqrt(b*b+d*d+D*D),P=Math.sign(c+s),y=Math.sign(u+n),E=Math.sign(m+a),v=Math.sign(f+o),R=Math.sign(h+l),A=Math.sign(p+i),S=this._totalOffset;if(V<S)return e[0]-=(1-P)*S,e[1]-=(1-y)*S,e[2]-=(1-E)*S,e[3]+=v*S,e[4]+=R*S,e[5]+=A*S,e;let g=S/Math.sqrt(I*I+w*w+B*B),C=S/V,N=C-g,F=-N;return e[0]+=s*(P*F+C),e[1]+=n*(y*F+C),e[2]+=a*(E*F+C),e[3]+=o*(v*N+g),e[4]+=l*(R*N+g),e[5]+=i*(A*N+g),e}applyToMbs(e){let r=q(e),s=this._totalOffset/r;return de(this._tmpMbs,e,e,s),this._tmpMbs[3]=e[3]+e[3]*this._totalOffset/r,this._tmpMbs}applyToObb(e){return bs(e,this._totalOffset,this._totalOffset,De.Global,this._tmpObb),this._tmpObb}},mr=class{constructor(e=0){this.offset=e,this.sphere=tr(),this.tmpVertex=M()}applyToVertex(e,r,s){let n=this.objectTransform.transform,a=U(hr,e,r,s),o=ge(a,a,n),l=this.offset/q(o);de(o,o,o,l);let i=this.objectTransform.inverse;return ge(this.tmpVertex,o,i),this.tmpVertex}applyToMinMax(e,r){let s=this.offset/q(e);de(e,e,e,s);let n=this.offset/q(r);de(r,r,r,n)}applyToAabb(e){let r=this.offset/Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);e[0]+=e[0]*r,e[1]+=e[1]*r,e[2]+=e[2]*r;let s=this.offset/Math.sqrt(e[3]*e[3]+e[4]*e[4]+e[5]*e[5]);return e[3]+=e[3]*s,e[4]+=e[4]*s,e[5]+=e[5]*s,e}applyToBoundingSphere(e){let r=q(e),s=this.offset/r;return de(this.sphere,e,e,s),this.sphere[3]=e[3]+e[3]*this.offset/r,this.sphere}},Ti=new mr;function _i(t){return t!=null?(Ti.offset=t,Ti):null}var al=new cr;var ol=new ur;var hr=M(),Ai=M(),Aa=M(),xa=M(),ya=M();function xi(t,e,r){let{data:s,indices:n}=t,a=e.typedBuffer,o=e.typedBufferStride,l=n.length;r*=o;for(let i=0;i<l;++i){let c=2*n[i];a[r]=s[c],a[r+1]=s[c+1],r+=o}}function yi(t,e,r,s){let{data:n,indices:a}=t,o=e.typedBuffer,l=e.typedBufferStride,i=a.length;if(r*=l,s==null||s===1)for(let c=0;c<i;++c){let u=3*a[c];o[r]=n[u],o[r+1]=n[u+1],o[r+2]=n[u+2],r+=l}else for(let c=0;c<i;++c){let u=3*a[c];for(let m=0;m<s;++m)o[r]=n[u],o[r+1]=n[u+1],o[r+2]=n[u+2],r+=l}}function bi(t,e,r,s=1){let{data:n,indices:a}=t,o=e.typedBuffer,l=e.typedBufferStride,i=a.length;if(r*=l,s===1)for(let c=0;c<i;++c){let u=4*a[c];o[r]=n[u],o[r+1]=n[u+1],o[r+2]=n[u+2],o[r+3]=n[u+3],r+=l}else for(let c=0;c<i;++c){let u=4*a[c];for(let m=0;m<s;++m)o[r]=n[u],o[r+1]=n[u+1],o[r+2]=n[u+2],o[r+3]=n[u+3],r+=l}}function ba(t,e,r,s,n=1){if(!e)return void yi(t,r,s,n);let{data:a,indices:o}=t,l=r.typedBuffer,i=r.typedBufferStride,c=o.length,u=e[0],m=e[1],f=e[2],h=e[4],p=e[5],b=e[6],d=e[8],D=e[9],I=e[10],w=e[12],B=e[13],V=e[14];s*=i;let P=0,y=0,E=0,v=qt(e)?R=>{P=a[R]+w,y=a[R+1]+B,E=a[R+2]+V}:R=>{let A=a[R],S=a[R+1],g=a[R+2];P=u*A+h*S+d*g+w,y=m*A+p*S+D*g+B,E=f*A+b*S+I*g+V};if(n===1)for(let R=0;R<c;++R)v(3*o[R]),l[s]=P,l[s+1]=y,l[s+2]=E,s+=i;else for(let R=0;R<c;++R){v(3*o[R]);for(let A=0;A<n;++A)l[s]=P,l[s+1]=y,l[s+2]=E,s+=i}}function Ma(t,e,r,s,n=1){if(!e)return void yi(t,r,s,n);let{data:a,indices:o}=t,l=e,i=r.typedBuffer,c=r.typedBufferStride,u=o.length,m=l[0],f=l[1],h=l[2],p=l[4],b=l[5],d=l[6],D=l[8],I=l[9],w=l[10],B=!jt(l),V=1e-6,P=1-V;s*=c;let y=0,E=0,v=0,R=qt(l)?A=>{y=a[A],E=a[A+1],v=a[A+2]}:A=>{let S=a[A],g=a[A+1],C=a[A+2];y=m*S+p*g+D*C,E=f*S+b*g+I*C,v=h*S+d*g+w*C};if(n===1)if(B)for(let A=0;A<u;++A){R(3*o[A]);let S=y*y+E*E+v*v;if(S<P&&S>V){let g=1/Math.sqrt(S);i[s]=y*g,i[s+1]=E*g,i[s+2]=v*g}else i[s]=y,i[s+1]=E,i[s+2]=v;s+=c}else for(let A=0;A<u;++A)R(3*o[A]),i[s]=y,i[s+1]=E,i[s+2]=v,s+=c;else for(let A=0;A<u;++A){if(R(3*o[A]),B){let S=y*y+E*E+v*v;if(S<P&&S>V){let g=1/Math.sqrt(S);y*=g,E*=g,v*=g}}for(let S=0;S<n;++S)i[s]=y,i[s+1]=E,i[s+2]=v,s+=c}}function Ra(t,e,r,s,n=1){if(!e)return void bi(t,r,s,n);let{data:a,indices:o}=t,l=e,i=r.typedBuffer,c=r.typedBufferStride,u=o.length,m=l[0],f=l[1],h=l[2],p=l[4],b=l[5],d=l[6],D=l[8],I=l[9],w=l[10],B=!jt(l),V=1e-6,P=1-V;if(s*=c,n===1)for(let y=0;y<u;++y){let E=4*o[y],v=a[E],R=a[E+1],A=a[E+2],S=a[E+3],g=m*v+p*R+D*A,C=f*v+b*R+I*A,N=h*v+d*R+w*A;if(B){let F=g*g+C*C+N*N;if(F<P&&F>V){let z=1/Math.sqrt(F);g*=z,C*=z,N*=z}}i[s]=g,i[s+1]=C,i[s+2]=N,i[s+3]=S,s+=c}else for(let y=0;y<u;++y){let E=4*o[y],v=a[E],R=a[E+1],A=a[E+2],S=a[E+3],g=m*v+p*R+D*A,C=f*v+b*R+I*A,N=h*v+d*R+w*A;if(B){let F=g*g+C*C+N*N;if(F<P&&F>V){let z=1/Math.sqrt(F);g*=z,C*=z,N*=z}}for(let F=0;F<n;++F)i[s]=g,i[s+1]=C,i[s+2]=N,i[s+3]=S,s+=c}}function Ea(t,e,r,s,n=1){let{data:a,indices:o}=t,l=r.typedBuffer,i=r.typedBufferStride,c=o.length;if(s*=i,e!==a.length||e!==4)if(n!==1)if(e!==4)for(let u=0;u<c;++u){let m=3*o[u];for(let f=0;f<n;++f)l[s]=a[m],l[s+1]=a[m+1],l[s+2]=a[m+2],l[s+3]=255,s+=i}else for(let u=0;u<c;++u){let m=4*o[u];for(let f=0;f<n;++f)l[s]=a[m],l[s+1]=a[m+1],l[s+2]=a[m+2],l[s+3]=a[m+3],s+=i}else{if(e===4){for(let u=0;u<c;++u){let m=4*o[u];l[s]=a[m],l[s+1]=a[m+1],l[s+2]=a[m+2],l[s+3]=a[m+3],s+=i}return}for(let u=0;u<c;++u){let m=3*o[u];l[s]=a[m],l[s+1]=a[m+1],l[s+2]=a[m+2],l[s+3]=255,s+=i}}else{l[s]=a[0],l[s+1]=a[1],l[s+2]=a[2],l[s+3]=a[3];let u=new Uint32Array(r.typedBuffer.buffer,r.start),m=i/4,f=u[s/=4];s+=m;let h=c*n;for(let p=1;p<h;++p)u[s]=f,s+=m}}function Oa(t,e,r){let{data:s,indices:n}=t,a=e.typedBuffer,o=e.typedBufferStride,l=n.length,i=s[0];r*=o;for(let c=0;c<l;++c)a[r]=i,r+=o}function va(t,e,r,s,n=1){let a=e.typedBuffer,o=e.typedBufferStride;if(s*=o,n===1)for(let l=0;l<r;++l)a[s]=t[0],a[s+1]=t[1],a[s+2]=t[2],a[s+3]=t[3],s+=o;else for(let l=0;l<r;++l)for(let i=0;i<n;++i)a[s]=t[0],a[s+1]=t[1],a[s+2]=t[2],a[s+3]=t[3],s+=o}function Mi(t,e,r,s,n,a){for(let o of e.fields.keys()){let l=t.attributes.get(o),i=l?.indices;if(l&&i)Sa(o,l,r,s,n,a);else if(o===O.OBJECTANDLAYERIDCOLOR&&t.objectAndLayerIdColor!=null){let c=t.attributes.get(O.POSITION)?.indices;if(c){let u=c.length,m=n.getField(o,Xe);va(t.objectAndLayerIdColor,m,u,a)}}}}function Sa(t,e,r,s,n,a){switch(t){case O.POSITION:{L(e.size===3);let o=n.getField(t,We);L(!!o,`No buffer view for ${t}`),o&&ba(e,r,o,a);break}case O.NORMAL:{L(e.size===3);let o=n.getField(t,We);L(!!o,`No buffer view for ${t}`),o&&Ma(e,s,o,a);break}case O.NORMALCOMPRESSED:{L(e.size===2);let o=n.getField(t,Yr);L(!!o,`No buffer view for ${t}`),o&&xi(e,o,a);break}case O.UV0:{L(e.size===2);let o=n.getField(t,Xr);L(!!o,`No buffer view for ${t}`),o&&xi(e,o,a);break}case O.COLOR:case O.SYMBOLCOLOR:{let o=n.getField(t,Xe);L(!!o,`No buffer view for ${t}`),L(e.size===3||e.size===4),!o||e.size!==3&&e.size!==4||Ea(e,e.size,o,a);break}case O.COLORFEATUREATTRIBUTE:{let o=n.getField(t,Wr);L(!!o,`No buffer view for ${t}`),L(e.size===1),o&&e.size===1&&Oa(e,o,a);break}case O.TANGENT:{L(e.size===4);let o=n.getField(t,at);L(!!o,`No buffer view for ${t}`),o&&Ra(e,r,o,a);break}case O.PROFILERIGHT:case O.PROFILEUP:case O.PROFILEVERTEXANDNORMAL:case O.FEATUREVALUE:{L(e.size===4);let o=n.getField(t,at);L(!!o,`No buffer view for ${t}`),o&&bi(e,o,a)}}}var Pt=class{constructor(e){this.vertexBufferLayout=e}elementCount(e){return e.attributes.get(O.POSITION).indices.length}write(e,r,s,n,a){Mi(s,this.vertexBufferLayout,e,r,n,a)}};var _l={func:K.LESS},Al={func:K.ALWAYS},Ri={mask:255};var Ei={function:{func:K.ALWAYS,ref:ue.OutlineVisualElementMask,mask:ue.OutlineVisualElementMask},operation:{fail:Q.KEEP,zFail:Q.KEEP,zPass:Q.ZERO}},Oi={function:{func:K.ALWAYS,ref:ue.OutlineVisualElementMask,mask:ue.OutlineVisualElementMask},operation:{fail:Q.KEEP,zFail:Q.KEEP,zPass:Q.REPLACE}},xl={function:{func:K.EQUAL,ref:ue.OutlineVisualElementMask,mask:ue.OutlineVisualElementMask},operation:{fail:Q.KEEP,zFail:Q.KEEP,zPass:Q.KEEP}},yl={function:{func:K.NOTEQUAL,ref:ue.OutlineVisualElementMask,mask:ue.OutlineVisualElementMask},operation:{fail:Q.KEEP,zFail:Q.KEEP,zPass:Q.KEEP}};function vi({normalTexture:t,metallicRoughnessTexture:e,metallicFactor:r,roughnessFactor:s,emissiveTexture:n,emissiveFactor:a,occlusionTexture:o}){return t==null&&e==null&&n==null&&(a==null||Gr(a,Vr))&&o==null&&(s==null||s===1)&&(r==null||r===1)}var wt=[1,1,.5],Si=[0,.6,.2],Ii=[0,1,.2];var Dt=class extends Ds{constructor(){super(...arguments),this.isSchematic=!1,this.usePBR=!1,this.mrrFactors=rt(wt),this.hasVertexColors=!1,this.hasSymbolColors=!1,this.doubleSided=!1,this.doubleSidedType="normal",this.cullFace=$.Back,this.isInstanced=!1,this.hasInstancedColor=!1,this.emissiveFactor=pe(0,0,0),this.instancedDoublePrecision=!1,this.normalType=Z.Attribute,this.receiveShadows=!0,this.receiveAmbientOcclusion=!0,this.castShadows=!0,this.shadowMappingEnabled=!1,this.ambient=pe(.2,.2,.2),this.diffuse=pe(.8,.8,.8),this.externalColor=qr(1,1,1,1),this.colorMixMode="multiply",this.opacity=1,this.layerOpacity=1,this.origin=M(),this.hasSlicePlane=!1,this.hasSliceHighlight=!0,this.offsetTransparentBackfaces=!1,this.vvSize=null,this.vvColor=null,this.vvOpacity=null,this.vvSymbolAnchor=null,this.vvSymbolRotationMatrix=null,this.modelTransformation=null,this.transparent=!1,this.writeDepth=!0,this.customDepthTest=Ae.Less,this.textureAlphaMode=H.Blend,this.textureAlphaCutoff=.1,this.textureAlphaPremultiplied=!1,this.hasOccludees=!1,this.renderOccluded=Is.Occlude,this.isDecoration=!1}};var Le=class t extends Bs{initializeConfiguration(e,r){r.spherical=e.viewingMode===De.Global,r.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result,r.textureCoordinateType=r.hasColorTexture||r.hasMetallicRoughnessTexture||r.hasEmissionTexture||r.hasOcclusionTexture||r.hasNormalTexture?Qe.Default:Qe.None,r.objectAndLayerIdColorInstanced=r.instanced}initializeProgram(e){return this._initializeProgram(e,t.shader)}_initializeProgram(e,r){return new Ns(e.rctx,r.get().build(this.configuration),Os)}_makePipeline(e,r){let s=this.configuration,n=e===re.NONE,a=e===re.FrontFace;return ws({blending:s.output===Y.Color&&s.transparent?n?ui:ci(e):null,culling:Pa(s)?Cs(s.cullFace):null,depthTest:{func:fi(e,Ca(s.customDepthTest))},depthWrite:(n||a)&&s.writeDepth?sr:null,drawBuffers:s.output===Y.Depth?{buffers:[es.NONE]}:pi(e),colorWrite:Ps,stencilWrite:s.hasOccludees?Ri:null,stencilTest:s.hasOccludees?r?Oi:Ei:null,polygonOffset:n||a?null:hi(s.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._makePipeline(this.configuration.transparencyPassType,!0),this._makePipeline(this.configuration.transparencyPassType,!1)}getPipeline(e){return e?this._occludeePipelineState:super.getPipeline()}};function Ca(t){return t===Ae.Lequal?K.LEQUAL:K.LESS}function Pa(t){return t.cullFace!==$.None||!t.hasSlicePlane&&!t.transparent&&!t.doubleSidedMode}Le.shader=new yt(Vs,()=>import("./chunk-S7NZLAWL.js"));var Ve=class extends Ls{};T([_({constValue:!0})],Ve.prototype,"hasSliceHighlight",void 0),T([_({constValue:!1})],Ve.prototype,"hasSliceInVertexProgram",void 0),T([_({constValue:hs.Pass})],Ve.prototype,"pbrTextureBindType",void 0);var x=class extends Ve{constructor(){super(...arguments),this.output=Y.Color,this.alphaDiscardMode=H.Opaque,this.doubleSidedMode=ie.None,this.pbrMode=Be.Disabled,this.cullFace=$.None,this.transparencyPassType=re.NONE,this.normalType=Z.Attribute,this.textureCoordinateType=Qe.None,this.customDepthTest=Ae.Less,this.spherical=!1,this.hasVertexColors=!1,this.hasSymbolColors=!1,this.hasVerticalOffset=!1,this.hasSlicePlane=!1,this.hasSliceHighlight=!0,this.hasColorTexture=!1,this.hasMetallicRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.hasScreenSizePerspective=!1,this.hasVertexTangents=!1,this.hasOccludees=!1,this.multipassEnabled=!1,this.hasModelTransformation=!1,this.offsetBackfaces=!1,this.vvSize=!1,this.vvColor=!1,this.receiveShadows=!1,this.receiveAmbientOcclusion=!1,this.textureAlphaPremultiplied=!1,this.instanced=!1,this.instancedColor=!1,this.objectAndLayerIdColorInstanced=!1,this.instancedDoublePrecision=!1,this.doublePrecisionRequiresObfuscation=!1,this.writeDepth=!0,this.transparent=!1,this.enableOffset=!0,this.cullAboveGround=!1,this.snowCover=!1,this.hasColorTextureTransform=!1,this.hasEmissionTextureTransform=!1,this.hasNormalTextureTransform=!1,this.hasOcclusionTextureTransform=!1,this.hasMetallicRoughnessTextureTransform=!1}};T([_({count:Y.COUNT})],x.prototype,"output",void 0),T([_({count:H.COUNT})],x.prototype,"alphaDiscardMode",void 0),T([_({count:ie.COUNT})],x.prototype,"doubleSidedMode",void 0),T([_({count:Be.COUNT})],x.prototype,"pbrMode",void 0),T([_({count:$.COUNT})],x.prototype,"cullFace",void 0),T([_({count:re.COUNT})],x.prototype,"transparencyPassType",void 0),T([_({count:Z.COUNT})],x.prototype,"normalType",void 0),T([_({count:Qe.COUNT})],x.prototype,"textureCoordinateType",void 0),T([_({count:Ae.COUNT})],x.prototype,"customDepthTest",void 0),T([_()],x.prototype,"spherical",void 0),T([_()],x.prototype,"hasVertexColors",void 0),T([_()],x.prototype,"hasSymbolColors",void 0),T([_()],x.prototype,"hasVerticalOffset",void 0),T([_()],x.prototype,"hasSlicePlane",void 0),T([_()],x.prototype,"hasSliceHighlight",void 0),T([_()],x.prototype,"hasColorTexture",void 0),T([_()],x.prototype,"hasMetallicRoughnessTexture",void 0),T([_()],x.prototype,"hasEmissionTexture",void 0),T([_()],x.prototype,"hasOcclusionTexture",void 0),T([_()],x.prototype,"hasNormalTexture",void 0),T([_()],x.prototype,"hasScreenSizePerspective",void 0),T([_()],x.prototype,"hasVertexTangents",void 0),T([_()],x.prototype,"hasOccludees",void 0),T([_()],x.prototype,"multipassEnabled",void 0),T([_()],x.prototype,"hasModelTransformation",void 0),T([_()],x.prototype,"offsetBackfaces",void 0),T([_()],x.prototype,"vvSize",void 0),T([_()],x.prototype,"vvColor",void 0),T([_()],x.prototype,"receiveShadows",void 0),T([_()],x.prototype,"receiveAmbientOcclusion",void 0),T([_()],x.prototype,"textureAlphaPremultiplied",void 0),T([_()],x.prototype,"instanced",void 0),T([_()],x.prototype,"instancedColor",void 0),T([_()],x.prototype,"objectAndLayerIdColorInstanced",void 0),T([_()],x.prototype,"instancedDoublePrecision",void 0),T([_()],x.prototype,"doublePrecisionRequiresObfuscation",void 0),T([_()],x.prototype,"writeDepth",void 0),T([_()],x.prototype,"transparent",void 0),T([_()],x.prototype,"enableOffset",void 0),T([_()],x.prototype,"cullAboveGround",void 0),T([_()],x.prototype,"snowCover",void 0),T([_()],x.prototype,"hasColorTextureTransform",void 0),T([_()],x.prototype,"hasEmissionTextureTransform",void 0),T([_()],x.prototype,"hasNormalTextureTransform",void 0),T([_()],x.prototype,"hasOcclusionTextureTransform",void 0),T([_()],x.prototype,"hasMetallicRoughnessTextureTransform",void 0),T([_({constValue:!1})],x.prototype,"occlusionPass",void 0),T([_({constValue:!0})],x.prototype,"hasVvInstancing",void 0),T([_({constValue:!1})],x.prototype,"useCustomDTRExponentForWater",void 0),T([_({constValue:!1})],x.prototype,"supportsTextureAtlas",void 0),T([_({constValue:!0})],x.prototype,"useFillLights",void 0);var ct=class t extends Le{initializeConfiguration(e,r){super.initializeConfiguration(e,r),r.hasMetallicRoughnessTexture=!1,r.hasEmissionTexture=!1,r.hasOcclusionTexture=!1,r.hasNormalTexture=!1,r.hasModelTransformation=!1,r.normalType=Z.Attribute,r.doubleSidedMode=ie.WindingOrder,r.hasVertexTangents=!1}initializeProgram(e){return this._initializeProgram(e,t.shader)}};ct.shader=new yt(Fs,()=>import("./chunk-XECE62S7.js"));var be=class extends Ss{constructor(e){super(e,wa),this.supportsEdges=!0,this.produces=new Map([[Je.OPAQUE_MATERIAL,r=>(_t(r)||Tt(r))&&!this.parameters.transparent],[Je.TRANSPARENT_MATERIAL,r=>(_t(r)||Tt(r))&&this.parameters.transparent&&this.parameters.writeDepth],[Je.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,r=>(_t(r)||Tt(r))&&this.parameters.transparent&&!this.parameters.writeDepth]]),this._configuration=new x,this._vertexBufferLayout=Da(this.parameters)}isVisibleForOutput(e){return e!==Y.Shadow&&e!==Y.ShadowExcludeHighlight&&e!==Y.ShadowHighlight||this.parameters.castShadows}isVisible(){let e=this.parameters;if(!super.isVisible()||e.layerOpacity===0)return!1;let{hasInstancedColor:r,hasVertexColors:s,hasSymbolColors:n,vvColor:a}=e,o=e.colorMixMode==="replace",l=e.opacity>0,i=e.externalColor&&e.externalColor[3]>0,c=r||a||n;return s&&c?o||l:s?o?i:l:c?o||l:o?i:l}getConfiguration(e,r){return this._configuration.output=e,this._configuration.hasNormalTexture=!!this.parameters.normalTextureId,this._configuration.hasColorTexture=!!this.parameters.textureId,this._configuration.hasVertexTangents=this.parameters.hasVertexTangents,this._configuration.instanced=this.parameters.isInstanced,this._configuration.instancedDoublePrecision=this.parameters.instancedDoublePrecision,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.hasVerticalOffset=this.parameters.verticalOffset!=null,this._configuration.hasScreenSizePerspective=this.parameters.screenSizePerspective!=null,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasSliceHighlight=this.parameters.hasSliceHighlight,this._configuration.alphaDiscardMode=this.parameters.textureAlphaMode,this._configuration.normalType=this.parameters.normalType,this._configuration.transparent=this.parameters.transparent,this._configuration.writeDepth=this.parameters.writeDepth,this.parameters.customDepthTest!=null&&(this._configuration.customDepthTest=this.parameters.customDepthTest),this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.cullFace=this.parameters.hasSlicePlane?$.None:this.parameters.cullFace,this._configuration.multipassEnabled=r.multipassEnabled,this._configuration.cullAboveGround=r.multipassTerrain.cullAboveGround,this._configuration.hasModelTransformation=this.parameters.modelTransformation!=null,e===Y.Color&&(this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.hasSymbolColors=this.parameters.hasSymbolColors,this.parameters.treeRendering?this._configuration.doubleSidedMode=ie.WindingOrder:this._configuration.doubleSidedMode=this.parameters.doubleSided&&this.parameters.doubleSidedType==="normal"?ie.View:this.parameters.doubleSided&&this.parameters.doubleSidedType==="winding-order"?ie.WindingOrder:ie.None,this._configuration.instancedColor=this.parameters.hasInstancedColor,this._configuration.receiveShadows=this.parameters.receiveShadows&&this.parameters.shadowMappingEnabled,this._configuration.receiveAmbientOcclusion=this.parameters.receiveAmbientOcclusion&&r.ssao!=null,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.textureAlphaPremultiplied=!!this.parameters.textureAlphaPremultiplied,this._configuration.pbrMode=this.parameters.usePBR?this.parameters.isSchematic?Be.Schematic:Be.Normal:Be.Disabled,this._configuration.hasMetallicRoughnessTexture=!!this.parameters.metallicRoughnessTextureId,this._configuration.hasEmissionTexture=!!this.parameters.emissiveTextureId,this._configuration.hasOcclusionTexture=!!this.parameters.occlusionTextureId,this._configuration.offsetBackfaces=!(!this.parameters.transparent||!this.parameters.offsetTransparentBackfaces),this._configuration.transparencyPassType=r.transparencyPassType,this._configuration.enableOffset=r.camera.relativeElevation<mi,this._configuration.snowCover=this.hasSnowCover(r),this._configuration.hasColorTextureTransform=!!this.parameters.colorTextureTransformMatrix,this._configuration.hasNormalTextureTransform=!!this.parameters.normalTextureTransformMatrix,this._configuration.hasEmissionTextureTransform=!!this.parameters.emissiveTextureTransformMatrix,this._configuration.hasOcclusionTextureTransform=!!this.parameters.occlusionTextureTransformMatrix,this._configuration.hasMetallicRoughnessTextureTransform=!!this.parameters.metallicRoughnessTextureTransformMatrix),this._configuration}hasSnowCover(e){return e.weather!=null&&e.weatherVisible&&e.weather.type==="snowy"&&e.weather.snowCover==="enabled"}intersect(e,r,s,n,a,o){if(this.parameters.verticalOffset!=null){let l=s.camera;U(pr,r[12],r[13],r[14]);let i=null;switch(s.viewingMode){case De.Global:i=Ce(Ci,pr);break;case De.Local:i=Ie(Ci,La)}let c=0,u=oe(Va,pr,l.eye),m=q(u),f=X(u,u,1/m),h=null;this.parameters.screenSizePerspective&&(h=zt(i,f)),c+=vs(l,m,this.parameters.verticalOffset,h??0,this.parameters.screenSizePerspective),X(i,i,c),Ur(fr,i,s.transform.inverseRotation),n=oe(Ba,n,fr),a=oe(Na,a,fr)}di(e,s,n,a,_i(s.verticalOffset),o)}createGLMaterial(e){return new dr(e)}createBufferWriter(){return new Pt(this._vertexBufferLayout)}},dr=class extends Es{constructor(e){super(j(j({},e),e.material.parameters))}_updateShadowState(e){e.shadowMap.enabled!==this._material.parameters.shadowMappingEnabled&&this._material.setParameters({shadowMappingEnabled:e.shadowMap.enabled})}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){this._output===Y.Color&&(this._updateShadowState(e),this._updateOccludeeState(e));let r=this._material.parameters;this.updateTexture(r.textureId);let s=e.camera.viewInverseTransposeMatrix;return U(r.origin,s[3],s[7],s[11]),this._material.setParameters(this.textureBindParameters),this.ensureTechnique(r.treeRendering?ct:Le,e)}},gr=class extends Dt{constructor(){super(...arguments),this.initTextureTransparent=!1,this.treeRendering=!1,this.hasVertexTangents=!1}},wa=new gr;function Da(t){let e=Jr().vec3f(O.POSITION);return t.normalType===Z.Compressed?e.vec2i16(O.NORMALCOMPRESSED,{glNormalized:!0}):e.vec3f(O.NORMAL),t.hasVertexTangents&&e.vec4f(O.TANGENT),(t.textureId||t.normalTextureId||t.metallicRoughnessTextureId||t.emissiveTextureId||t.occlusionTextureId)&&e.vec2f(O.UV0),t.hasVertexColors&&e.vec4u8(O.COLOR),t.hasSymbolColors&&e.vec4u8(O.SYMBOLCOLOR),yr("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(O.OBJECTANDLAYERIDCOLOR),e}var Ba=M(),Na=M(),La=pe(0,0,1),Ci=M(),fr=M(),pr=M(),Va=M();var he=()=>ht.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");function Pi(t,e){return k(this,null,function*(){let r=yield Fa(t,e),s=yield Ha(r.textureDefinitions??{},e),n=0;for(let a in s)if(s.hasOwnProperty(a)){let o=s[a];n+=o?.image?o.image.width*o.image.height*4:0}return{resource:r,textures:s,size:n+br(r)}})}function Fa(t,e){return k(this,null,function*(){let r=e?.streamDataRequester;if(r)return Ua(t,r,e);let s=yield Ut(Lr(t,e));if(s.ok===!0)return s.value.data;Vt(s.error),wi(s.error)})}function Ua(t,e,r){return k(this,null,function*(){let s=yield Ut(e.request(t,"json",r));if(s.ok===!0)return s.value;Vt(s.error),wi(s.error.details.url)})}function wi(t){throw new ke("",`Request for object resource failed: ${t}`)}function Ga(t){let e=t.params,r=e.topology,s=!0;switch(e.vertexAttributes||(he().warn("Geometry must specify vertex attributes"),s=!1),e.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{let a=e.faces;if(a){if(e.vertexAttributes)for(let o in e.vertexAttributes){let l=a[o];l?.values?(l.valueType!=null&&l.valueType!=="UInt32"&&(he().warn(`Unsupported indexed geometry indices type '${l.valueType}', only UInt32 is currently supported`),s=!1),l.valuesPerElement!=null&&l.valuesPerElement!==1&&(he().warn(`Unsupported indexed geometry values per element '${l.valuesPerElement}', only 1 is currently supported`),s=!1)):(he().warn(`Indexed geometry does not specify face indices for '${o}' attribute`),s=!1)}}else he().warn("Indexed geometries must specify faces"),s=!1;break}default:he().warn(`Unsupported topology '${r}'`),s=!1}t.params.material||(he().warn("Geometry requires material"),s=!1);let n=t.params.vertexAttributes;for(let a in n)n[a].values||(he().warn("Geometries with externally defined attributes are not yet supported"),s=!1);return s}function Di(t,e){let r=new Array,s=new Array,n=new Array,a=new Rs,o=t.resource,l=Jt.parse(o.version||"1.0","wosr");ja.validate(l);let i=o.model.name,c=o.model.geometries,u=o.materialDefinitions??{},m=t.textures,f=0,h=new Map;for(let p=0;p<c.length;p++){let b=c[p];if(!Ga(b))continue;let d=ka(b),D=b.params.vertexAttributes,I=[],w=g=>{if(b.params.topology==="PerAttributeArray")return null;let C=b.params.faces;for(let N in C)if(N===g)return C[N].values;return null},B=D[O.POSITION],V=B.values.length/B.valuesPerElement;for(let g in D){let C=D[g],N=C.values,F=w(g)??pt(V);I.push([g,new xe(N,F,C.valuesPerElement,!0)])}let P=d.texture,y=m&&m[P];if(y&&!h.has(P)){let{image:g,parameters:C}=y,N=new Ze(g,C);s.push(N),h.set(P,N)}let E=h.get(P),v=E?E.id:void 0,R=d.material,A=a.get(R,P);if(A==null){let g=u[R.substring(R.lastIndexOf("/")+1)].params;g.transparency===1&&(g.transparency=0);let C=y&&y.alphaChannelUsage,N=g.transparency>0||C==="transparency"||C==="maskAndTransparency",F=y?Bi(y.alphaChannelUsage):void 0,z={ambient:rt(g.diffuse),diffuse:rt(g.diffuse),opacity:1-(g.transparency||0),transparent:N,textureAlphaMode:F,textureAlphaCutoff:.33,textureId:v,initTextureTransparent:!0,doubleSided:!0,cullFace:$.None,colorMixMode:g.externalColorMixMode||"tint",textureAlphaPremultiplied:y?.parameters.preMultiplyAlpha??!1};e?.materialParameters&&Object.assign(z,e.materialParameters),A=new be(z),a.set(R,P,A)}n.push(A);let S=new Ye(A,I);f+=I.find(g=>g[0]===O.POSITION)?.[1]?.indices.length??0,r.push(S)}return{engineResources:[{name:i,stageResources:{textures:s,materials:n,geometries:r},pivotOffset:o.model.pivotOffset,numberOfVertices:f,lodThreshold:null}],referenceBoundingBox:za(r)}}function za(t){let e=ft();return t.forEach(r=>{let s=r.boundingInfo;s!=null&&(qe(e,s.bbMin),qe(e,s.bbMax))}),e}function Ha(t,e){return k(this,null,function*(){let r=new Array;for(let a in t){let o=t[a],l=o.images[0].data;if(!l){he().warn("Externally referenced texture data is not yet supported");continue}let i=o.encoding+";base64,"+l,c="/textureDefinitions/"+a,u=o.channels==="rgba"?o.alphaChannelUsage||"transparency":"none",m={noUnpackFlip:!0,wrap:{s:we.REPEAT,t:we.REPEAT},preMultiplyAlpha:Bi(u)!==H.Opaque},f=e?.disableTextures?Promise.resolve(null):At(i,e);r.push(f.then(h=>({refId:c,image:h,parameters:m,alphaChannelUsage:u})))}let s=yield Promise.all(r),n={};for(let a of s)n[a.refId]=a;return n})}function Bi(t){switch(t){case"mask":return H.Mask;case"maskAndTransparency":return H.MaskBlend;case"none":return H.Opaque;default:return H.Blend}}function ka(t){let e=t.params;return{id:1,material:e.material,texture:e.texture,region:e.texture}}var ja=new Jt(1,2,"wosr");function zc(t,e){return k(this,null,function*(){let r=qa(fs(t));if(r.fileType==="wosr"){let m=yield e.cache?e.cache.loadWOSR(r.url,e):Pi(r.url,e),{engineResources:f,referenceBoundingBox:h}=Di(m,e);return{lods:f,referenceBoundingBox:h,isEsriSymbolResource:!1,isWosr:!0}}let s=yield e.cache?e.cache.loadGLTF(r.url,e,!!e.usePBR):As(new Ts(e.streamDataRequester),r.url,e,e.usePBR),n=s.model.meta?.ESRI_proxyEllipsoid,a=s.meta.isEsriSymbolResource&&n!=null&&s.meta.ESRI_webstyle==="EsriRealisticTreesStyle";a&&!s.customMeta.esriTreeRendering&&(s.customMeta.esriTreeRendering=!0,$a(s,n));let o=!!e.usePBR,l=s.meta.isEsriSymbolResource?{usePBR:o,isSchematic:!1,treeRendering:a,mrrFactors:[...Ii]}:{usePBR:o,isSchematic:!1,treeRendering:!1,mrrFactors:[...wt]},i=fe(j({},e.materialParameters),{treeRendering:a}),{engineResources:c,referenceBoundingBox:u}=Wa(s,l,i,e.skipHighLods&&r.specifiedLodIndex==null?{skipHighLods:!0}:{skipHighLods:!1,singleLodIndex:r.specifiedLodIndex});return{lods:c,referenceBoundingBox:u,isEsriSymbolResource:s.meta.isEsriSymbolResource,isWosr:!1}})}function qa(t){let e=t.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return e?{fileType:"gltf",url:e[1],specifiedLodIndex:e[4]!=null?Number(e[4]):null}:t.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:t,specifiedLodIndex:null}:{fileType:"unknown",url:t,specifiedLodIndex:null}}function Wa(t,e,r,s){let n=t.model,a=new Array,o=new Map,l=new Map,i=n.lods.length,c=ft();return n.lods.forEach((u,m)=>{let f=s.skipHighLods===!0&&(i>1&&m===0||i>3&&m===1)||s.skipHighLods===!1&&s.singleLodIndex!=null&&m!==s.singleLodIndex;if(f&&m!==0)return;let h=new bt(u.name,u.lodThreshold,[0,0,0]);u.parts.forEach(p=>{let b=f?new be({}):Xa(n,p,h,e,r,o,l),{geometry:d,vertexCount:D}=Ka(p,b??new be({})),I=d.boundingInfo;I!=null&&m===0&&(qe(c,I.bbMin),qe(c,I.bbMax)),b!=null&&(h.stageResources.geometries.push(d),h.numberOfVertices+=D)}),f||a.push(h)}),{engineResources:a,referenceBoundingBox:c}}function Xa(t,e,r,s,n,a,o){let l=e.material+(e.attributes.normal?"_normal":"")+(e.attributes.color?"_color":"")+(e.attributes.texCoord0?"_texCoord0":"")+(e.attributes.tangent?"_tangent":""),i=t.materials.get(e.material),c=e.attributes.texCoord0!=null,u=e.attributes.normal!=null;if(i==null)return null;let m=Qa(i.alphaMode);if(!a.has(l)){if(c){let P=(y,E=!1)=>{if(y!=null&&!o.has(y)){let v=t.textures.get(y);if(v!=null){let R=v.data;o.set(y,new Ze(gt(R)?R.data:R,fe(j({},v.parameters),{preMultiplyAlpha:!gt(R)&&E,encoding:gt(R)&&R.encoding!=null?R.encoding:void 0})))}}};P(i.textureColor,m!==H.Opaque),P(i.textureNormal),P(i.textureOcclusion),P(i.textureEmissive),P(i.textureMetallicRoughness)}let h=i.color[0]**(1/2.1),p=i.color[1]**(1/2.1),b=i.color[2]**(1/2.1),d=i.emissiveFactor[0]**(1/2.1),D=i.emissiveFactor[1]**(1/2.1),I=i.emissiveFactor[2]**(1/2.1),w=i.textureColor!=null&&c?o.get(i.textureColor):null,B=vi({normalTexture:i.textureNormal,metallicRoughnessTexture:i.textureMetallicRoughness,metallicFactor:i.metallicFactor,roughnessFactor:i.roughnessFactor,emissiveTexture:i.textureEmissive,emissiveFactor:i.emissiveFactor,occlusionTexture:i.textureOcclusion}),V=i.normalTextureTransform?.scale!=null?i.normalTextureTransform?.scale:Zr;a.set(l,new be(j(fe(j({},s),{transparent:m===H.Blend,customDepthTest:Ae.Lequal,textureAlphaMode:m,textureAlphaCutoff:i.alphaCutoff,diffuse:[h,p,b],ambient:[h,p,b],opacity:i.opacity,doubleSided:i.doubleSided,doubleSidedType:"winding-order",cullFace:i.doubleSided?$.None:$.Back,hasVertexColors:!!e.attributes.color,hasVertexTangents:!!e.attributes.tangent,normalType:u?Z.Attribute:Z.ScreenDerivative,castShadows:!0,receiveShadows:i.receiveShadows,receiveAmbientOcclusion:i.receiveAmbientOcclustion,textureId:w?.id,colorMixMode:i.colorMixMode,normalTextureId:i.textureNormal!=null&&c?o.get(i.textureNormal).id:void 0,textureAlphaPremultiplied:w!=null&&!!w.parameters.preMultiplyAlpha,occlusionTextureId:i.textureOcclusion!=null&&c?o.get(i.textureOcclusion).id:void 0,emissiveTextureId:i.textureEmissive!=null&&c?o.get(i.textureEmissive).id:void 0,metallicRoughnessTextureId:i.textureMetallicRoughness!=null&&c?o.get(i.textureMetallicRoughness).id:void 0,emissiveFactor:[d,D,I],mrrFactors:B?[...Si]:[i.metallicFactor,i.roughnessFactor,s.mrrFactors[2]],isSchematic:B,colorTextureTransformMatrix:$e(i.colorTextureTransform),normalTextureTransformMatrix:$e(i.normalTextureTransform),scale:[V[0],V[1]],occlusionTextureTransformMatrix:$e(i.occlusionTextureTransform),emissiveTextureTransformMatrix:$e(i.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:$e(i.metallicRoughnessTextureTransform)}),n)))}let f=a.get(l);if(r.stageResources.materials.push(f),c){let h=p=>{p!=null&&r.stageResources.textures.push(o.get(p))};h(i.textureColor),h(i.textureNormal),h(i.textureOcclusion),h(i.textureEmissive),h(i.textureMetallicRoughness)}return f}function Ka(t,e){let r=t.attributes.position.count,s=xs(t.indices||r,t.primitiveType),n=ot(3*r),{typedBuffer:a,typedBufferStride:o}=t.attributes.position;as(n,a,t.transform,3,o);let l=[[O.POSITION,new xe(n,s,3,!0)]];if(t.attributes.normal!=null){let c=ot(3*r),{typedBuffer:u,typedBufferStride:m}=t.attributes.normal;ss(tt,t.transform),os(c,u,tt,3,m),Ht(tt)&&Yt(c,c),l.push([O.NORMAL,new xe(c,s,3,!0)])}if(t.attributes.tangent!=null){let c=ot(4*r),{typedBuffer:u,typedBufferStride:m}=t.attributes.tangent;rs(tt,t.transform),ns(c,u,tt,4,m),Ht(tt)&&Yt(c,c,4),l.push([O.TANGENT,new xe(c,s,4,!0)])}if(t.attributes.texCoord0!=null){let c=ot(2*r),{typedBuffer:u,typedBufferStride:m}=t.attributes.texCoord0;ps(c,u,2,m),l.push([O.UV0,new xe(c,s,2,!0)])}let i=t.attributes.color;if(i!=null){let c=new Uint8Array(4*r);i.elementCount===4?i instanceof at?Zt(c,i,255):i instanceof Xe?gs(c,i):i instanceof $r&&Zt(c,i,1/256):(c.fill(255),i instanceof We?$t(c,i.typedBuffer,255,4,i.typedBufferStride):t.attributes.color instanceof Kr?ds(c,i.typedBuffer,4,t.attributes.color.typedBufferStride):t.attributes.color instanceof Qr&&$t(c,i.typedBuffer,1/256,4,i.typedBufferStride)),l.push([O.COLOR,new xe(c,s,4,!0)])}return{geometry:new Ye(e,l),vertexCount:r}}var tt=nt();function Qa(t){switch(t){case"BLEND":return H.Blend;case"MASK":return H.Mask;case"OPAQUE":case null:case void 0:return H.Opaque}}function $a(t,e){for(let r=0;r<t.model.lods.length;++r){let s=t.model.lods[r];for(let n of s.parts){let a=n.attributes.normal;if(a==null)return;let o=n.attributes.position,l=o.count,i=M(),c=M(),u=M(),m=new Uint8Array(4*l),f=new Float64Array(3*l),h=kt(Kt(),n.transform),p=0,b=0;for(let d=0;d<l;d++){o.getVec(d,c),a.getVec(d,i),ge(c,c,n.transform),oe(u,c,e.center),Gt(u,u,e.radius);let D=u[2],I=q(u),w=Math.min(.45+.55*I*I,1);Gt(u,u,e.radius),h!==null&&ge(u,u,h),Ce(u,u),r+1!==t.model.lods.length&&t.model.lods.length>1&&it(u,u,i,D>-1?.2:Math.min(-4*D-3.8,1)),f[p]=u[0],f[p+1]=u[1],f[p+2]=u[2],p+=3,m[b]=255*w,m[b+1]=255*w,m[b+2]=255*w,m[b+3]=255,b+=4}n.attributes.normal=new We(f),n.attributes.color=new Xe(m)}}}export{zc as fetch,Wa as gltfToEngineResources,qa as parseUrl};

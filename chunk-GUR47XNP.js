import{a as B}from"./chunk-HMLFVNCH.js";import{a as A}from"./chunk-EZIYNRHJ.js";import{a as Y}from"./chunk-J3VF5LTP.js";import{f as L,g as z}from"./chunk-J57HR4DB.js";import{a as V,n as K}from"./chunk-TCCAOREC.js";import{I as w,L as O}from"./chunk-Z5NXR7SL.js";import{S as E}from"./chunk-7JLWSSXP.js";import{a as T}from"./chunk-W3WDPWBE.js";import{b as R}from"./chunk-TZHKPIVH.js";function X(r,e){return r.length=0,e.forEach(i=>r.push(i)),r}var F=new Set,b=[],x=new Map,G=[0,0],g=class extends O{constructor(r){super(r),this._keyToItem=new Map,this.concurrency=6,this.strategy="scale-first",this.tileInfoView=null}initialize(){let{concurrency:r,process:e,strategy:i}=this;this._queue=new Y({concurrency:r,process:(s,t)=>{let o=this._keyToItem.get(s);return e(o,{signal:t})},peeker:i==="scale-first"?s=>this._peekByScaleFirst(s):s=>this._peekByCenterFirst(s)})}destroy(){this.clear(),this._queue=R(this._queue)}get length(){return this._queue?this._queue.length:0}get onGoingCount(){return this._keyToItem.size}abort(r){let e=typeof r=="string"?r:r.id;this._queue.abort(e)}clear(){this._queue.clear(),this._keyToItem.clear()}has(r){return typeof r=="string"?this._keyToItem.has(r):this._keyToItem.has(r.id)}isOngoing(r){let e=typeof r=="string"?r:r.id;return this.has(e)&&this._queue.isOngoing(e)}pause(){this._queue.pause()}push(r){let e=r.key.id;if(this._queue.has(e))return this._queue.get(e);let i=this._queue.push(e),s=()=>{this._keyToItem.delete(e)};return this._keyToItem.set(e,r),i.then(s,s),i}reset(){this._queue.reset()}resume(){this._queue.resume()}_peekByScaleFirst(r){if(!this.state)return r.values().next().value;let e=this.tileInfoView,i=Number.NEGATIVE_INFINITY,s=Number.POSITIVE_INFINITY;r.forEach(h=>{let l=this._keyToItem.get(h),a=this.tileInfoView.getTileScale(l.key);x.has(a)||(x.set(a,[]),i=Math.max(a,i),s=Math.min(a,s)),x.get(a).push(l.key),F.add(a)});let t=this.state.scale;x.has(t)||(X(b,F),b.sort((h,l)=>h-l),t=b.reduce((h,l)=>Math.abs(l-t)<Math.abs(h-t)?l:h,b[0])),t=Math.min(t,i),t=Math.max(t,s);let o=x.get(t),u=e.getClosestInfoForScale(t),c=u.getColumnForX(this.state.center[0]),f=u.getRowForY(this.state.center[1]);return o.sort((h,l)=>{let a=u.denormalizeCol(h.col,h.world),d=u.denormalizeCol(l.col,l.world);return Math.sqrt((c-a)*(c-a)+(f-h.row)*(f-h.row))-Math.sqrt((c-d)*(c-d)+(f-l.row)*(f-l.row))}),F.clear(),x.clear(),o[0].id}_peekByCenterFirst(r){if(!this.state)return r.values().next().value;let e=this.tileInfoView,i=this.state.center,s,t=Number.POSITIVE_INFINITY;return r.forEach(o=>{let u=this._keyToItem.get(o);e.getTileCoords(G,u.key);let c=L(G,i);c<t&&(t=c,s=u.key)}),s.id}};T([w({constructOnly:!0})],g.prototype,"concurrency",void 0),T([w({constructOnly:!0})],g.prototype,"process",void 0),T([w()],g.prototype,"state",void 0),T([w({constructOnly:!0})],g.prototype,"strategy",void 0),T([w({constructOnly:!0})],g.prototype,"tileInfoView",void 0),g=T([E("esri.views.2d.tiling.TileQueue")],g);var re=g;var S=class{constructor(e,i,s){this.maxSize=e,this._tileInfoView=i,this._removedFunc=s,this._tilePerId=new Map,this._tileKeysPerLevel=[]}clear(){this._tilePerId.clear(),this._tileKeysPerLevel=[]}has(e){return this._tilePerId.has(e)}get(e){return this._tilePerId.get(e)}pop(e){let i=this._tilePerId.get(e);if(!i)return;let s=i.key.level,t=this._tileKeysPerLevel[s];Q(this._tilePerId,e);for(let o=0;o<t.length;o++)if(t[o].id===e){t.splice(o,1);break}return i.visible=!0,i}add(e){e.visible=!1;let i=e.key,s=i.id;if(this._tilePerId.has(s))return;this._tilePerId.set(s,e);let t=i.level;this._tileKeysPerLevel[t]||(this._tileKeysPerLevel[t]=[]),this._tileKeysPerLevel[t].push(i)}prune(e,i,s){let t=this._tilePerId.size;if(t<=this.maxSize)return;let o=this._tileKeysPerLevel.length-1;for(;t>this.maxSize&&o>=0;)o!==e&&(t=this._pruneAroundCenterTile(t,i,s,o)),o--;t>this.maxSize&&(t=this._pruneAroundCenterTile(t,i,s,e))}_pruneAroundCenterTile(e,i,s,t){let o=this._tileKeysPerLevel[t];if(!o||o.length===0)return e;let{size:u,origin:c}=this._tileInfoView.tileInfo,f=s*u[0],h=s*u[1],l=[0,0],a=[0,0];for(o.sort((d,m)=>(l[0]=c.x+f*(d.col+.5),l[1]=c.y-h*(d.row+.5),a[0]=c.x+f*(m.col+.5),a[1]=c.y-h*(m.row+.5),z(l,i)-z(a,i)));o.length>0;){let d=o.pop();if(this._removeTile(d.id),--e===this.maxSize)break}return e}_removeTile(e){let i=this._tilePerId.get(e);this._removedFunc&&i&&this._removedFunc(i),Q(this._tilePerId,e)}};function Q(r,e){r.delete(e)}var k=new A(0,0,0,0),_=new Map,P=[],M=[],D=class{constructor(e){this._previousScale=Number.POSITIVE_INFINITY,this.cachePolicy="keep",this.coveragePolicy="closest",this.resampling=!0,this.tileIndex=new Map,this.tiles=[],this.buffer=192,this.acquireTile=e.acquireTile,this.releaseTile=e.releaseTile,this.tileInfoView=e.tileInfoView,e.resampling!=null&&(this.resampling=e.resampling),e.cachePolicy&&(this.cachePolicy=e.cachePolicy),e.coveragePolicy&&(this.coveragePolicy=e.coveragePolicy),e.buffer!=null&&(this.buffer=e.buffer),e.cacheSize&&(this._tileCache=new S(e.cacheSize,this.tileInfoView,i=>{this.releaseTile(i)}))}destroy(){this.tileIndex.clear()}update(e){let{resampling:i,tileIndex:s}=this,{scale:t,center:o,resolution:u}=e.state,{minScale:c,maxScale:f}=this.tileInfoView,h=!e.stationary&&t>this._previousScale;if(this._previousScale=t,!i&&(t>c||t<f))return this.tiles.length=0,void this.clear();let l=this.tileInfoView.getTileCoverage(e.state,this.buffer,this.resampling,this.coveragePolicy);if(!l)return this.tiles.length=0,void this.clear();let{spans:a,lodInfo:d}=l,{level:m}=d;this.tiles.length=0,s.forEach(n=>n.visible=!0);let N=0,q=0;if(a.length>0)for(let{row:n,colFrom:v,colTo:C}of a)for(let I=v;I<=C;I++){N++;let p=k.set(m,n,d.normalizeCol(I),d.getWorldForColumn(I)).id,y=s.get(p);if(y)y.isReady?(_.set(p,y),q++):h||this._addParentTile(p,_);else{if(this._tileCache?.has(p)){if(y=this._tileCache.pop(p),this.tileIndex.set(p,y),y.isReady){_.set(p,y),q++;continue}}else y=this.acquireTile(k),this.tileIndex.set(p,y);h||this._addParentTile(p,_)}}let W=q===N;for(let[n,v]of s){if(_.has(n))continue;k.set(n);let C=this.tileInfoView.intersects(l,k),I=this.cachePolicy==="purge"?k.level!==m:k.level>m;!C||!h&&W?!I&&C||P.push(v):v.isReady?I&&this.cachePolicy==="purge"&&this._hasReadyAncestor(k,m)?P.push(v):M.push(v):I&&P.push(v)}for(let n of M)n.isReady&&_.set(n.key.id,n);for(let n of P)this._tileCache?this._tileCache.add(n):this.releaseTile(n),s.delete(n.key.id);for(let n of _.values())this.tiles.push(n);for(let n of s.values())_.has(n.key.id)||(n.visible=!1);this._tileCache?.prune(m,o,u),B.pool.release(l),M.length=0,P.length=0,_.clear()}clear(){let{tileIndex:e}=this;for(let i of e.values())this.releaseTile(i);e.clear()}refresh(e){for(let i of this.tileIndex.values())this.tiles.includes(i)?e(i):P.push(i);for(let i of P)this.releaseTile(i),this.tileIndex.delete(i.key.id);this._tileCache?.clear()}updateCacheSize(e){this._tileCache&&(this._tileCache.maxSize=e)}_addParentTile(e,i){let s=e,t=null;for(;s=this.tileInfoView.getTileParentId(s),s;)if(this.tileIndex.has(s)){if(t=this.tileIndex.get(s),t?.isReady){i.has(t.key.id)||i.set(t.key.id,t);break}}else if(this._tileCache?.has(s)&&(t=this._tileCache.pop(s),this.tileIndex.set(s,t),t?.isReady)){i.has(t.key.id)||i.set(t.key.id,t);break}}_hasReadyAncestor(e,i){let s=V();this.tileInfoView.getTileBounds(s,e,!0);for(let t of this.tileIndex.values())if(t.isReady&&t.key.level>=i&&t.key.level<e.level){let o=V();if(this.tileInfoView.getTileBounds(o,t.key,!0),K(o,s))return!0}return!1}};export{re as a,D as b};

import{b as re,c as ae,d as oe}from"./chunk-BEBRAWZX.js";import{c as se}from"./chunk-IXZYGJ4V.js";import{a as ie}from"./chunk-O4IUXH7A.js";import{a as E}from"./chunk-JHZRGEBS.js";import{m as ee,n as te,o as ne}from"./chunk-UHE637ZN.js";import{a as Y}from"./chunk-7QY3BMVN.js";import{a as X}from"./chunk-UYBHUOFR.js";import{f as z}from"./chunk-SO6OJFOM.js";import{b as S}from"./chunk-DG5QI6E2.js";import{G as H}from"./chunk-OFVMJORF.js";import{c as V}from"./chunk-K4GPNFIS.js";import{O as U,aa as x,h as J,q}from"./chunk-BRGZVJPZ.js";import{q as B,s as F}from"./chunk-BRWS572J.js";import{a as h,b as I,g as T}from"./chunk-JEGVIFEP.js";var M=()=>B.getLogger("esri.layers.ogc.ogcFeatureUtils"),le="startindex",ye=new Set([le,"offset"]),ce="http://www.opengis.net/def/crs/",Ze=`${ce}OGC/1.3/CRS84`,l;function Ke(a,s){return T(this,arguments,function*(e,t,i={},n=5){let{links:c}=e,g=y(c,"items",l.geojson)||y(c,"http://www.opengis.net/def/rel/ogc/1.0/items",l.geojson);if(g==null)throw new F("ogc-feature-layer:missing-items-page","Missing items url");let{apiKey:w,customParameters:f,signal:m}=i,v=q(g.href,e.landingPage.url),Z=I(h({limit:n},f),{token:w}),W=U(v,Z),C={accept:l.geojson},{data:G}=yield x(W,{signal:m,headers:C}),K=Te(W,n,G.links)??le;re(G);let p=ae(G,{geometryType:t.geometryType}),d=t.fields||p.fields||[],O=t.hasZ!=null?t.hasZ:p.hasZ,D=p.geometryType,k=t.objectIdField||p.objectIdFieldName||"OBJECTID",o=t.timeInfo,P=d.find(({name:r})=>r===k);if(P)P.editable=!1,P.nullable=!1;else{if(!p.objectIdFieldType)throw new F("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");d.unshift({name:k,alias:k,type:p.objectIdFieldType==="number"?"esriFieldTypeOID":"esriFieldTypeString",editable:!1,nullable:!1})}if(k!==p.objectIdFieldName){let r=d.find(({name:u})=>u===p.objectIdFieldName);r&&(r.type="esriFieldTypeInteger")}d===p.fields&&p.unknownFields.length>0&&M().warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:p.unknownFields}});for(let r of d){if(r.name==null&&(r.name=r.alias),r.alias==null&&(r.alias=r.name),r.type!=="esriFieldTypeOID"&&r.type!=="esriFieldTypeGlobalID"&&(r.editable=r.editable==null||!!r.editable,r.nullable=r.nullable==null||!!r.nullable),!r.name)throw new F("ogc-feature-layer:invalid-field-name","field name is missing",{field:r});if(!X.jsonValues.includes(r.type))throw new F("ogc-feature-layer:invalid-field-type",`invalid type for field "${r.name}"`,{field:r})}if(o){let r=new E(d);if(o.startTimeField){let u=r.get(o.startTimeField);u?(o.startTimeField=u.name,u.type="esriFieldTypeDate"):o.startTimeField=null}if(o.endTimeField){let u=r.get(o.endTimeField);u?(o.endTimeField=u.name,u.type="esriFieldTypeDate"):o.endTimeField=null}if(o.trackIdField){let u=r.get(o.trackIdField);u?o.trackIdField=u.name:(o.trackIdField=null,M().warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:o}}))}o.timeReference||={timeZoneIANA:V},o.startTimeField||o.endTimeField||(M().warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:o}}),o=void 0)}return{drawingInfo:D?ie(D):null,extent:Ie(e),geometryType:D,fields:d,hasZ:!!O,objectIdField:k,paginationParameter:K,timeInfo:o}})}function Le(i){return T(this,arguments,function*(e,t={}){let{links:n,url:a}=e,s=y(n,"data",l.json)||y(n,"http://www.opengis.net/def/rel/ogc/1.0/data",l.json);if(s==null)throw new F("ogc-feature-layer:missing-collections-page","Missing collections url");let{apiKey:c,customParameters:g,signal:w}=t,f=q(s.href,a),{data:m}=yield x(f,{signal:w,headers:{accept:l.json},query:I(h({},g),{token:c})});for(let v of m.collections)v.landingPage=e;return m})}function Je(i){return T(this,arguments,function*(e,t={}){let{links:n,url:a}=e,s=y(n,"conformance",l.json)||y(n,"http://www.opengis.net/def/rel/ogc/1.0/conformance",l.json);if(s==null)throw new F("ogc-feature-layer:missing-conformance-page","Missing conformance url");let{apiKey:c,customParameters:g,signal:w}=t,f=q(s.href,a),{data:m}=yield x(f,{signal:w,headers:{accept:l.json},query:I(h({},g),{token:c})});return m})}function ze(i){return T(this,arguments,function*(e,t={}){let{apiKey:n,customParameters:a,signal:s}=t,{data:c}=yield x(e,{signal:s,headers:{accept:l.json},query:I(h({},a),{token:n})});return c.url=e,c})}function Ee(i){return T(this,arguments,function*(e,t={}){let{links:n,url:a}=e,s=y(n,"service-desc",l.openapi);if(s==null)return M().warn("ogc-feature-layer:missing-openapi-page","The OGC API-Features server does not have an OpenAPI page."),null;let{apiKey:c,customParameters:g,signal:w}=t,f=q(s.href,a),{data:m}=yield x(f,{signal:w,headers:{accept:l.openapi},query:I(h({},g),{token:c})});return m})}function Qe(e){let t=/^http:\/\/www\.opengis.net\/def\/crs\/(?<authority>.*)\/(?<version>.*)\/(?<code>.*)$/i.exec(e),i=t?.groups;if(!i)return null;let{authority:n,code:a}=i;switch(n.toLowerCase()){case"ogc":switch(a.toLowerCase()){case"crs27":return S.GCS_NAD_1927.wkid;case"crs83":return 4269;case"crs84":case"crs84h":return S.WGS84.wkid;default:return null}case"esri":case"epsg":{let s=Number.parseInt(a,10);return Number.isNaN(s)?null:s}default:return null}}function _e(e,t,i){return T(this,null,function*(){let n=yield we(e,t,i);return ne(n)})}function we(e,t,i){return T(this,null,function*(){let{collection:{links:n,landingPage:{url:a}},layerDefinition:s,maxRecordCount:c,queryParameters:{apiKey:g,customParameters:w},spatialReference:f,supportedCrs:m}=e,v=y(n,"items",l.geojson)||y(n,"http://www.opengis.net/def/rel/ogc/1.0/items",l.geojson);if(v==null)throw new F("ogc-feature-layer:missing-items-page","Missing items url");let{geometry:Z,num:W,start:C,timeExtent:G,where:K}=t;if(t.objectIds)throw new F("ogc-feature-layer:query-by-objectids-not-supported","Queries with object ids are not supported");let p=S.fromJSON(f),d=t.outSpatialReference??p,O=d.isWGS84?null:ue(d,m),D=je(Z,m),k=he(G),o=Fe(K),P=W??(C==null?c:10),r=C===0?void 0:C,{fields:u,geometryType:A,hasZ:L,objectIdField:$,paginationParameter:de}=s,fe=q(v.href,a),{data:_}=yield x(fe,I(h({},i),{query:I(h(h({},w),D),{crs:O,datetime:k,query:o,limit:P,[de]:r,token:g}),headers:{accept:l.geojson}})),R=oe(_,{geometryType:A,hasZ:L,objectIdField:$}),me=R.length===P&&!!y(_.links??[],"next",l.geojson),pe=new E(u);for(let b of R){let N={};se(pe,N,b.attributes),N[$]=b.attributes[$],b.attributes=N}if(!O&&d.isWebMercator){for(let b of R)if(b.geometry!=null&&A!=null){let N=te(b.geometry,A,L,!1);N.spatialReference=S.WGS84,b.geometry=ee(z(N,d))}}for(let b of R)b.objectId=b.attributes[$];let ge=O||!O&&d.isWebMercator?d.toJSON():H,j=new Y;return j.exceededTransferLimit=me,j.features=R,j.fields=u,j.geometryType=A,j.hasZ=L,j.objectIdFieldName=$,j.spatialReference=ge,j})}function be(e){return e!=null&&e.type==="extent"}function ue(e,t){let{isWebMercator:i,wkid:n}=e;if(!n)return null;let a=i?t[3857]??t[102100]??t[102113]??t[900913]:t[e.wkid];return a?`${ce}${a}`:null}function Q(e){if(e==null)return"";let{xmin:t,ymin:i,xmax:n,ymax:a}=e;return`${t},${i},${n},${a}`}function he(e){if(e==null)return null;let{start:t,end:i}=e;return`${t!=null?t.toISOString():".."}/${i!=null?i.toISOString():".."}`}function Fe(e){return e!=null&&e&&e!=="1=1"?e:null}function je(e,t){if(!be(e))return null;let{spatialReference:i}=e;if(!i||i.isWGS84)return{bbox:Q(e)};let n=ue(i,t);return n!=null?{bbox:Q(e),"bbox-crs":n}:i.isWebMercator?{bbox:Q(z(e,S.WGS84))}:null}function Ie(e){let t=e.extent?.spatial;if(!t)return null;let i=t.bbox[0],n=i.length===4,[a,s]=i,c=n?void 0:i[2];return{xmin:a,ymin:s,xmax:n?i[2]:i[3],ymax:n?i[3]:i[4],zmin:c,zmax:n?void 0:i[5],spatialReference:S.WGS84.toJSON()}}function y(e,t,i){return e.find(({rel:n,type:a})=>n===t&&a===i)??e.find(({rel:n,type:a})=>n===t&&!a)}function Te(e,t,i){if(!i)return;let n=y(i,"next",l.geojson),a=J(n?.href)?.query;if(!a)return;let s=J(e).query,c=Object.keys(s??{});return Object.entries(a).filter(([f])=>!c.includes(f)).find(([f,m])=>ye.has(f.toLowerCase())&&Number.parseInt(m,10)===t)?.[0]}(function(e){e.json="application/json",e.geojson="application/geo+json",e.openapi="application/vnd.oai.openapi+json;version=3.0"})(l||(l={}));export{ce as a,Ze as b,Ke as c,Le as d,Je as e,ze as f,Ee as g,Qe as h,_e as i,we as j};

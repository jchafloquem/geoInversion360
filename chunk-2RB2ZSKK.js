import{a as g,b as P,c as R,d as D,e as E,f as x,g as N,h as U,i as C,j as G}from"./chunk-VBEIMRVI.js";import"./chunk-U5TFOFQK.js";import{a as L}from"./chunk-FQTXYWH5.js";import"./chunk-KLXERNY4.js";import"./chunk-IEUO5FDE.js";import"./chunk-G5XYT3EB.js";import{a as F,b as J}from"./chunk-6GWKQSL3.js";import"./chunk-C7VU6XKS.js";import{a as Y}from"./chunk-ALZMTSHO.js";import{a as A,d as w,e as v,f as b,g as y}from"./chunk-3JO3IXGW.js";import{b as f}from"./chunk-SPJDFBYB.js";import{j as K}from"./chunk-3JLZ7SFH.js";import"./chunk-N566L3JG.js";import"./chunk-7S6PD5JC.js";import"./chunk-ZWI7LLTZ.js";import"./chunk-6NCXSKJD.js";import"./chunk-ATXTHXJA.js";import"./chunk-VFINLX57.js";import"./chunk-LM5MGO7W.js";import"./chunk-4HUAEW4D.js";import"./chunk-XWRPBDYS.js";import"./chunk-TCCAOREC.js";import"./chunk-BCREO4Q5.js";import"./chunk-SO6OJFOM.js";import"./chunk-DG5QI6E2.js";import"./chunk-TMZNSBQB.js";import"./chunk-ZGLJFDS6.js";import"./chunk-RSDQHAJX.js";import"./chunk-OFVMJORF.js";import"./chunk-LYPZUCFI.js";import"./chunk-HFQFGALU.js";import"./chunk-5TSEU5EE.js";import"./chunk-VC35VCVT.js";import"./chunk-MT7BXRRQ.js";import"./chunk-NNKLK2DS.js";import"./chunk-BRGZVJPZ.js";import"./chunk-Z5NXR7SL.js";import"./chunk-7JLWSSXP.js";import"./chunk-W3WDPWBE.js";import"./chunk-JKP4I6UL.js";import"./chunk-TZHKPIVH.js";import"./chunk-JPDAKIWT.js";import"./chunk-W6LY37E4.js";import{s as p}from"./chunk-BRWS572J.js";import{d as $,f as O,m as M}from"./chunk-AKNRR36C.js";import{g as l}from"./chunk-JEGVIFEP.js";var T="Feature Service",I="feature-layer-utils",ee=`${I}-save`,ae=`${I}-save-as`,m=`${I}-saveall`,d=`${I}-saveall-as`;function S(e){return{isValid:K(e)&&(e.type!=="feature"||!e.dynamicDataSource),errorMessage:"Feature layer should be a layer or table in a map or feature service"}}function j(e){let a=[],t=[];for(let{layer:r,layerJSON:o}of e)r.isTable?t.push(o):a.push(o);return{layers:a,tables:t}}function k(e){return j([e])}function q(e,a){return l(this,null,function*(){return/\/\d+\/?$/.test(e.url)?k(a[0]):V(a,e)})}function V(e,a){return l(this,null,function*(){if(e.reverse(),!a)return j(e);let t=yield te(a,e);for(let r of e)H(r.layer,r.layerJSON,t);return ne(t,e),t})}function te(e,a){return l(this,null,function*(){let t=yield e.fetchData("json");if(re(t))return t;t||={},se(t);let{layer:{url:r,customParameters:o,apiKey:n}}=a[0];return yield oe(t,{url:r??"",customParameters:o,apiKey:n},a.map(s=>s.layer.layerId)),t})}function re(e){return!!(e&&Array.isArray(e.layers)&&Array.isArray(e.tables))}function se(e){e.layers||=[],e.tables||=[]}function ne(e,a){let t=[],r=[];for(let{layer:o}of a){let{isTable:n,layerId:s}=o;n?r.push(s):t.push(s)}_(e.layers,t),_(e.tables,r)}function _(e,a){if(e.length<2)return;let t=[];for(let{id:r}of e)t.push(r);$(t.sort(W),a.slice().sort(W))&&e.sort((r,o)=>{let n=a.indexOf(r.id),s=a.indexOf(o.id);return n<s?-1:n>s?1:0})}function W(e,a){return e<a?-1:e>a?1:0}function oe(e,a,t){return l(this,null,function*(){let{url:r,customParameters:o,apiKey:n}=a,{serviceJSON:s,layersJSON:i}=yield F(r,{customParameters:o,apiKey:n}),c=z(e.layers,s.layers,t),u=z(e.tables,s.tables,t);e.layers=c.itemResources,e.tables=u.itemResources;let h=[...c.added,...u.added],Z=i?[...i.layers,...i.tables]:[];yield ie(e,h,r,Z)})}function z(e,a,t){let r=O(e,a,(n,s)=>n.id===s.id);e=e.filter(n=>!r.removed.some(s=>s.id===n.id));let o=r.added;return o.forEach(({id:n})=>{e.push({id:n})}),{itemResources:e,added:o.filter(({id:n})=>!t.includes(n))}}function ie(e,a,t,r){return l(this,null,function*(){let o=yield le(a),n=a.map(({id:s,type:i})=>new(o.get(i))({url:t,layerId:s,sourceJSON:r.find(({id:c})=>c===s)}));yield Promise.allSettled(n.map(s=>s.load())),n.forEach(s=>{let{layerId:i,loaded:c,defaultPopupTemplate:u}=s;if(!c||u==null)return;let h={id:i,popupInfo:u.toJSON()};s.operationalLayerType!=="ArcGISFeatureLayer"&&(h.layerType=s.operationalLayerType),H(s,h,e)})})}function le(e){return l(this,null,function*(){let a=[];e.forEach(({type:o})=>{let n=J(o),s=Y[n];a.push(s())});let t=yield Promise.all(a),r=new Map;return e.forEach(({type:o},n)=>{r.set(o,t[n])}),r})}function H(e,a,t){e.isTable?B(t.tables,a):B(t.layers,a)}function B(e,a){let t=e.findIndex(({id:r})=>r===a.id);t===-1?e.push(a):e[t]=a}function Q(e,a){if(!e.length)throw new p(`${a}:missing-parameters`,"'layers' array should contain at least one feature layer")}function ce(e,a){let t=e.map(r=>r.portalItem.id);if(new Set(t).size>1)throw new p(`${a}:invalid-parameters`,"All layers in the 'layers' array should be loaded from the same portal item")}function X(e,a){let t=e.map(r=>r.layerId);if(new Set(t).size!==t.length)throw new p(`${a}:invalid-parameters`,"'layers' array should contain only one instance each of layer or table in a feature service")}function ue(e){return l(this,null,function*(){Q(e,m),yield Promise.all(e.map(a=>a.load()));for(let a of e)g(a,m,S),R({layer:a,itemType:T,errorNamePrefix:m});ce(e,m),X(e,m)})}function ye(e,a){return l(this,null,function*(){let{url:t,layerId:r,title:o,fullExtent:n,isTable:s}=e,i=f(t);a.url=(i?.serverType==="FeatureServer"?t:`${t}/${r}`)??null,a.title||=o,a.extent=null,s||n==null||(a.extent=yield b(n)),w(a,y.METADATA),w(a,y.MULTI_LAYER),A(a,y.SINGLE_LAYER),s&&A(a,y.TABLE)})}function pe(e,a){for(let n of e){let s=n.parsedUrl.path,i=f(s);if(!i?.url.path)throw new p(`${a}:invalid-parameters`,P(n,`has unsupported url pattern: ${s}`),{layer:n});let u=i?.serverType;if(u!=="FeatureServer"&&u!=="MapServer")throw new p(`${a}:invalid-parameters`,P(n,`has unsupported server type: ${u}`),{layer:n});if(u==="MapServer"&&e.length>1)throw new p(`${a}:invalid-parameters`,"Only one layer or table in a map service can be saved")}let t=f(e[0].parsedUrl.path),r=t?.url.path;if(!e.every(n=>f(n.parsedUrl.path)?.url.path===r))throw new p(`${a}:invalid-parameters`,"'layers' array should only contain layers or tables that belong to the same feature service")}function fe(e){return l(this,null,function*(){Q(e,d),yield Promise.all(e.map(a=>a.load()));for(let a of e)g(a,d,S);pe(e,d),X(e,d)})}function me(e,a){return l(this,null,function*(){let t=0,r=0;for(let{isTable:s}of a)s?r++:t++;let o=a[0].parsedUrl.path,n=f(o);if(e.url=n?.serverType==="FeatureServer"?n.url.path:o,e.title||=n.title,e.extent=null,t>0){let s=a.map(i=>i.fullExtent).filter(M).reduce((i,c)=>i.clone().union(c));s&&(e.extent=yield b(s))}w(e,y.METADATA),v(e,y.MULTI_LAYER,a.length>1),v(e,y.SINGLE_LAYER,a.length===1),v(e,y.TABLE,r>0&&t===0),N(e)})}function Le(e,a){return l(this,null,function*(){return C({layer:e,itemType:T,validateLayer:S,createItemData:(t,r)=>q(r,[t]),errorNamePrefix:ee},a)})}function ge(e,a){return l(this,null,function*(){yield ue(e);let t=e[0].portalItem,r=E(t),o=yield Promise.all(e.map(s=>x(s,r,a))),n=yield q(t,e.map((s,i)=>({layer:s,layerJSON:o[i]})));return N(t),yield t.update({data:n}),yield Promise.all(e.slice(1).map(s=>s.portalItem.reload())),L(r),t.clone()})}function Pe(e,a,t){return l(this,null,function*(){return G({layer:e,itemType:T,validateLayer:S,createItemData:(r,o)=>Promise.resolve(k(r)),errorNamePrefix:ae,newItem:a,setItemProperties:ye},t)})}function Ee(e,a,t){return l(this,null,function*(){yield fe(e);let r=D({itemType:T,errorNamePrefix:d,newItem:a}),o=E(r),n=yield Promise.all(e.map(i=>x(i,o,t))),s=yield V(e.map((i,c)=>({layer:i,layerJSON:n[c]})));yield me(r,e),yield U(r,s,t);for(let i of e)i.portalItem=r.clone();return L(o),r})}export{Le as save,ge as saveAll,Ee as saveAllAs,Pe as saveAs};

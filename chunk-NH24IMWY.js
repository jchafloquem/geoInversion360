import{c as Di}from"./chunk-MLIIG4W2.js";import{d as he,e as it,i as Y,j as Rs,k as st,l as z,m as R,n as D,o as M,p as C,q as we}from"./chunk-EAOA3IP2.js";import{b as Cs}from"./chunk-GFO5ECL6.js";import{a as tt}from"./chunk-R4ZRZJFL.js";import{$ as ne,A as X,Aa as zt,B as us,Ba as _t,C as ps,Ca as Be,D as Oe,Da as ws,E as cs,Ea as Mt,F as ve,Fa as Pt,G as ms,Ga as Dt,H as yt,Ha as It,I as Xe,Ia as Ts,J as Fi,Ja as Fs,K as fs,Ka as zs,L as Ye,La as Ct,M as ds,Ma as _s,N as zi,Na as Ms,O as gt,Oa as Ps,P as oe,Q as Qe,R as Je,Ra as Ds,S as _i,T as xt,U as k,Ua as Ue,V as W,Va as Is,W as hs,X as v,Y as L,Z as S,_ as j,a as I,aa as bt,b as Ze,ba as vt,c as Vi,ca as ys,d as ts,da as Le,e as is,ea as J,f as wi,fa as St,g as ss,ga as Mi,ha as ie,i as rs,ia as gs,ja as Vt,ka as Pi,l as as,la as xs,m as os,ma as Se,n as ns,na as bs,o as ls,oa as le,p as te,pa as Ve,q as G,qa as ue,r as n,ra as pe,s as g,sa as wt,t as _,ta as Ee,u as T,ua as vs,v as Ti,va as Tt,w as ht,wa as Ft,x as q,xa as et,y as Ae,ya as Ss,z as Pe,za as Vs}from"./chunk-HWE2MRBZ.js";import{l as dt}from"./chunk-MODIWOII.js";import{a as Si,b as ct,c as Qi,d as ft}from"./chunk-IATQ4WNP.js";import{v as es}from"./chunk-SE7FIBEW.js";import{a as Zi}from"./chunk-J3VF5LTP.js";import{i as Re,j as mt}from"./chunk-SRPI622Y.js";import{I as vi,e as Xi,r as bi,s as Yi}from"./chunk-B7IX6UFG.js";import{a as Ji}from"./chunk-BPPBSQ5N.js";import{a as $i}from"./chunk-W5OI4BJ2.js";import{a as $e,b as Wi,h as Z,i as ji,j as ut,k as de,l as Ke,n as _e,o as gi,p as Me,q as pt,r as xi}from"./chunk-ZAQLF7TN.js";import{a as Ki}from"./chunk-PJQZD5QI.js";import{a as ze,c as yi}from"./chunk-AQ74ANSJ.js";import{Y as Gi}from"./chunk-OFVMJORF.js";import{a as p,b as O}from"./chunk-W3WDPWBE.js";import{q as Ni}from"./chunk-JKP4I6UL.js";import{c as hi}from"./chunk-TZHKPIVH.js";import{n as ki,q as lt,s as Ce}from"./chunk-BRWS572J.js";import{b as Hi,m as qi}from"./chunk-AKNRR36C.js";import{a as c,b as h,g as je}from"./chunk-JEGVIFEP.js";var Rt=class{constructor(){this.drawPhase=he.MAP|he.HITTEST|he.HIGHLIGHT|he.DEBUG}startup(){}shutdown(e){}};var P=class extends Rt{constructor(){super(...arguments),this.overrideStencilRef=null,this.symbologyPlane=Y.FILL,this.postProcessingEnabled=!1}postProcess(e,t){}};var At=class extends bt{};p([v(0,g)],At.prototype,"pos",void 0);var Ii=class extends le{},Ot=class extends J{};p([S(n)],Ot.prototype,"dotSize",void 0);var He=class extends J{};p([S(G)],He.prototype,"locations",void 0),p([S(n)],He.prototype,"pixelRatio",void 0),p([S(n)],He.prototype,"tileZoomFactor",void 0);var Ks=1e-6,ye=class extends St{vertex(e){let t=new q(1,0,0,0,-1,0,0,1,1).multiply(new _(e.pos.xy.divide(512),1)),i=W(this.draw.locations,t.xy),r=oe(this.instance.dotSize.divide(2),new n(1)),a=new n(0);a=a.add(k(i.a,new n(Ks)).multiply(2));let o=r.add(this.instance.dotSize),l=this.view.displayViewScreenMat3.multiply(new _(e.pos.add(.5),1)),u=new T(l.xy,a,1),m=this.instance.dotSize.divide(o),f=new n(-1).divide(r.divide(o));return o=o.multiply(this.draw.pixelRatio.multiply(this.draw.tileZoomFactor)),{glPosition:u,glPointSize:o,color:i,ratio:m,invEdgeRatio:f}}fragment(e){let t=gt(e.glPointCoord.subtract(.5)).multiply(2),i=xt(new n(0),new n(1),e.invEdgeRatio.multiply(t.subtract(e.ratio)).add(1)),r=new Le;return r.glFragColor=e.color.multiply(i),r}};p([S(Ot)],ye.prototype,"instance",void 0),p([S(He)],ye.prototype,"draw",void 0),p([S(xs)],ye.prototype,"view",void 0),p([O(0,L(At))],ye.prototype,"vertex",null),p([O(0,L(Ii))],ye.prototype,"fragment",null);var Lt=class extends Se{};p([v(3,n)],Lt.prototype,"inverseArea",void 0);var qe=class extends J{};p([S(te.ofType(T,2))],qe.prototype,"isActive",void 0),p([S(te.ofType(T,8))],qe.prototype,"colors",void 0),p([S(n)],qe.prototype,"dotValue",void 0);var Te=class extends J{};p([S(G)],Te.prototype,"dotTexture0",void 0),p([S(G)],Te.prototype,"dotTexture1",void 0),p([S(n)],Te.prototype,"tileZoomFactor",void 0),p([S(n)],Te.prototype,"pixelRatio",void 0),p([S(n)],Te.prototype,"tileDotsOverArea",void 0);var ge=class extends Ve{_dotThreshold(e,t,i){return e.divide(t).divide(i)}vertex(e){let t=new q(2/512,0,0,0,-2/512,0,-1,1,1).multiply(new _(e.pos,1)),i=this.clip(e.id),r=new T(t.xy,i,1),a=this.storage.getVVData(e.id).multiply(this.instance.isActive.get(0)).multiply(e.inverseArea),o=this.storage.getDataDrivenData0(e.id).multiply(this.instance.isActive.get(1)).multiply(e.inverseArea),l=this.draw.tileZoomFactor.multiply(512).divide(this.draw.pixelRatio),u=this._dotThreshold(a,this.instance.dotValue,this.draw.tileDotsOverArea),m=this._dotThreshold(o,this.instance.dotValue,this.draw.tileDotsOverArea),f=e.pos.add(.5).divide(l);return{glPosition:r,color:new T(0,0,0,0),textureCoords:f,thresholds0:u,thresholds1:m}}fragment(e){let t=new Le,i=W(this.draw.dotTexture0,e.textureCoords),r=W(this.draw.dotTexture1,e.textureCoords),a=e.thresholds0.subtract(i),o=e.thresholds1.subtract(r),l,u=Ae.fromColumns(this.instance.colors[0],this.instance.colors[1],this.instance.colors[2],this.instance.colors[3]),m=Ae.fromColumns(this.instance.colors[4],this.instance.colors[5],this.instance.colors[6],this.instance.colors[7]);if(this.blending){let f=k(new n(0),a),d=k(new n(0),o),y=Ye(f,a).add(Ye(d,o)),x=k(y,new n(0)),V=new n(1).subtract(x),b=y.add(x),w=a.multiply(f).divide(b),F=o.multiply(d).divide(b),U=u.multiply(w).add(m.multiply(F));l=V.multiply(U)}else{let f=oe(Pi(a),Pi(o)),d=k(f,new n(0)),y=new n(1).subtract(d),x=k(f,a),V=k(f,o),b=u.multiply(x).add(m.multiply(V));l=y.multiply(b)}return t.glFragColor=l,t}hittest(e){return Ee(this.hittestRequest)}};p([ne],ge.prototype,"blending",void 0),p([S(qe)],ge.prototype,"instance",void 0),p([S(Te)],ge.prototype,"draw",void 0),p([O(0,L(Lt))],ge.prototype,"vertex",null),p([O(0,L(le))],ge.prototype,"fragment",null);var rt={[Z.BYTE]:1,[Z.UNSIGNED_BYTE]:1,[Z.SHORT]:2,[Z.UNSIGNED_SHORT]:2,[Z.HALF_FLOAT]:2,[Z.INT]:4,[Z.UNSIGNED_INT]:4,[Z.FLOAT]:4};var Et=class{constructor(e,t){this._boundPart=null;let i=[];for(let a of t.vertex){let o=Si.createVertex(e,xi.STATIC_DRAW,a);i.push(o)}let r=[];for(let a of t.index||[]){let o=Si.createIndex(e,xi.STATIC_DRAW,a);r.push(o)}this.groups=[];for(let a of t.groups){let o;if(a.index!=null){if(!t.index)throw new Error("No index data.");let{BYTES_PER_ELEMENT:y}=t.index[a.index];y===2?o=Z.UNSIGNED_SHORT:y===4&&(o=Z.UNSIGNED_INT)}let l=a.index!=null?r[a.index]:null,u=new Map,m={},f={};for(let y of a.attributes){let{name:x,count:V,type:b,offset:w,normalized:F,divisor:U,stride:se,vertex:fe,location:N}=y,E=`vertex-buffer-${fe}`,H=m[E];H||(H=m[E]=[]);let K=new $i(x,V,b,w,se,F,U);H.push(K),u.set(x,N),f[E]=i[fe]}let d=new Cs(e,u,m,f,l);this.groups.push(h(c({},a),{vertexArray:d,locations:u,layout:m,indexing:o}))}this.parts=t.parts}bind(e,t){this._boundPart=t;let{group:i}=this.parts[this._boundPart],{vertexArray:r}=this.groups[i];e.bindVAO(r)}draw(e){if(this._boundPart==null)throw new Error("Mesh.bind() has not been called.");let{start:t,count:i}=this.parts[this._boundPart],{group:r}=this.parts[this._boundPart],{indexing:a,primitive:o}=this.groups[r];a?e.drawElements(o,i,a,t*rt[a]):e.drawArrays(o,t,i)}unbind(e){this._boundPart=null,e.bindVAO(null)}destroy(){for(let{vertexArray:e}of this.groups)e.dispose()}};var Bt=class s extends Et{static create(e,t){let i=[],{stride:r,hash:a}=t.layout;if(r==null){r=0;for(let{count:y,type:x,offset:V}of t.layout.attributes){if(V!=null)throw new Error("Stride cannot be computed automatically when attribute offsets are supplied explicitly.");r+=y*rt[x]}}let o=0,l=0;for(let{count:y,name:x,offset:V,type:b,normalized:w}of t.layout.attributes){V!=null&&(l=V);let F={name:x,location:o,vertex:0,count:y,type:b,offset:l,stride:r,divisor:0,normalized:w!=null&&w};i.push(F),o++,l+=y*rt[b]}let u={attributes:i,primitive:t.primitive};t.index!=null&&(u.index=0);let{count:m}=t;if(m==null&&(m=t.index?t.index.length:t.vertex.byteLength/r,Math.floor(m)!==m))throw new Error(`The byte length of vertex data must be an exact multiple of the stride, which is ${r}.`);let f={start:0,count:m,group:0,primitive:t.primitive},d={vertex:[t.vertex],parts:[f],groups:[u]};return t.index!=null&&(d.index=[t.index]),a==null&&(a=dt(i)),new s(e,d,{hash:a,attributes:i,stride:r})}constructor(e,t,i){super(e,t),this.layout=i}bind(e,t=0){super.bind(e,t)}};var Ut=class{constructor(){this._dotTextureSize=0,this._dotTextures=null,this._dotMesh=null}destroy(){this._disposeTextures(),this._dotFBO&&this._dotFBO.dispose(),this._dotMesh&&this._dotMesh.destroy()}getFBO(e){if(this._dotFBO==null){let t=512,i=512,r=new Re(t,i);r.samplingMode=de.NEAREST,r.wrapMode=Ke.CLAMP_TO_EDGE;let a=new Qi(e,new ct(pt.DEPTH_STENCIL,t,i));this._dotFBO=new ft(e,r,a)}return this._dotFBO}getDotDensityMesh(e){if(this._dotMesh==null){let t=512,i=t*t,r=2,a=new Int16Array(i*r);for(let u=0;u<t;u++)for(let m=0;m<t;m++)a[r*(m+u*t)]=m,a[r*(m+u*t)+1]=u;let o=[{count:2,type:Z.UNSIGNED_SHORT,name:"a_position",offset:0}],l={hash:dt(o),attributes:o,stride:4};this._dotMesh=Bt.create(e,{primitive:Wi.POINTS,vertex:a,count:i,layout:l})}return this._dotMesh}getDotDensityTextures(e,t,i){if(this._dotTextureSize===t&&this._seed===i||(this._disposeTextures(),this._dotTextureSize=t,this._seed=i),this._dotTextures===null){let r=new Hi(i);this._dotTextures=[this._allocDotDensityTexture(e,t,r),this._allocDotDensityTexture(e,t,r)]}return this._dotTextures}_disposeTextures(){if(this._dotTextures){for(let e=0;e<this._dotTextures.length;e++)this._dotTextures[e].dispose();this._dotTextures=null}}_allocDotDensityTexture(e,t,i){let r=new Float32Array(t*t*4);for(let o=0;o<r.length;o++)r[o]=i.getFloat();let a=new Re;return a.dataType=Me.FLOAT,a.samplingMode=de.NEAREST,a.width=t,a.height=t,new mt(e,a,r)}};var Ht=class extends P{constructor(){super(...arguments),this.type=I.DotDensity,this.shaders={polygon:new ge,point:new ye,fill:new _t},this._resources=new Map}render(e,t){st(e)||z(e)?this._renderPolygons(e,t):this._renderDotDensity(e,t)}_renderPolygons(e,t){let{painter:i}=e;i.setShader({shader:this.shaders.fill,uniforms:h(c({},D(e,t.target)),{visualVariableColor:null,visualVariableOpacity:null}),defines:c({},M(e)),optionalAttributes:{zoomRange:!1},useComputeBuffer:z(e)}),i.setPipelineState(C(e)),i.submitDraw(e,t)}_renderDotDensity(e,t){let{context:i,painter:r,requiredLevel:a}=e,o=t.instance.getInput().uniforms,l=this._getOrCreateResourcesRecord(i),u=l.getDotDensityTextures(i,512,o.seed),m=1/2**(a-t.target.key.level),f=512,d=f*window.devicePixelRatio*f*window.devicePixelRatio,y=1/m*(1/m),x=o.dotScale?e.state.scale/o.dotScale:1,V=o.dotValue*x*y;r.setShader({shader:this.shaders.polygon,uniforms:h(c({},D(e,t.target)),{instance:{isActive:o.isActive,colors:o.colors,dotValue:Math.max(1,V)},draw:{dotTexture0:{unit:bi,texture:u[0]},dotTexture1:{unit:Yi,texture:u[1]},tileZoomFactor:m,pixelRatio:window.devicePixelRatio,tileDotsOverArea:d/(512*window.devicePixelRatio*512*window.devicePixelRatio)}}),defines:h(c({},M(e)),{blending:o.blending}),optionalAttributes:{},useComputeBuffer:!1}),r.setPipelineState(C(e));let b=i.getViewport();i.setViewport(0,0,512,512);let w=i.getBoundFramebufferObject(),F=l.getFBO(i);i.bindFramebuffer(F),i.setClearColor(0,0,0,0),r.setPipelineState({color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1}),r.updatePipelineState(i),i.clear($e.COLOR_BUFFER_BIT),r.submitDraw(e,t),i.bindFramebuffer(w),i.setViewport(b.x,b.y,b.width,b.height);let U=l.getFBO(i).colorTexture;r.setShader({shader:this.shaders.point,uniforms:{view:Rs(e,t.target),instance:{dotSize:o.dotSize},draw:{locations:{unit:bi,texture:U},tileZoomFactor:1,pixelRatio:window.devicePixelRatio}},defines:c({},M(e)),optionalAttributes:{},useComputeBuffer:!1}),r.setPipelineState({color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1}),r.submitDrawMesh(i,l.getDotDensityMesh(i))}shutdown(e){super.shutdown(e),this._resources.get(e)?.destroy(),this._resources.delete(e)}_getOrCreateResourcesRecord(e){let t=this._resources.get(e);return t==null&&(t=new Ut,this._resources.set(e,t)),t}};var qt=class extends P{constructor(){super(...arguments),this.type=I.ComplexFill,this.shaders={geometry:new ws}}render(e,t){let{context:i,painter:r}=e,a=t.instance.getInput();r.setShader({shader:this.shaders.geometry,uniforms:h(c(c({},R(e,t.target,a.uniforms)),D(e,t.target)),{mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:we(t.target)}),defines:c({},M(e)),optionalAttributes:a.optionalAttributes,useComputeBuffer:z(e)}),r.setPipelineState(C(e)),r.submitDraw(e,t)}};function ce(s){let e=1/s;return{antialiasing:e,blur:0+e}}var kt=class extends P{constructor(){super(...arguments),this.type=I.ComplexOutlineFill,this.shaders={geometry:new Ds}}render(e,t){let{context:i,painter:r,pixelRatio:a}=e,o=t.instance.getInput();r.setShader({shader:this.shaders.geometry,uniforms:h(c(c({},R(e,t.target,o.uniforms)),D(e,t.target)),{antialiasingControls:ce(a),mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:we(t.target)}),defines:c({},M(e)),optionalAttributes:o.optionalAttributes,useComputeBuffer:z(e)}),r.setPipelineState(C(e)),r.submitDraw(e,t)}};var Nt=class extends P{constructor(){super(...arguments),this.type=I.Fill,this.shaders={geometry:new _t}}render(e,t){let{painter:i}=e,r=t.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:c(c({},R(e,t.target,r.uniforms)),D(e,t.target)),defines:M(e),optionalAttributes:r.optionalAttributes,useComputeBuffer:z(e)}),i.setPipelineState(C(e)),i.submitDraw(e,t)}};var Gt=class extends P{constructor(){super(...arguments),this.type=I.OutlineFill,this.shaders={geometry:new _s}}render(e,t){let{painter:i,pixelRatio:r}=e,a=t.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:h(c(c({},R(e,t.target,a.uniforms)),D(e,t.target)),{antialiasingControls:ce(r)}),defines:c({},M(e)),optionalAttributes:a.optionalAttributes,useComputeBuffer:z(e)}),i.setPipelineState(C(e)),i.submitDraw(e,t)}};var Wt=class extends P{constructor(){super(...arguments),this.type=I.PatternFill,this.shaders={geometry:new Ms}}render(e,t){let{context:i,painter:r}=e,a=t.instance.getInput();r.setShader({shader:this.shaders.geometry,uniforms:h(c(c({},R(e,t.target,a.uniforms)),D(e,t.target)),{mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:we(t.target)}),defines:c({},M(e)),optionalAttributes:a.optionalAttributes,useComputeBuffer:z(e)}),r.setPipelineState(C(e)),r.submitDraw(e,t)}};var jt=class extends P{constructor(){super(...arguments),this.type=I.PatternOutlineFill,this.shaders={geometry:new Ps}}render(e,t){let{context:i,painter:r,pixelRatio:a}=e,o=t.instance.getInput();r.setShader({shader:this.shaders.geometry,uniforms:h(c(c({},R(e,t.target,o.uniforms)),D(e,t.target)),{antialiasingControls:ce(a),mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:we(t.target)}),defines:c({},M(e)),optionalAttributes:o.optionalAttributes,useComputeBuffer:z(e)}),r.setPipelineState(C(e)),r.submitDraw(e,t)}};var $t=class{constructor(e,t,i,r){this.dataType=e,this.samplingMode=t,this.pixelFormat=i,this.internalFormat=r}};function As(s,e){let{textureFloatLinear:t,colorBufferFloat:i}=s.capabilities,r=i?.textureFloat,a=i?.textureHalfFloat,o=i?.floatBlend,l=s.driverTest.floatBufferBlend.result;if(!r&&!a)throw new Ce("heatmap:missing-color-buffer-float","HeatmapRenderer requires the WebGL extension EXT_color_buffer_float or EXT_color_buffer_half_float or WEBGL_color_buffer_float.");if(!(o&&l||a))throw new Ce("heatmap:missing-float-blend","HeatmapRenderer requires the WebGL extension EXT_float_blend or EXT_color_buffer_half_float."+(l?"":" This device claims support for EXT_float_blend, but does not actually support it."));let u=r&&o&&l,m=a,f=t,d=!!i?.R32F,y=!!i?.R16F;if(u&&f)return f||e.warnOnce("Missing WebGL extension OES_texture_float_linear. Heatmap quality may be reduced."),new $t(Me.FLOAT,f?de.LINEAR:de.NEAREST,d?_e.RED:_e.RGBA,d?gi.R32F:_e.RGBA);if(m)return new $t(Me.HALF_FLOAT,de.LINEAR,y?_e.RED:_e.RGBA,y?gi.R16F:_e.RGBA);throw new Ce("heatmap:missing-hardware-support","HeatmapRenderer requires WebGL extensions that allow it to render and blend to float or half float textures.")}var Zs=()=>lt.getLogger("esri.views.2d.engine.webgl.shaderGraph.techniques.heatmap.HeatmapResources"),Kt=class{destroy(){this._accumulateFramebuffer=hi(this._accumulateFramebuffer),this._resolveGradientTexture=hi(this._resolveGradientTexture),this._prevGradientHash=null,this._qualityProfile=null}get initialized(){return this._accumulateFramebuffer!=null&&this._resolveGradientTexture!=null}get accumulateFramebuffer(){return this._accumulateFramebuffer}get resolveGradientTexture(){return this._resolveGradientTexture}loadQualityProfile(e){if(this._qualityProfile==null){let t=As(e,Zs());this._qualityProfile=h(c({},t),{defines:{usesHalfFloatPrecision:t.dataType!==Me.FLOAT}})}return this._qualityProfile}ensureAccumulateFBO(e,t,i){if(this._accumulateFramebuffer==null){let{dataType:r,samplingMode:a,pixelFormat:o,internalFormat:l}=this.loadQualityProfile(e),u=new Re(t,i);u.pixelFormat=o,u.internalFormat=l,u.dataType=r,u.samplingMode=a,u.wrapMode=Ke.CLAMP_TO_EDGE;let m=new ct(pt.DEPTH_STENCIL,t,i);this._accumulateFramebuffer=new ft(e,u,m)}else{let{width:r,height:a}=this._accumulateFramebuffer;r===t&&a===i||this._accumulateFramebuffer.resize(t,i)}return this._accumulateFramebuffer}ensureResolveGradientTexture(e,t,i){if(this._resolveGradientTexture==null){let r=new Re;r.wrapMode=Ke.CLAMP_TO_EDGE,this._resolveGradientTexture=new mt(e,r)}else this._prevGradientHash!==t&&(this._resolveGradientTexture.resize(i.length/4,1),this._resolveGradientTexture.setData(i),this._prevGradientHash=t);return this._resolveGradientTexture}};function Zt(s){return s?.25:1}var Xt=class extends Se{};p([v(5,g)],Xt.prototype,"offset",void 0);var Ci=class extends le{},at=class extends J{};p([S(n)],at.prototype,"radius",void 0),p([S(n)],at.prototype,"isFieldActive",void 0);var Fe=class extends Ve{constructor(){super(...arguments),this.usesHalfFloatPrecision=!1}vertex(e){let{radius:t,isFieldActive:i}=this.kernelControls,r=e.offset,a=i.multiply(this.storage.getVVData(e.id).x).add(new n(1).subtract(i)),o=this.view.displayViewScreenMat3.multiply(new _(e.pos,1)).add(this.view.displayViewMat3.multiply(new _(r,0)).multiply(t)),l=this.clip(e.id);return c({glPosition:new T(o.xy,l,1),offset:r,fieldValue:a,color:new T(0)},this.maybeRunHittest(e,{},null))}fragment(e){let{offset:t,fieldValue:i}=e,r=gt(t),a=k(r,new n(1)),o=new n(1).subtract(r.multiply(r)),l=o.multiply(o),u=a.multiply(l).multiply(i).multiply(new n(Zt(this.usesHalfFloatPrecision)));return this.getFragmentOutput(new T(u),e)}hittest(e){let{viewMat3:t,tileMat3:i}=this.view,r=t.multiply(i).multiply(new _(e.pos,1));return vs(r.xy,this.kernelControls.radius,this.hittestRequest.position)}};p([ne],Fe.prototype,"usesHalfFloatPrecision",void 0),p([S(at)],Fe.prototype,"kernelControls",void 0),p([O(0,L(Xt))],Fe.prototype,"vertex",null),p([O(0,L(Ci))],Fe.prototype,"fragment",null);var Yt=class extends bt{};p([v(0,g)],Yt.prototype,"pos",void 0);var Ri=class extends ys{},ke=class extends J{};p([S(G)],ke.prototype,"texture",void 0),p([S(g)],ke.prototype,"minAndInvRange",void 0),p([S(n)],ke.prototype,"normalization",void 0);var Qt=class extends J{};p([S(G)],Qt.prototype,"texture",void 0);var xe=class extends St{constructor(){super(...arguments),this.usesHalfFloatPrecision=!1}vertex(e){return{glPosition:new T(e.pos.multiply(2).subtract(1),1,1),uv:e.pos}}fragment(e){let{accumulatedDensity:t,gradient:i}=this,r=W(t.texture,e.uv).r.multiply(new n(Zt(this.usesHalfFloatPrecision)));r=r.multiply(t.normalization),r=r.subtract(t.minAndInvRange.x).multiply(t.minAndInvRange.y);let a=W(i.texture,new g(r,.5)),o=new Le;return o.glFragColor=new T(a.rgb.multiply(a.a),a.a),o}};p([ne],xe.prototype,"usesHalfFloatPrecision",void 0),p([S(ke)],xe.prototype,"accumulatedDensity",void 0),p([S(Qt)],xe.prototype,"gradient",void 0),p([O(0,L(Yt))],xe.prototype,"vertex",null),p([O(0,L(Ri))],xe.prototype,"fragment",null);var Jt=class extends P{constructor(){super(...arguments),this.type=I.Heatmap,this.shaders={accumulate:new Fe,resolve:new xe},this.postProcessingEnabled=!0,this._isBound=!1,this._resources=new Map,this.overrideStencilRef=Ls}shutdown(e){super.shutdown(e),this._resources.get(e)?.destroy(),this._resources.delete(e),this._prevFBO=null,this._unbind()}render(e,t){let{context:i,painter:r,state:a}=e,o=t.instance.getInput(),{isFieldActive:l}=o.uniforms,u=this._getOrCreateResourcesRecord(i),m=u.loadQualityProfile(i);if(st(e))return;z(e)||this._bind(e,u,o),r.setShader({shader:this.shaders.accumulate,uniforms:h(c({},D(e,t.target)),{kernelControls:{radius:Os(o,a),isFieldActive:l?1:0}}),defines:c(c({},M(e)),m.defines),optionalAttributes:{},useComputeBuffer:z(e)});let f=z(e)?Ys:Es;r.setPipelineState(f),r.submitDraw(e,t)}postProcess(e,t){if(z(e)||st(e))return;let{context:i,painter:r}=e,a=this._resources.get(i);if(this._prevFBO==null||this._prevViewport==null||!a?.initialized)return;let{defines:o}=a.loadQualityProfile(i),{minDensity:l,maxDensity:u,radius:m}=t.getInput().uniforms,f=8,d=9,y=a.accumulateFramebuffer,x=a.resolveGradientTexture;r.setShader({shader:this.shaders.resolve,uniforms:{accumulatedDensity:{texture:{unit:f,texture:y.colorTexture},minAndInvRange:[l,1/(u-l)],normalization:3/(m*m*Math.PI)},gradient:{texture:{unit:d,texture:x}}},defines:o,optionalAttributes:{},useComputeBuffer:!1}),i.bindFramebuffer(this._prevFBO),i.setViewport(0,0,this._prevViewport.width,this._prevViewport.height),i.bindTexture(y.colorTexture,f),i.bindTexture(x,d),r.setPipelineState(Qs),r.submitDrawQuad(i),this._unbind()}_getOrCreateResourcesRecord(e){let t=this._resources.get(e);return t==null&&(t=new Kt,this._resources.set(e,t)),t}_unbind(){this._prevFBO=null,this._prevViewport=null,this._isBound=!1}_bind(e,t,i){if(this._isBound)return;let{context:r,state:a,pixelRatio:o}=e,l=r.getBoundFramebufferObject(),u=r.getViewport();this._prevFBO=l,this._prevViewport=u;let{gradient:m,gradientHash:f}=i.uniforms;t.ensureResolveGradientTexture(r,f,m);let{width:d,height:y}=u,x=Xs(Os(i,a),o),V=d*x,b=y*x,w=t.ensureAccumulateFBO(r,V,b);r.blitFramebuffer(l,w,0,0,l.width,l.height,0,0,w.width,w.height,$e.STENCIL_BUFFER_BIT,de.NEAREST),r.bindFramebuffer(w),r.setViewport(0,0,w.width,w.height),r.setColorMask(!0,!0,!0,!0),r.setClearColor(0,0,0,0),r.clear($e.COLOR_BUFFER_BIT),this._isBound=!0}};function Xs(s,e){let t=e>1.5?.25:.5;return s<1/(2*t)?1:t}function Ls(s){return s.key.level+1}var Es={color:{write:[!0,!0,!0,!0],blendMode:"additive"},depth:!1,stencil:{write:!1,test:{ref:Ls,compare:ji.GEQUAL,mask:255,op:{fail:ut.KEEP,zFail:ut.KEEP,zPass:ut.REPLACE}}}},Ys=h(c({},Es),{stencil:!1}),Qs={color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1};function Os(s,e){let{referenceScale:t,radius:i}=s.uniforms;return i*(t!==0?t/e.scale:1)}var De=class extends J{getVVRotationMat4(e){return X(Mi(e),Ae.identity(),()=>{let t=this._getNormalizedAngle(e).multiply(Vi),i=_i(t),r=Fi(t);return new Ae(r,i,0,0,i.multiply(new n(-1)),r,0,0,0,0,1,0,0,0,0,1)})}getVVRotationMat3(e){return X(Mi(e),q.identity(),()=>{let t=this._getNormalizedAngle(e).multiply(Vi),i=_i(t),r=Fi(t);return new q(r,i,0,i.multiply(new n(-1)),r,0,0,0,1)})}_getNormalizedAngle(e){let t=Oe(this.rotationType,new n(Ze.Arithmatic));return X(t,new n(90).subtract(e),e)}};p([S(n)],De.prototype,"rotationType",void 0);var Js=360/254,ee=class extends Se{};p([v(3,T)],ee.prototype,"color",void 0),p([v(4,g)],ee.prototype,"offset",void 0),p([v(5,g)],ee.prototype,"textureUV",void 0),p([v(6,n)],ee.prototype,"fontSize",void 0),p([v(7,n)],ee.prototype,"referenceSize",void 0),p([v(8,n)],ee.prototype,"haloFontSize",void 0),p([v(9,T)],ee.prototype,"haloColor",void 0),p([v(10,g)],ee.prototype,"zoomRange",void 0),p([v(11,n)],ee.prototype,"clipAngle",void 0),p([v(12,T)],ee.prototype,"referenceSymbol",void 0);var ot=class extends vt{};p([v(13,g)],ot.prototype,"offsetNextVertex1",void 0),p([v(14,g)],ot.prototype,"offsetNextVertex2",void 0);var Ai=class extends le{},B=class extends Ve{constructor(){super(...arguments),this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"]},this.isHaloPass=!1,this.isBackgroundPass=!1,this.isLabel=!1}clipLabel(e,t,i){let r=t.multiply(Js),a=yt(this.view.rotation.subtract(r)),o=Qe(new n(360).subtract(a),a),l=new n(0),u=ds(this.view.currentZoom.multiply(vi)).divide(vi),m=e.x,f=e.y,d=new n(1).subtract(k(m,u)).multiply(2),y=k(new n(90),o).multiply(2),x=new n(2).multiply(new n(1).subtract(k(u,f)));return l=l.add(i.multiply(d)),l=l.add(i.multiply(y)),l=l.add(x),l}vertex(e,t){let i=ie(e.bitset,ns),r=new n(1).subtract(i),a=e.fontSize,o=a.divide(wi),l=this.isHaloPass?e.haloColor:this._getVertexColor(e),u=this.isLabel?this.storage.getAnimationValue(e.id):new n(1),m=this.isLabel?l.multiply(u):l,f=this.view.displayViewScreenMat3.multiply(new _(e.pos,1)),d=e.offset,y=new n(1),x=q.identity(),V=new g(0);if(this.isLabel){if(!e.referenceSymbol)throw new Error("InternalError: Optional attribute 'referenceSymbol' expected for labels");let E=e.referenceSymbol,H=E.xy,K=E.z,A=this._unpackDirection(E.w),fi=et(this,e.id,K).divide(2),di=A.multiply(fi.add(Xi));V=H.add(di),d=d.add(V)}else y=et(this,e.id,e.referenceSize).divide(e.referenceSize),a=a.multiply(y),o=o.multiply(y),d=d.multiply(y),x=zt(this,e.id),d=x.multiply(new _(d,0)).xy;let b=ie(e.bitset,ls),w=this._getViewRotationMatrix(b).multiply(new _(d,0)),F=this.isLabel?this.clipLabel(e.zoomRange,e.clipAngle,b):this.clip(e.id,e.zoomRange);F=this.isBackgroundPass?F.add(r.multiply(2)):F.add(i.multiply(2));let U=this.isLabel?ms(ve(F,new n(1)),Oe(u,new n(0))):new Ti(!1),se=new T(f.xy.add(w.xy),F,1),fe=e.textureUV.divide(this.mosaicInfo.size),N=new n(0);return this.isHaloPass&&(N=e.haloFontSize.divide(o).divide(ss)),c({glPosition:se,color:m,size:o,textureUV:fe,antialiasingWidth:new n(.105*wi).divide(a).divide(this.view.pixelRatio),haloDistanceOffset:N},this.maybeRunHittest(e,t,{vvSizeAdjustment:y,vvRotation:x,labelOffset:V,labelClipped:U}))}_getViewRotationMatrix(e){let t=this.view.displayViewMat3,i=this.view.displayMat3,r=new n(1).subtract(e);return t.multiply(e).add(i.multiply(r))}fragment(e){let t=new n(.25),i=new n(1).subtract(t),r=W(this.mosaicInfo.texture,e.textureUV).a,a=i.subtract(e.haloDistanceOffset);this.highlight&&(a=a.divide(2));let o=e.antialiasingWidth,l=xt(a.subtract(o),a.add(o),r);return this.getFragmentOutput(e.color.multiply(l),e)}hittest(e,t,{vvSizeAdjustment:i,vvRotation:r,labelOffset:a,labelClipped:o}){let l,u,m;this.isLabel?(l=new _(e.offset.add(a),0),u=new _(t.offsetNextVertex1.add(a),0),m=new _(t.offsetNextVertex2.add(a),0)):(l=r.multiply(new _(e.offset.multiply(i),0)),u=r.multiply(new _(t.offsetNextVertex1.multiply(i),0)),m=r.multiply(new _(t.offsetNextVertex2.multiply(i),0)));let{viewMat3:f,tileMat3:d}=this.view,y=f.multiply(d).multiply(new _(e.pos,1)),x=y.add(d.multiply(l)).xy,V=y.add(d.multiply(u)).xy,b=y.add(d.multiply(m)).xy,w=wt(this.hittestRequest.position,x.xy,V.xy,b.xy);return this.isLabel?X(o,Ee(this.hittestRequest),w):w}_unpackDirection(e){let t=new ht(e),i=us(t,new ht(2)),r=ps(t,new ht(3));return new g(new n(i).subtract(1),new n(r).subtract(1))}_getVertexColor(e){let t=e.color;if(this.visualVariableColor){let i=this.storage.getColorValue(e.id);t=this.visualVariableColor.getColor(i,e.color,new Ti(!1))}if(this.visualVariableOpacity){let i=this.storage.getOpacityValue(e.id),r=this.visualVariableOpacity.getOpacity(i);t=t.multiply(r)}return t}};p([j(Tt)],B.prototype,"visualVariableColor",void 0),p([j(Ft)],B.prototype,"visualVariableOpacity",void 0),p([j(De)],B.prototype,"visualVariableRotation",void 0),p([j(Mt)],B.prototype,"visualVariableSizeMinMaxValue",void 0),p([j(Pt)],B.prototype,"visualVariableSizeScaleStops",void 0),p([j(Dt)],B.prototype,"visualVariableSizeStops",void 0),p([j(It)],B.prototype,"visualVariableSizeUnitValue",void 0),p([S(Be)],B.prototype,"mosaicInfo",void 0),p([ne],B.prototype,"isHaloPass",void 0),p([ne],B.prototype,"isBackgroundPass",void 0),p([ne],B.prototype,"isLabel",void 0),p([O(0,L(ee)),O(1,L(ot))],B.prototype,"vertex",null),p([O(0,L(Ai))],B.prototype,"fragment",null);var ei=class extends P{constructor(){super(...arguments),this.type=I.Label,this.shaders={geometry:new B},this.drawPhase=he.LABEL|he.LABEL_ALPHA|he.HITTEST,this.symbologyPlane=Y.TEXT}render(e,t){let{context:i,painter:r}=e,a=M(e),o=c({},C(e)),l=t.instance.getInput(),u={shader:this.shaders.geometry,uniforms:h(c(c({},R(e,t.target,l.uniforms)),D(e,t.target)),{mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey)}),defines:h(c({},a),{isHaloPass:!1,isBackgroundPass:!0,isLabel:!0}),optionalAttributes:l.optionalAttributes,useComputeBuffer:z(e)};r.setShader(u),r.setPipelineState(o),r.submitDraw(e,t),r.setShader(h(c({},u),{defines:h(c({},a),{isHaloPass:!0,isBackgroundPass:!1,isLabel:!0})})),r.setPipelineState(o),r.submitDraw(e,t),r.setShader(h(c({},u),{defines:h(c({},a),{isHaloPass:!1,isBackgroundPass:!1,isLabel:!0})})),r.setPipelineState(o),r.submitDraw(e,t)}};var ti=class extends P{constructor(){super(...arguments),this.type=I.Line,this.shaders={geometry:new Ct},this.symbologyPlane=Y.LINE}render(e,t){let{painter:i,pixelRatio:r}=e,a=t.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:h(c(c({},R(e,t.target,a.uniforms)),D(e,t.target)),{antialiasingControls:ce(r)}),defines:c({},M(e)),optionalAttributes:a.optionalAttributes,useComputeBuffer:z(e)}),i.setPipelineState(C(e)),i.submitDraw(e,t)}};var Ne=class extends Ts{};p([v(9,n)],Ne.prototype,"accumulatedDistance",void 0),p([v(10,g)],Ne.prototype,"segmentDirection",void 0),p([v(11,T)],Ne.prototype,"tlbr",void 0);var Ge=class extends Ct{_getLineWidthRatio(e,t){let i=new n(15.5),r=ie(e.bitset,as);return r.multiply(oe(t,new n(.25))).add(new n(1).subtract(r)).divide(i)}_getSDFAlpha(e){let{halfWidth:t,normal:i,tlbr:r,patternSize:a,accumulatedDistance:o,lineWidthRatio:l}=e,u=a.x.multiply(new n(2)).multiply(l),m=zi(o.divide(u)),f=new n(.25).multiply(i.y).add(new n(.5)),d=Je(r.xy,r.zw,new g(m,f)),y=Vt(W(this.mosaicInfo.texture,d)).subtract(new n(.5)).multiply(t),x=Xe(new n(.5).subtract(y),new n(0),new n(1));return new T(x)}_getPatternColor(e){let{halfWidth:t,normal:i,color:r,accumulatedDistance:a,patternSize:o,sampleAlphaOnly:l,tlbr:u}=e,m=o.y.multiply(new n(2).multiply(t).divide(o.x)),f=zi(a.divide(m)),d=new n(.5).multiply(i.y).add(new n(.5)),y=Je(u.xy,u.zw,new g(d,f)),x=W(this.mosaicInfo.texture,y);return this.visualVariableColor!=null&&(x=X(ve(l,new n(.5)),new T(r.a),r)),x}vertex(e,t){let{segmentDirection:i,tlbr:r,bitset:a}=e,o=zs(this,e),l=e.accumulatedDistance.divide(this.view.displayZoomFactor).add(Ye(i,o.scaledOffset)),u=new g(r.z.subtract(r.x),r.w.subtract(r.y)),m=r.divide(this.mosaicInfo.size.xyxy),f=ie(a,os),d=ie(a,rs),y=X(ve(f,new n(.5)),this._getLineWidthRatio(e,o.scaledHalfWidth),new n(1));return c(h(c({},o),{tlbr:m,patternSize:u,accumulatedDistance:l,isSDF:f,sampleAlphaOnly:d,lineWidthRatio:y}),this.maybeRunHittest(e,t,o.halfWidth))}fragment(e){let{color:t,opacity:i,isSDF:r}=e,a=Fs(e,this.antialiasingControls.blur),o=X(ve(r,new n(.5)),this._getSDFAlpha(e),this._getPatternColor(e)),l=t.multiply(i).multiply(a).multiply(o);return this.getFragmentOutput(l,e)}};p([S(Be)],Ge.prototype,"mosaicInfo",void 0),p([O(0,L(Ne)),O(1,L(bs))],Ge.prototype,"vertex",null);var ii=class extends P{constructor(){super(...arguments),this.type=I.TexturedLine,this.shaders={geometry:new Ge},this.symbologyPlane=Y.LINE}render(e,t){let{context:i,painter:r,pixelRatio:a}=e,o=t.instance.getInput();r.setShader({shader:this.shaders.geometry,uniforms:h(c(c({},R(e,t.target,o.uniforms)),D(e,t.target)),{antialiasingControls:ce(a),mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey)}),defines:c({},M(e)),optionalAttributes:o.optionalAttributes,useComputeBuffer:z(e)}),r.setPipelineState(C(e)),r.submitDraw(e,t)}};var re=class extends Se{};p([v(3,T)],re.prototype,"color",void 0),p([v(4,T)],re.prototype,"outlineColor",void 0),p([v(5,g)],re.prototype,"offset",void 0),p([v(6,g)],re.prototype,"textureUV",void 0),p([v(7,T)],re.prototype,"sizing",void 0),p([v(8,n)],re.prototype,"placementAngle",void 0),p([v(9,n)],re.prototype,"sizeRatio",void 0),p([v(10,g)],re.prototype,"zoomRange",void 0);var Ie=class extends vt{};p([v(12,g)],Ie.prototype,"offsetNextVertex1",void 0),p([v(13,g)],Ie.prototype,"offsetNextVertex2",void 0),p([v(14,g)],Ie.prototype,"textureUVNextVertex1",void 0),p([v(15,g)],Ie.prototype,"textureUVNextVertex2",void 0);var Li=class extends le{};function be(s,e,t,i){return e.multiply(s.x).add(t.multiply(s.y)).add(i.multiply(s.z))}function Oi(s){return s.multiply(s).divide(128)}var Q=class extends Ve{constructor(){super(...arguments),this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"],textureUV:["textureUVNextVertex1","textureUVNextVertex2"]}}vertex(e,t){let i=Oi(e.sizing.x),r=Oi(e.sizing.y),a=Oi(e.sizing.z),o=e.placementAngle,l=ie(e.bitset,Ue.bitset.isSDF),u=ie(e.bitset,Ue.bitset.isMapAligned),m=ie(e.bitset,Ue.bitset.scaleSymbolsProportionally),f=gs(e.bitset,Ue.bitset.colorLocked),d=Vs(this,e.id),y=Ss(this,e.id,e.color,f).multiply(d),x=this.view.displayViewScreenMat3.multiply(new _(e.pos.xy,1)),V=et(this,e.id,a).divide(a),b=i.multiply(V),w=e.offset.xy.multiply(V),F=r.multiply(m.multiply(V.subtract(1)).add(1));F=Qe(F,oe(b.subtract(.99),new n(0)));let U=oe(F,new n(1)),se=Qe(F,new n(1)),fe=q.fromRotation(o.multiply(ts)),N=zt(this,e.id),E=this._getViewRotationMatrix(u).multiply(N).multiply(fe).multiply(new _(w.xy,0)),H=this.clip(e.id,e.zoomRange),K=new T(x.xy.add(E.xy),H,1),A=e.textureUV.divide(this.mosaicInfo.size),fi=e.outlineColor.multiply(se),di=ie(e.bitset,Ue.bitset.overrideOutlineColor),Ui=e.sizeRatio.multiply(b).multiply(.5);return c({glPosition:K,color:y,textureUV:A,outlineColor:fi,outlineSize:U,distanceToPx:Ui,isSDF:l,overrideOutlineColor:di},this.maybeRunHittest(e,t,{pos:e.pos,size:b,sizeCorrection:V,isMapAligned:u,outlineSize:U,distanceToPx:Ui,isSDF:l}))}fragment(e){let t=this._getColor(e.textureUV,e);return this.getFragmentOutput(t,e)}hittest(e,t,i){return X(cs(i.size,this.hittestRequest.smallSymbolSizeThreshold),this._hittestSmallMarker(e,t,i),this._hittestMarker(e,t,i))}_getViewRotationMatrix(e){let t=this.view.displayViewMat3,i=this.view.displayMat3,r=new n(1).subtract(e);return t.multiply(e).add(i.multiply(r))}_getViewScreenMatrix(e){let t=this.view.viewMat3.multiply(this.view.tileMat3),i=this.view.tileMat3,r=new n(1).subtract(e);return t.multiply(e).add(i.multiply(r))}_getColor(e,t){return X(Oe(t.isSDF,new n(1)),this._getSDFColor(e,t),this._getSpriteColor(e,t))}_getSpriteColor(e,t){return W(this.mosaicInfo.texture,e).multiply(t.color)}_getSDFColor(e,t){let i=W(this.mosaicInfo.texture,e),r=new n(.5).subtract(Vt(i)).multiply(t.distanceToPx).multiply(is),a=Xe(new n(.5).subtract(r),new n(0),new n(1)),o=t.color.multiply(a),l=t.outlineSize;this.highlight&&(l=oe(l,t.overrideOutlineColor.multiply(4)));let u=l.multiply(.5),m=yt(r).subtract(u),f=Xe(new n(.5).subtract(m),new n(0),new n(1)),d=Je(t.outlineColor,t.color,t.overrideOutlineColor).multiply(f);return new n(1).subtract(d.a).multiply(o).add(d)}_hittestSmallMarker(e,t,i){let{position:r,distance:a,smallSymbolDistance:o}=this.hittestRequest,l=a.subtract(o),{viewMat3:u,tileMat3:m}=this.view,f=u.multiply(m).multiply(new _(i.pos,1)).xy,d=i.size.multiply(.5);return fs(f,r).subtract(d).add(l)}_hittestMarker(e,t,i){let{pos:r,sizeCorrection:a,isMapAligned:o}=i,l=new _(e.offset.multiply(a),0),u=new _(t.offsetNextVertex1.multiply(a),0),m=new _(t.offsetNextVertex2.multiply(a),0),{viewMat3:f,tileMat3:d}=this.view,y=f.multiply(d).multiply(new _(r,1)),x=this._getViewScreenMatrix(o),V=y.add(x.multiply(l)).xy,b=y.add(x.multiply(u)).xy,w=y.add(x.multiply(m)).xy,F=this.hittestRequest.position,U=this.hittestRequest.distance,se=wt(F,r,b,w);return X(ve(se,U),se,this._hittestSamples(V,b,w,e,t,i))}_hittestSamples(e,t,i,r,a,o){let{outlineSize:l,isSDF:u,distanceToPx:m}=o,f=this.hittestRequest.position,d=this.hittestRequest.distance,y=pe(f.add(new g(Pe(d),Pe(d))),e,t,i),x=pe(f.add(new g(0,Pe(d))),e,t,i),V=pe(f.add(new g(d,Pe(d))),e,t,i),b=pe(f.add(new g(Pe(d),0)),e,t,i),w=pe(f,e,t,i),F=pe(f.add(new g(d,0)),e,t,i),U=pe(f.add(new g(Pe(d),d)),e,t,i),se=pe(f.add(new g(0,d)),e,t,i),fe=pe(f.add(new g(d,d)),e,t,i),N=r.textureUV.divide(this.mosaicInfo.size),E=a.textureUVNextVertex1.divide(this.mosaicInfo.size),H=a.textureUVNextVertex2.divide(this.mosaicInfo.size),K={color:new T(1),outlineColor:new T(1),overrideOutlineColor:new n(1),outlineSize:l,distanceToPx:m,isSDF:u},A=new n(0);return A=A.add(ue(y).multiply(this._getColor(be(y,N,E,H),K).a)),A=A.add(ue(x).multiply(this._getColor(be(x,N,E,H),K).a)),A=A.add(ue(V).multiply(this._getColor(be(V,N,E,H),K).a)),A=A.add(ue(b).multiply(this._getColor(be(b,N,E,H),K).a)),A=A.add(ue(w).multiply(this._getColor(be(w,N,E,H),K).a)),A=A.add(ue(F).multiply(this._getColor(be(F,N,E,H),K).a)),A=A.add(ue(U).multiply(this._getColor(be(U,N,E,H),K).a)),A=A.add(ue(se).multiply(this._getColor(be(se,N,E,H),K).a)),A=A.add(ue(fe).multiply(this._getColor(be(fe,N,E,H),K).a)),k(A,new n(.05)).multiply(Ee(this.hittestRequest))}};p([j(Tt)],Q.prototype,"visualVariableColor",void 0),p([j(Ft)],Q.prototype,"visualVariableOpacity",void 0),p([j(De)],Q.prototype,"visualVariableRotation",void 0),p([j(Mt)],Q.prototype,"visualVariableSizeMinMaxValue",void 0),p([j(Pt)],Q.prototype,"visualVariableSizeScaleStops",void 0),p([j(Dt)],Q.prototype,"visualVariableSizeStops",void 0),p([j(It)],Q.prototype,"visualVariableSizeUnitValue",void 0),p([S(Be)],Q.prototype,"mosaicInfo",void 0),p([O(0,L(re)),O(1,L(Ie))],Q.prototype,"vertex",null),p([O(0,L(Li))],Q.prototype,"fragment",null);var si=class extends P{constructor(){super(...arguments),this.type=I.Marker,this.shaders={geometry:new Q},this.symbologyPlane=Y.MARKER}render(e,t){let{context:i,painter:r}=e,a=t.instance.getInput();r.setShader({shader:this.shaders.geometry,uniforms:h(c(c({},R(e,t.target,a.uniforms)),D(e,t.target)),{mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey,!0)}),defines:c({},M(e)),optionalAttributes:a.optionalAttributes,useComputeBuffer:z(e)}),r.setPipelineState(C(e)),r.submitDraw(e,t)}};var ri=class{constructor(){this.computeAttributes={}}get locationsMap(){let e=new Map;for(let t in this.locations)e.set(t,this.locations[t].index);return e}get optionPropertyKeys(){if(!this._optionPropertyKeys){let e=new Set(Object.keys(this.options));this._optionPropertyKeys=e}return this._optionPropertyKeys}get _transformFeedbackBindings(){return[]}get locationInfo(){if(!this._locationInfo){let e=this.locationsMap,t=Array.from(e.entries()).map(([r,a])=>`${r}.${a}`).join("."),i=ki(t);this._locationInfo={hash:i,locations:e,computeAttributeMap:this.computeAttributes}}return this._locationInfo}get renamedLocationsMap(){let e=new Map;for(let[t,i]of this.locationsMap.entries())e.set("a_"+t,i);return e}getShaderKey(e,t,i){return`${Object.keys(e).map(r=>`${r}.${e[r]}`).join(".")}.${Object.keys(i).filter(r=>i[r]).map(r=>`${r}_${i[r].toString()}`).join(".")}.${Object.keys(t).filter(r=>this.optionPropertyKeys.has(r)).join(".")}`}getProgram(e,t,i,r){let a="",o="";for(let l in i)if(i[l]){let u=typeof i[l]=="boolean"?`#define ${l}
`:`#define ${l} ${i[l]}
`;a+=u,o+=u}return a+=this.vertexShader,o+=this.fragmentShader,new hs(a,o,this.renamedLocationsMap,this.locationInfo,this._getUniformBindings(t),this._transformFeedbackBindings)}_getUniformBindings(e){let t=[];for(let i in this.required){let r=this.required[i];t.push({uniformHydrated:null,shaderModulePath:i,uniformName:i,uniformType:r.type,uniformArrayElementType:Bs(r),uniformArrayLength:Us(r)})}for(let i in e){let r=this.options[i];if(e[i])for(let a in r){let o=r[a];t.push({uniformHydrated:null,shaderModulePath:`${i}.${a}`,uniformName:a,uniformType:o.type,uniformArrayElementType:Bs(o),uniformArrayLength:Us(o)})}}return t}},Bs=s=>s.type==="array"?s.elementType?.type:void 0,Us=s=>s.type==="array"?s.size:void 0;var tr={hittestDist:n,hittestPos:g},ir={filterFlags:G,animation:G,visualVariableData:G,dataDriven0:G,dataDriven1:G,dataDriven2:G,gpgpu:G,size:n},sr={displayViewScreenMat3:q,displayViewMat3:q,displayMat3:q,viewMat3:q,tileMat3:q,displayZoomFactor:n,requiredZoomFactor:n,tileOffset:g,currentScale:n,currentZoom:n,metersPerSRUnit:n},ai=class extends ri{constructor(){super(...arguments),this.vertexShader=Di("materials/pie/pie.vert"),this.fragmentShader=Di("materials/pie/pie.frag"),this.required=h(c(c({},ir),sr),{outlineWidth:n,colors:te,defaultColor:T,othersColor:T,outlineColor:T,donutRatio:n,sectorThreshold:n}),this.options={hittestUniforms:tr,visualVariableSizeMinMaxValue:{minMaxValueAndSize:T},visualVariableSizeScaleStops:{sizes:h(c({},te.ofType(n,8)),{type:"array",elementType:n,size:8}),values:h(c({},te.ofType(n,8)),{type:"array",elementType:n,size:8})},visualVariableSizeStops:{sizes:h(c({},te.ofType(n,8)),{type:"array",elementType:n,size:8}),values:h(c({},te.ofType(n,8)),{type:"array",elementType:n,size:8})},visualVariableSizeUnitValue:{unitValueToPixelsRatio:n},visualVariableOpacity:{opacities:h(c({},te.ofType(n,8)),{type:"array",elementType:n,size:8}),opacityValues:h(c({},te.ofType(n,8)),{type:"array",elementType:n,size:8})}},this.locations={pos:{index:0,type:g},id:{index:1,type:_},bitset:{index:2,type:n},offset:{index:3,type:g},texCoords:{index:4,type:g},size:{index:5,type:g},referenceSize:{index:6,type:n},zoomRange:{index:7,type:g}},this.defines={VV_SIZE_MIN_MAX_VALUE:"boolean",VV_SIZE_SCALE_STOPS:"boolean",VV_SIZE_FIELD_STOPS:"boolean",VV_SIZE_UNIT_VALUE:"boolean",VV_OPACITY:"boolean",HITTEST:"boolean",numberOfFields:"number",highlight:"boolean",inside:"boolean",outside:"boolean"}}setNumberOfFields(e){this.required.colors=h(c({},te.ofType(T,e)),{type:"array",elementType:T,size:e})}};var oi=class extends P{constructor(){super(...arguments),this.type=I.PieChart,this.shaders={geometry:new ai},this.symbologyPlane=Y.MARKER}render(e,t){let{painter:i}=e,{instance:r,target:a}=t,o=this.shaders.geometry,l=r.getInput(),u=l.uniforms.numberOfFields,m=z(e),f=D(e,a),d=M(e);o.setNumberOfFields(u),i.setShader({shader:o,uniforms:h(c(c(c({},R(e,t.target,l.uniforms.shader)),f.storage),f.view),{hittestUniforms:f.hittestRequest?{hittestDist:f.hittestRequest?.distance,hittestPos:f.hittestRequest?.position}:null}),defines:h(c({VV_SIZE_MIN_MAX_VALUE:!!l.uniforms.shader.visualVariableSizeMinMaxValue,VV_SIZE_SCALE_STOPS:!!l.uniforms.shader.visualVariableSizeScaleStops,VV_SIZE_FIELD_STOPS:!!l.uniforms.shader.visualVariableSizeStops,VV_SIZE_UNIT_VALUE:!!l.uniforms.shader.visualVariableSizeUnitValue,VV_OPACITY:!!l.uniforms.shader.visualVariableOpacity,HITTEST:m,highlight:f.highlight?1:0},d),{numberOfFields:u}),optionalAttributes:{},useComputeBuffer:m}),i.setPipelineState(C(e)),i.submitDraw(e,t)}};var ni=class extends P{constructor(){super(...arguments),this.type=I.Text,this.shaders={geometry:new B},this.symbologyPlane=Y.TEXT}render(e,t){let{context:i,painter:r}=e,a=M(e),o=t.instance.getInput(),l={shader:this.shaders.geometry,uniforms:h(c(c({},R(e,t.target,o.uniforms)),D(e,t.target)),{mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey)}),defines:h(c({},a),{isHaloPass:!1,isBackgroundPass:!0,isLabel:!1}),optionalAttributes:o.optionalAttributes,useComputeBuffer:z(e)};r.setShader(l),r.setPipelineState(C(e)),r.submitDraw(e,t),r.setShader(h(c({},l),{defines:h(c({},a),{isHaloPass:!0,isBackgroundPass:!1,isLabel:!1})})),r.submitDraw(e,t),r.setShader(h(c({},l),{defines:h(c({},a),{isHaloPass:!1,isBackgroundPass:!1,isLabel:!1})})),r.submitDraw(e,t)}};var ae={fill:new Nt,patternFill:new Wt,complexFill:new qt,outlineFill:new Gt,patternOutlineFill:new jt,complexOutlineFill:new kt,marker:new si,pieChart:new oi,line:new ti,texturedLine:new ii,text:new ni,label:new ei,heatmap:new Jt,dotDensity:new Ht};function Fu(){for(let s in ae)ae[s].startup()}function zu(s){for(let e in ae)ae[e].shutdown(s)}function nt(s,e){let t=s.slice(0,e),i=e-t.length;for(let r=0;r<i;r++){let a=t[t.length-1];t.push(a)}return t}function Hs(s){if(!s)return[0,0,0,0];let{r:e,g:t,b:i,a:r}=s;return[e*(r/255),t*(r/255),i*(r/255),r]}var li=8,qs=li-2,ks=()=>lt.getLogger("esri.views.2d.layers.features.support.rendererUtils");function ui(s){return s.map(e=>rr(e)?ar(e.clone()):e)}function rr(s){return(s.type==="size"||s.type==="color"||s.type==="opacity")&&s.stops!=null}function ar(s){return s.stops=lr(s.type,s.stops??[]),s}function We(s,e,t){return(1-t)*s+t*e}function or(s,e){let[t,...i]=e,r=i.pop(),a=i[0].value,o=i[i.length-1].value,l=(o-a)/qs,u=[];for(let m=a;m<o;m+=l){let f=0;for(;m>=i[f].value;)f++;let d=i[f],y=e[f-1],x=m-y.value,V=d.value===y.value?1:x/(d.value-y.value);if(s==="color"){let b=i[f],w=e[f-1],F=b.color.clone();F.r=We(w.color.r,F.r,V),F.g=We(w.color.g,F.g,V),F.b=We(w.color.b,F.b,V),F.a=We(w.color.a,F.a,V),u.push({value:m,color:F,label:b.label})}else if(s==="size"){let b=i[f],w=e[f-1],F=yi(b.size),U=We(yi(w.size),F,V);u.push({value:m,size:U,label:b.label})}else{let b=i[f],w=We(e[f-1].opacity,b.opacity,V);u.push({value:m,opacity:w,label:b.label})}}return[t,...u,r]}function nr(s){let[e,...t]=s,i=t.pop();for(;t.length>qs;){let r=0,a=0;for(let o=1;o<t.length;o++){let l=t[o-1],u=t[o],m=Math.abs(u.value-l.value);m>a&&(a=m,r=o)}t.splice(r,1)}return[e,...t,i]}function lr(s,e){return e.length<=li?e:(ks().warn(`Found ${e.length} Visual Variable stops, but MapView only supports ${li}. Displayed stops will be simplified.`),e.length>2*li?or(s,e):nr(e))}function ur(){let{supportsColorBufferFloat:s,supportsColorBufferFloatBlend:e,supportsColorBufferHalfFloat:t}=tt();return s&&e||t}function Ru(s){if(!s)return!0;switch(s.type){case"dot-density":break;case"heatmap":if(!ur()){let e=tt(),t=["supportsColorBufferFloat","supportsColorBufferFloatBlend","supportsColorBufferHalfFloat"].filter(i=>!e[i]).join(", ");return ks().errorOnce(new Ce("webgl-missing-extension",`Missing WebGL2 requirements for Heatmap: ${t}`)),!1}}return!0}var cr=1.25,pi=128,mr=128;function fr(s){if(!s.stops?.length)return null;let e=s.stops.sort((a,o)=>a.value-o.value),t=nt(e,8),i=t.map(({value:a})=>a),r=t.map(({color:a})=>Hs(a));return{values:i,colors:r}}function dr(s){if(!s.stops?.length)return null;let e=s.stops.sort((i,r)=>i.value-r.value),t=nt(e,8);return{opacityValues:t.map(({value:i})=>i),opacities:t.map(({opacity:i})=>i)}}function hr(s){return{rotationType:s.rotationType==="geographic"?Ze.Geographic:Ze.Arithmatic}}function Ei(s){if(!s.stops?.length)return null;if(s.stops.some(i=>i.useMaxValue||i.useMinValue))return(i,r)=>{let a=i.statisticsByLevel.get(r.key.level),o=s.stops.map(u=>({value:u.useMaxValue?a?.get(s.field)?.maxValue??0:u.useMinValue?a?.get(s.field)?.minValue??0:u.value,size:u.size?ze(u.size):1e-30})).sort((u,m)=>u.value-m.value),l=nt(o,8);return{values:l.map(({value:u})=>u),sizes:l.map(({size:u})=>u)}};let e=s.stops.sort((i,r)=>i.value-r.value),t=nt(e,8);return{values:t.map(({value:i})=>i),sizes:t.map(({size:i})=>ze(i))}}function yr(s){return e=>{let{state:t}=e;return{unitValueToPixelsRatio:Gi(t.spatialReference)/Ki[s.valueUnit??"meters"]/t.resolution}}}function Ns(s,e){let t=e.length;if(s<e[0].value||t===1)return e[0].size;for(let i=1;i<t;i++)if(s<e[i].value){let r=(s-e[i-1].value)/(e[i].value-e[i-1].value);return e[i-1].size+r*(e[i].size-e[i-1].size)}return e[t-1].size}function gr(s){let{minDataValue:e,maxDataValue:t,minSize:i,maxSize:r}=s;if(typeof i=="object"&&typeof r=="object")return(a,o)=>{let l=a.state.scale,u=ze(Ns(l,i.stops)),m=ze(Ns(l,r.stops));return{minMaxValueAndSize:[e,t,u,m]}};if(typeof i=="object"||typeof r=="object")throw new Error("InternalError: Found a partial VisualVariableSizeMinMaxValue");return{minMaxValueAndSize:[e,t,ze(i),ze(r)]}}var ci={visualVariableColor:null,visualVariableOpacity:null,visualVariableRotation:null,visualVariableSizeStops:null,visualVariableSizeScaleStops:null,visualVariableSizeOutlineScaleStops:null,visualVariableSizeUnitValue:null,visualVariableSizeMinMaxValue:null};function Bi(s,e=mr,t=cr){if(s.visualVariableSizeMinMaxValue)return s.visualVariableSizeMinMaxValue instanceof Function?pi:Math.max(s.visualVariableSizeMinMaxValue.minMaxValueAndSize[3]*t,e);if(s.visualVariableSizeScaleStops){if(s.visualVariableSizeScaleStops instanceof Function)return pi;let i=s.visualVariableSizeScaleStops.sizes;return Math.max(i[i.length-1]*t,e)}if(s.visualVariableSizeStops){if(s.visualVariableSizeStops instanceof Function)return pi;let i=s.visualVariableSizeStops.sizes;return Math.max(i[i.length-1]*t,e)}return s.visualVariableSizeUnitValue?2*pi:0}function Nu(s){let e=c({},ci);if(!s||!("visualVariables"in s)||!s.visualVariables)return e;for(let t of ui(s.visualVariables))switch(t.type){case"color":e.visualVariableColor=fr(t);break;case"opacity":e.visualVariableOpacity=dr(t);break;case"rotation":e.visualVariableRotation=hr(t);break;case"size":switch(xr(t)){case"field-stops":e.visualVariableSizeStops=Ei(t);break;case"scale-stops":t.target==="outline"?e.visualVariableSizeOutlineScaleStops=Ei(t):e.visualVariableSizeScaleStops=Ei(t);break;case"min-max":e.visualVariableSizeMinMaxValue=gr(t);break;case"unit-value":e.visualVariableSizeUnitValue=yr(t)}break}return e}function xr(s){return typeof s.minDataValue=="number"&&typeof s.maxDataValue=="number"&&s.minSize!=null&&s.maxSize!=null?"min-max":s?.valueExpression==="$view.scale"&&Array.isArray(s.stops)?"scale-stops":s.field==null&&s?.valueExpression==="$view.scale"||!(Array.isArray(s.stops)||"levels"in s&&s.levels)?s.field!=null||s?.valueExpression!=="$view.scale"?"unit-value":null:"field-stops"}function Gs(s){return!!(s.visualVariableSizeMinMaxValue||s.visualVariableSizeScaleStops||s.visualVariableSizeStops||s.visualVariableSizeUnitValue||s.visualVariableSizeOutlineScaleStops)}function ju(s){return!!s.visualVariableRotation}function br(s){return s.minScale||s.maxScale?{minScale:s.minScale??0,maxScale:s.maxScale??0}:null}function me(s){if(s==null)return null;if(Array.isArray(s)){let[e,t,i,r]=s;return[e,t,i,255*r]}return typeof s=="string"?s:h(c({},s),{defaultValue:me(s?.defaultValue)})}function Ju(s,e){return je(this,null,function*(){let{cimResourceManager:t,cimAnalyzer:i,scaleExpression:r}=e.schemaOptions;yield Promise.all(es.fetchResources(s.symbol,t,[]));let a=i.analyzeSymbolReference(s,!1),o={scaleInfo:br(s),scaleExpression:r},l=[];for(let u of a)switch(u.type){case"marker":l.push(...vr(u,e,o));break;case"fill":l.push(...Tr(u,e,o));break;case"line":l.push(...zr(u,e,o));break;case"text":l.push(...Pr(u,e,o))}return l})}function vr(s,e,t){let{uniforms:i,schemaOptions:r}=e,{store:a}=r,o=s.isOutline?h(c({},ci),{visualVariableSizeScaleStops:i.visualVariableSizeOutlineScaleStops}):{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue,visualVariableRotation:i.visualVariableRotation};return Sr(a.ensureInstance(ae.marker,{uniforms:o,optionalAttributes:{zoomRange:!!t.scaleInfo}}),s,i,t)}function Sr(s,e,t,{scaleInfo:i,scaleExpression:r}){let a=Gs(t);return[s.createMeshInfo({size:e.size,scaleX:e.scaleX,anchorX:e.anchorPoint.x,anchorY:e.anchorPoint.y,angle:e.rotation,color:me(e.color)??[0,0,0,0],colorLocked:e.colorLocked,frameHeight:e.frameHeight,widthRatio:e.widthRatio,scaleInfo:i,offsetX:e.offsetX,offsetY:e.offsetY,outlineColor:me(e.outlineColor)??[0,0,0,0],outlineSize:e.outlineWidth,referenceSize:e.referenceSize||Ji.CIMVectorMarker.size,rotateClockwise:e.rotateClockwise,scaleFactor:r??1,sizeRatio:e.sizeRatio,alignment:e.alignment,isAbsoluteAnchorPoint:e.isAbsoluteAnchorPoint,scaleSymbolsProportionally:e.scaleSymbolsProportionally,sprite:e.spriteRasterizationParam,hasSizeVV:a,placement:e.markerPlacement,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null,transforms:e.transform,minPixelBuffer:Bi(t)})]}function Vr(s,e,t){let{uniforms:i,schemaOptions:r}=e,{store:a}=r;return wr(a.ensureInstance(ae.fill,{uniforms:{visualVariableColor:s.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity},optionalAttributes:{zoomRange:!!t.scaleInfo}}),s,t)}function wr(s,e,{scaleInfo:t}){return[s.createMeshInfo({color:me(e.color)??[0,0,0,0],scaleInfo:t,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null})]}function Tr(s,e,t){if(!s.spriteRasterizationParam)return Vr(s,e,t);let{uniforms:i,schemaOptions:r}=e,{store:a}=r;return Fr(a.ensureInstance(ae.complexFill,{uniforms:{visualVariableColor:s.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity},optionalAttributes:{zoomRange:!!t.scaleInfo}}),s,i.visualVariableColor!=null,t)}function Fr(s,e,t,{scaleInfo:i}){if(!e.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");let r=!!e.hasUnresolvedReplacementColor&&(!t||e.colorLocked),a=e.sampleAlphaOnly&&!r,o=e.spriteRasterizationParam;return[s.createMeshInfo({color:me(e.color)??[0,0,0,0],height:e.height,aspectRatio:e.scaleX,offsetX:e.offsetX,offsetY:e.offsetY,scaleX:1,scaleY:1,angle:e.angle,applyRandomOffset:e.applyRandomOffset,sampleAlphaOnly:a,scaleProportionally:o.resource.type==="CIMHatchFill",sprite:o,scaleInfo:i,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null})]}function zr(s,e,t){let{uniforms:i,schemaOptions:r}=e,{store:a}=r,o=s.isOutline?h(c({},ci),{visualVariableSizeScaleStops:i.visualVariableSizeOutlineScaleStops}):{visualVariableColor:s.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue},l={uniforms:o,optionalAttributes:{zoomRange:!!t.scaleInfo}},u=!!(o.visualVariableSizeMinMaxValue||o.visualVariableSizeScaleStops||o.visualVariableSizeStops||o.visualVariableSizeUnitValue);return s.spriteRasterizationParam?Mr(a.ensureInstance(ae.texturedLine,l),s,u,t):_r(a.ensureInstance(ae.line,l),s,u,t)}function Ws(s,e,{scaleInfo:t}){return{color:me(s.color)??[0,0,0,0],width:s.width,referenceWidth:s.referenceWidth,capType:s.cap,joinType:s.join,miterLimit:s.miterLimit,scaleInfo:t,hasSizeVV:e,effects:s.effects?{type:"cim-effect-infos",effectInfos:s.effects}:null}}function _r(s,e,t,i){if(e.spriteRasterizationParam)throw new Error("InternalError: Sprite should not be defined");let r=Ws(e,t,i);return[s.createMeshInfo(r)]}function Mr(s,e,t,i){let{spriteRasterizationParam:r,scaleDash:a,sampleAlphaOnly:o}=e;if(!r)throw new Error("InternalError: Sprite should be defined");return[s.createMeshInfo(h(c({},Ws(e,t,i)),{shouldScaleDash:a??!1,shouldSampleAlphaOnly:o,isSDF:r.resource.type!=="CIMPictureStroke",sprite:r}))]}function Pr(s,e,t){let{uniforms:i,schemaOptions:r}=e,{store:a}=r;return Dr(a.ensureInstance(ae.text,{uniforms:{visualVariableColor:s.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableRotation:i.visualVariableRotation,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!!t.scaleInfo,referenceSymbol:!1,clipAngle:!1}}),s,i,t)}function Dr(s,e,t,{scaleInfo:i,scaleExpression:r}){return[s.createMeshInfo({boxBackgroundColor:me(e.backgroundColor),boxBorderLineColor:me(e.borderLineColor),boxBorderLineSize:e.borderLineWidth??0,color:me(e.color)??[0,0,0,0],offsetX:e.offsetX,offsetY:e.offsetY,postAngle:e.angle,fontSize:e.size,referenceSize:e.referenceSize,decoration:e.decoration,haloColor:me(e.outlineColor)??[0,0,0,0],haloFontSize:e.outlineSize,lineWidth:e.lineWidth||512,lineHeightRatio:1,horizontalAlignment:e.horizontalAlignment??"center",verticalAlignment:e.verticalAlignment??"baseline",useCIMAngleBehavior:!1,glyphs:e.textRasterizationParam,scaleInfo:i,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null,placement:e.markerPlacement,transforms:e.transform,scaleFactor:r??1,minPixelBuffer:Bi(t),repeatLabel:null,repeatLabelDistance:null,allowOverrun:null,labelPosition:null,isLineLabel:!1})]}var js=class{constructor(e){this.updateTracking=new Is({debugName:"FeatureCommandQueue"}),this._queueProcessor=new Zi({concurrency:1,process:e.process})}destroy(){this.updateTracking.destroy(),this._queueProcessor.destroy(),this.clear()}clear(){this._queueProcessor.clear()}push(e){return je(this,null,function*(){return Ni(this.updateTracking.addPromise(this._doPush(e)))})}_doPush(e){return je(this,null,function*(){let t=this._queueProcessor,i=t.last();switch(e.type){case"update":case"highlight":return i?.type===e.type?void 0:t.push(e);case"edit-by-id":case"edit-by-feature":return t.push(e)}})}};function cp(s,e){return{type:"simple",filters:e,capabilities:{maxTextureSize:tt().maxTextureSize},bindings:Ir(s)}}function mi(s){switch(s){case"opacity":return it.OPACITY;case"color":return it.COLOR;case"rotation":return it.ROTATION;case"size":return it.SIZE;default:return null}}function Ir(s){if(!s)return[];switch(s.type){case"simple":case"class-breaks":case"unique-value":case"dictionary":return $s(s);case"dot-density":return Cr(s);case"pie-chart":return Rr(s);case"heatmap":return Ar(s)}}function Cr(s){let e=[];for(let t of s.attributes)e.push({binding:e.length,expression:t.valueExpression,field:t.field});return e}function Rr(s){let e=$s(s),t=4;for(let i of s.attributes)e.push({binding:t++,expression:i.valueExpression,field:i.field});return e}function Ar({valueExpression:s,field:e}){return s||e?[{binding:0,expression:s,field:e}]:[]}function $s(s){return!("visualVariables"in s)||!s.visualVariables?.length?[]:ui(s.visualVariables).map(e=>Ur(e)).filter(qi)}function Or(s){return s.valueExpression==="$view.scale"?null:{binding:mi(s.type),field:s.field,normalizationField:s.normalizationField,expression:s.valueExpression,valueRepresentation:s.valueRepresentation}}function Lr(s){return{binding:mi(s.type),field:s.field,normalizationField:s.normalizationField,expression:s.valueExpression}}function Er(s){return{binding:mi(s.type),field:s.field,normalizationField:s.normalizationField,expression:s.valueExpression}}function Br(s){return{binding:mi(s.type),expression:s.valueExpression,field:s.field}}function Ur(s){switch(s.type){case"size":return Or(s);case"color":return Lr(s);case"opacity":return Er(s);case"rotation":return Br(s)}}export{ae as a,Fu as b,zu as c,Hs as d,Ru as e,ci as f,Bi as g,Nu as h,Gs as i,ju as j,br as k,Ju as l,Sr as m,wr as n,Fr as o,_r as p,Mr as q,Dr as r,cp as s,$s as t,js as u};

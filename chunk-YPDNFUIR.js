import{a as de,e as U}from"./chunk-N2TNOW4A.js";import{a as q}from"./chunk-WCMNVC4S.js";import{a as je,b as Ge}from"./chunk-KWPJ7W7D.js";import{a as Pe,b as Ue}from"./chunk-22VKLLNJ.js";import{a as Ae,b as Oe}from"./chunk-Y353ORYJ.js";import{a as ze}from"./chunk-LQKHYKYR.js";import{a as qe,b as We}from"./chunk-OTCE2CL6.js";import{a as $e,b as Qe}from"./chunk-A32YL34U.js";import{a as Je}from"./chunk-UTTIMDT4.js";import{b as ve,d as ie}from"./chunk-KFCU4KQY.js";import{a as Se}from"./chunk-APGKXN3F.js";import{a as _e,b as Me,c as De}from"./chunk-PHCUTV4M.js";import{a as Fe}from"./chunk-GHKFJTCN.js";import{c as Ye,d as He,f as Ke,i as Ze,m as Xe,n as et}from"./chunk-KS53OQGV.js";import{a as Ie}from"./chunk-EB5RRWIA.js";import{a as tt}from"./chunk-RWIKH4KN.js";import{h as Be}from"./chunk-2B3PG2ZT.js";import{a as xe}from"./chunk-DVSFGYL7.js";import{n as ke}from"./chunk-OLIJD5I4.js";import{d as O}from"./chunk-MXSUS5HK.js";import{c as ee}from"./chunk-WMT47BMV.js";import{a as re,d as Re}from"./chunk-O4IUXH7A.js";import{a as Ce}from"./chunk-EP6QNUFZ.js";import{b as Le}from"./chunk-SMT6QWPH.js";import{m as pe}from"./chunk-UHE637ZN.js";import{a as le}from"./chunk-NWPYI2UP.js";import{g as Ve}from"./chunk-VOH7XGOR.js";import{a as ae}from"./chunk-Y6HWUWZ3.js";import{a as P}from"./chunk-PPFMRTTD.js";import{f as Ne}from"./chunk-IWJQ3PU6.js";import{g as B,s as te}from"./chunk-ATXTHXJA.js";import{o as X,p as Ee}from"./chunk-4HUAEW4D.js";import{v as J}from"./chunk-SO6OJFOM.js";import{a as be,b as se}from"./chunk-DG5QI6E2.js";import{G}from"./chunk-OFVMJORF.js";import{aa as we}from"./chunk-BRGZVJPZ.js";import{I as p,L as Te,k as ge}from"./chunk-Z5NXR7SL.js";import{S as Q,t as A}from"./chunk-7JLWSSXP.js";import{a}from"./chunk-W3WDPWBE.js";import{b as F,q as Z,s as x}from"./chunk-BRWS572J.js";import{a as $,b as he,d as fe,g as T}from"./chunk-JEGVIFEP.js";var V;(function(e){e.ELEMENTUID="ELEMENTUID",e.TYPENAME="TYPENAME"})(V||(V={}));var pt=[V.ELEMENTUID,V.TYPENAME],ce,me;(function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME"})(ce||(ce={})),function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME",e[e.FROMUID=2]="FROMUID",e[e.TOUID=3]="TOUID"}(me||(me={}));var rt,oe,ne,Y;(function(e){e[e.featureResult=0]="featureResult",e[e.countResult=1]="countResult",e[e.idsResult=2]="idsResult"})(rt||(rt={})),function(e){e[e.upperLeft=0]="upperLeft",e[e.lowerLeft=1]="lowerLeft"}(oe||(oe={})),function(e){e[e.sqlTypeBigInt=0]="sqlTypeBigInt",e[e.sqlTypeBinary=1]="sqlTypeBinary",e[e.sqlTypeBit=2]="sqlTypeBit",e[e.sqlTypeChar=3]="sqlTypeChar",e[e.sqlTypeDate=4]="sqlTypeDate",e[e.sqlTypeDecimal=5]="sqlTypeDecimal",e[e.sqlTypeDouble=6]="sqlTypeDouble",e[e.sqlTypeFloat=7]="sqlTypeFloat",e[e.sqlTypeGeometry=8]="sqlTypeGeometry",e[e.sqlTypeGUID=9]="sqlTypeGUID",e[e.sqlTypeInteger=10]="sqlTypeInteger",e[e.sqlTypeLongNVarchar=11]="sqlTypeLongNVarchar",e[e.sqlTypeLongVarbinary=12]="sqlTypeLongVarbinary",e[e.sqlTypeLongVarchar=13]="sqlTypeLongVarchar",e[e.sqlTypeNChar=14]="sqlTypeNChar",e[e.sqlTypeNVarChar=15]="sqlTypeNVarChar",e[e.sqlTypeOther=16]="sqlTypeOther",e[e.sqlTypeReal=17]="sqlTypeReal",e[e.sqlTypeSmallInt=18]="sqlTypeSmallInt",e[e.sqlTypeSqlXml=19]="sqlTypeSqlXml",e[e.sqlTypeTime=20]="sqlTypeTime",e[e.sqlTypeTimestamp=21]="sqlTypeTimestamp",e[e.sqlTypeTimestamp2=22]="sqlTypeTimestamp2",e[e.sqlTypeTinyInt=23]="sqlTypeTinyInt",e[e.sqlTypeVarbinary=24]="sqlTypeVarbinary",e[e.sqlTypeVarchar=25]="sqlTypeVarchar"}(ne||(ne={})),function(e){e[e.OID_ARRAY=0]="OID_ARRAY",e[e.GLOBALID_ARRAY=1]="GLOBALID_ARRAY",e[e.STRING_ARRAY=2]="STRING_ARRAY",e[e.IDENTIFIER_ARRAY=3]="IDENTIFIER_ARRAY"}(Y||(Y={}));function it(e){if(!e.spatialReference.isWGS84)throw new x("knowledge-graph:layer-support-utils","The extentToInBoundsRings function only supports WGS84 spatial references.");return e.clone().normalize().map(t=>[[t.xmin,t.ymin],[t.xmin,t.ymax],[t.xmax,t.ymax],[t.xmax,t.ymin],[t.xmin,t.ymin]])}function Jt(e,t){return T(this,null,function*(){let i=[],r=new Map,s=[];if(t.dataModel?.relationshipTypes)for(let o of t.dataModel.relationshipTypes)o.name&&r.set(o.name,[]);for(let o of e)r.has(o.typeName)&&r.get(o.typeName)?.push(o.id);for(let[o,l]of r){if(l.length<1)continue;let c=new q({openCypherQuery:`MATCH (n)-[r:${o}]->(m) WHERE id(r) in $ids RETURN id(n), labels(n)[0], id(m), labels(m)[0]`,bindParameters:{ids:l}});s.push(U(t,c).then(n=>T(this,null,function*(){let m=n.resultRowsStream.getReader();for(;;){let{done:_,value:D}=yield m.read();if(_)break;for(let g of D)i.push({id:g[0],typeName:g[1]}),i.push({id:g[2],typeName:g[3]})}})))}return yield Promise.all(s),i})}function Bt(e,t){return T(this,null,function*(){t??=!1;let i={generateAllSublayers:t,namedTypeDefinitions:new Map};return yield mt(e).then(r=>{yt(r,i)}),i})}function Vt(e){return T(this,null,function*(){let t=yield de(),i=new t.MapOfObjectIdentifierSets;ct(i,t,e);let r=new t.MapOfObjectIdentifierSetsEncoder;try{r.set_map_of_identifier_sets(i),r.encode();let s=r.get_encoding_result();if(s.error.error_code!==0)throw new x("knowledge-graph:layer-support-utils",s.error.error_message);let o=structuredClone(s.get_byte_buffer());return r.delete(),o}finally{i.delete()}})}function ct(e,t,i){for(let[r,s]of i.namedTypeDefinitions){if(!s.members||s.useAllData)continue;let o=s.members.keys(),l=new t.GlobalIdArray,c=new t.ObjectIdentifierSet;for(let n of o)l.add_globalid(n);c.set_globalid_array(l),l.delete(),e.put_identifier_set(r,c),c.delete()}return e}function mt(e){return T(this,null,function*(){let t=yield we(e,{responseType:"array-buffer"}),i=yield t.data;return ut(new Uint8Array(i))})}function ut(e){return T(this,null,function*(){let t=new(yield de()).MapOfObjectIdentifierSetsDecoder,i=t.decode(new Uint8Array(e)),r=new Map;if(i.error_code!==0)throw new x("knowledge-graph:layer-support-utils",i.error_message);let s=t.get_map_of_identifier_sets(),o=s.keys,l=o.size();for(let c=0;c<l;c++){let n=o.get(c),m=s.query_identifier_set(n),_=[];if(m.id_array_type.value===Y.GLOBALID_ARRAY){let D=m.get_globalid_array(),g=D.count();for(let E=0;E<g;E++)_.push(D.get_globalid_at(E))}else{if(m.id_array_type.value!==Y.IDENTIFIER_ARRAY)throw new x("knowledge-graph:layer-support-utils","Tried to encode an unexpected ID Array type.");{let D=m.get_identifier_array(),g=D.count();for(let E=0;E<g;E++)_.push(D.get_identifier_at(E).toString())}}r.set(n,_)}return t.delete(),r})}function yt(e,t){for(let[i,r]of e){let s=A(t.namedTypeDefinitions,i,()=>({useAllData:!1,members:new Map}));for(let o of r)s.members.has(o)||s.members.set(o,{id:o})}return t}var ht="ESRI__DESTINATION_ID",ft="ESRI__ORIGIN_ID",z=class e{constructor(){this._featureLookup=new Map}static getInstance(){return e.instance||(e.instance=new e),e.instance}static resetInstance(){e.instance&&(e.instance=null)}deleteFromStore(t){t.forEach(i=>{this._featureLookup.delete(i)})}readFromStoreByList(t){let i=[];return t.forEach(r=>{let s=this.readFromStoreById(r);s&&i.push(s)}),i}readFromStoreById(t){return this._featureLookup.get(t)??null}writeToStore(t,i,r){let s=[];return t.forEach(o=>{if(!o?.id)return;o.properties||(o.properties=[]);let l,c=null;if(r&&o.properties[r]&&(c=pe(o.properties[r])),"originId"in o&&"destinationId"in o&&(o.properties[ft]=o.originId,o.properties[ht]=o.destinationId),o.properties[i]=o.id,o.id&&this._featureLookup.has(o.id)&&this._featureLookup.get(o.id).attributes){let n=this._featureLookup.get(o.id),m=JSON.parse(JSON.stringify(Object.assign(n.attributes,o.properties)));r&&o.properties[r]&&(m[r]=Ne(o.properties[r])),l=new le(c?JSON.parse(JSON.stringify(c)):n?.geometry?JSON.parse(JSON.stringify(n.geometry)):null,m,null,o.properties[i])}else l=new le(c?JSON.parse(JSON.stringify(c)):null,o.properties,null,o.properties[i]);this._featureLookup.set(o.id,l),s.push(l)}),s}};var L="ESRI__ID",Er="ESRI__ORIGIN_ID",Nr="ESRI__DESTINATION_ID",ue="ESRI__LAYOUT_GEOMETRY",ye="ESRI__AGGREGATION_COUNT",k=class extends Te{constructor(e){super(e),this._processingCacheUpdatesLookup=new Map,this.knowledgeGraph=null,this.inclusionModeDefinition={generateAllSublayers:!0,namedTypeDefinitions:new Map},this.entityTypeNames=new Set,this.relationshipTypeNames=new Set,this.geographicLookup=new Map,this.sublayerCaches=new Map,this.nodeConnectionsLookup=new Map,this.relationshipConnectionsLookup=new Map,this.memberIdTypeLookup=new Map;let t=new Map;e.knowledgeGraph.dataModel.entityTypes?.forEach(i=>{i.name&&(t.set(i.name,"entity"),this._processingCacheUpdatesLookup.set(i.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.entityTypeNames.add(i.name),i.properties?.forEach(r=>{r.geometryType&&r.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(i.name,{name:r.name??"",geometryType:r.geometryType})}))}),e.knowledgeGraph.dataModel.relationshipTypes?.forEach(i=>{i.name&&(t.set(i.name,"relationship"),this._processingCacheUpdatesLookup.set(i.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.relationshipTypeNames.add(i.name),i.properties?.forEach(r=>{r.geometryType&&r.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(i.name,{name:r.name??"",geometryType:r.geometryType})}))}),e.inclusionModeDefinition?.namedTypeDefinitions.forEach((i,r)=>{if(t.get(r)==="entity")this.entityTypeNames.add(r);else{if(t.get(r)!=="relationship")return Z.getLogger(this).warn(`A named type, ${r}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(r);this.relationshipTypeNames.add(r)}let s=new Map;i.members?.forEach(o=>{A(this.memberIdTypeLookup,o.id,()=>new Set).add(r);let l=this.getById(o.id);l&&s.set(o.id,l)}),this.sublayerCaches.set(r,s)})}addToLayer(e){e.forEach(({typeName:t,id:i})=>{if(!this.inclusionModeDefinition)throw new x("knowledge-graph:layer-data-manager","You cannot add to a layer's exclusion list if it was not created with an exclusion list originally");if(this.inclusionModeDefinition.namedTypeDefinitions.has(t)){if(this.inclusionModeDefinition.namedTypeDefinitions.has(t)){let r=this.inclusionModeDefinition.namedTypeDefinitions.get(t);r.members||(r.members=new Map),r.members.set(i,{id:i}),A(this.memberIdTypeLookup,i,()=>new Set).add(t)}}else{let r=new Map;r.set(i,{id:i}),this.inclusionModeDefinition.namedTypeDefinitions.set(t,{useAllData:!1,members:r}),A(this.memberIdTypeLookup,i,()=>new Set).add(t)}})}getById(e){return z.getInstance().readFromStoreById(e)}getData(e,t,i){return T(this,null,function*(){if(t.objectType.name&&this.inclusionModeDefinition?.namedTypeDefinitions&&this.inclusionModeDefinition.namedTypeDefinitions.size>0&&!this.inclusionModeDefinition.namedTypeDefinitions.has(t.objectType.name))return[];let r;if(r=e||new O({where:"1=1",outFields:["*"]}),t.parentCompositeLayer.type==="link-chart"){let s=t.parentCompositeLayer,o=this._processingCacheUpdatesLookup.get(t.objectType.name??""),l=r.outFields;l&&l.length===1&&l[0]===L&&r.where==="1=1"||(yield Promise.all(o??[]));let c=this.sublayerCaches.has(t.objectType.name??"")?Array.from(this.sublayerCaches.get(t.objectType.name)?.values()):[],n=[];return c.forEach(m=>{this.relationshipTypeNames.has(t.objectType.name)?m.geometry=s.relationshipLinkChartDiagramLookup.get(m.attributes[t.objectIdField]):m.geometry=s.entityLinkChartDiagramLookup.get(m.attributes[t.objectIdField]),m.attributes[ue]=m.geometry,n.push(m)}),n}return this.retrieveDataFromService(r,t,i)})}getConnectedRecordIds(e,t){return T(this,null,function*(){let i=[],r="",s=[],o=new Map;if(e.forEach(l=>{if(this.memberIdTypeLookup.has(l))for(let c of this.memberIdTypeLookup.get(l)){if(!this.entityTypeNames.has(c))return;o.has(c)?o.get(c)?.push(l):o.set(c,[l])}}),t&&t?.length!==0){for(let l of t)r=r+l+"|";r=r.slice(0,-1)}return o.forEach((l,c)=>{let n;n=t&&t?.length!==0?`MATCH (n:${c})-[r:${r}]-(m) WHERE id(n) IN $ids RETURN id(r), type(r), id(m), labels(m)[0]`:`MATCH (n:${c})-[r]-(m) WHERE id(n) IN $ids RETURN id(r), type(r), id(m), labels(m)[0]`;let m=new Promise(_=>{T(this,null,function*(){let D=(yield U(this.knowledgeGraph,new q({openCypherQuery:n,bindParameters:{ids:l}}))).resultRowsStream.getReader();try{for(;;){let{done:g,value:E}=yield D.read();if(g)break;for(let f=0;f<E.length;f++){let u=E[f];i.push({id:u[0],typeName:u[1]}),i.push({id:u[2],typeName:u[3]})}}}catch(g){if(g.name!=="AbortError")throw g;Z.getLogger(this).info("Request aborted as expected")}}).then(()=>{_()})});s.push(m)}),this.refreshCacheContent(),yield Promise.all(s),i})}getAttachedRelationships(e,t){return T(this,null,function*(){let i=[],r="MATCH (n)-[r]->(m) WHERE id(n) IN $nodeIds AND id(m) in $nodeIds AND NOT id(r) IN $relationshipExclusionIds return id(r), type(r)",s=(yield U(this.knowledgeGraph,new q({openCypherQuery:r,bindParameters:{nodeIds:e,relationshipExclusionIds:t}}))).resultRowsStream.getReader();try{for(;;){let{done:o,value:l}=yield s.read();if(o)break;for(let c=0;c<l.length;c++){let n=l[c];i.push({id:n[0],typeName:n[1]})}}}catch(o){if(o.name!=="AbortError")throw o;Z.getLogger(this).info("Request aborted as expected")}return i})}refreshCacheContent(e,t,i,r=!0){return T(this,null,function*(){let s=z.getInstance(),o=[],l=new Map,c=new Map;this.knowledgeGraph.dataModel.entityTypes?.forEach(n=>{n.name&&c.set(n.name,n)}),this.knowledgeGraph.dataModel.relationshipTypes?.forEach(n=>{n.name&&c.set(n.name,n)}),e||this.inclusionModeDefinition?e?e.forEach(n=>{if(this.memberIdTypeLookup.has(n))for(let m of this.memberIdTypeLookup.get(n))l.has(m)?l.get(m)?.push(n):l.set(m,[n])}):this.inclusionModeDefinition?.namedTypeDefinitions?.forEach((n,m)=>{n.useAllData?l.set(m,null):n.members&&n.members.forEach(_=>{l.has(m)&&l.get(m)!==null?l.get(m)?.push(_.id):l.set(m,[_.id])})}):(this.knowledgeGraph.dataModel.entityTypes?.forEach(n=>{n.name&&l.set(n.name,null)}),this.knowledgeGraph.dataModel.entityTypes?.forEach(n=>{n.name&&l.set(n.name,null)}));for(let[n,m]of l){let _=new Promise(D=>{T(this,null,function*(){let E=new Set,f=[],u,M="",N=!1;if(t||c.get(n)?.properties?.forEach(h=>{h.name&&E.add(h.name)}),i&&this.geographicLookup.has(n)){let h=this.geographicLookup.get(n)?.name;h&&E.add(h)}if(this.entityTypeNames.has(n))M=`MATCH (n:${n}) ${m?"WHERE id(n) IN $ids ":""}return ID(n)`,E.forEach(h=>{M+=`, n.${h}`,f.push(h)});else{if(!this.relationshipTypeNames.has(n))throw new x("knowledge-graph:layer-data-manager",`The graph type of ${n} could not be determined. Was this type set in the KG data model and inclusion definition?`);N=!0,M=`MATCH ()-[n:${n}]->() ${m?"WHERE id(n) IN $ids ":""}return ID(n), id(startNode(n)), id(endNode(n))`,E.forEach(h=>{M+=`, n.${h}`,f.push(h)})}u=new q(m?{openCypherQuery:M,bindParameters:{ids:m}}:{openCypherQuery:M});let S=(yield U(this.knowledgeGraph,u)).resultRowsStream.getReader();for(;;){let{done:h,value:I}=yield S.read();if(h)break;let w=[];for(let b=0;b<I.length;b++){let W=I[b],v=0,K=0,C={properties:{}};for(C.id=W[v],v++,K++,N&&(C.originId=W[v],v++,K++,C.destinationId=W[v],v++,K++,A(this.nodeConnectionsLookup,C.originId,()=>new Set).add(C.id),A(this.nodeConnectionsLookup,C.destinationId,()=>new Set).add(C.id),A(this.relationshipConnectionsLookup,C.id,()=>[C.originId,C.destinationId]));v<W.length;v++)C.properties[f[v-K]]=W[v];w.push(C)}let y=s.writeToStore(w,L,this.geographicLookup.get(n)?.name);this.sublayerCaches.has(n)||this.sublayerCaches.set(n,new Map),r&&!this.inclusionModeDefinition?.namedTypeDefinitions.has(n)&&this.inclusionModeDefinition?.namedTypeDefinitions.set(n,{useAllData:!1,members:new Map}),r&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(n).members&&(this.inclusionModeDefinition.namedTypeDefinitions.get(n).members=new Map);let j=this.sublayerCaches.get(n);y.forEach(b=>{j?.set(b.attributes[L],b),r&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(n).members.has(b.attributes[L])&&(this.inclusionModeDefinition?.namedTypeDefinitions.get(n).members.set(b.attributes[L],{id:b.attributes[L]}),A(this.memberIdTypeLookup,b.attributes[L],()=>new Set).add(n))})}}).then(()=>{D(null)})});o.push(_),this._processingCacheUpdatesLookup.get(n)?.push(_)}yield Promise.all(o)})}removeFromLayer(e){let t=new Set,i=new Set(e.map(r=>r.id));for(let r of e)t.add(r.typeName),this.memberIdTypeLookup.get(r.id)?.size===1?this.memberIdTypeLookup.delete(r.id):this.memberIdTypeLookup.get(r.id)?.delete(r.typeName),this.inclusionModeDefinition?.namedTypeDefinitions.forEach((s,o)=>{o===r.typeName&&s.members?.has(r.id)&&s.members.delete(r.id)});t.forEach(r=>{this.sublayerCaches.get(r)?.forEach((s,o)=>{i.has(o)&&this.sublayerCaches.get(r)?.delete(o)})})}retrieveDataFromService(e,t,i){return T(this,null,function*(){let r=z.getInstance(),s=new Set,o=[],l,c="",n=[],m=t.graphType==="relationship",_=this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData,D=t.parentCompositeLayer.sublayerIdsCache.get(t.objectType.name),g=!_&&D?Array.from(D).sort():null;if(this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData)this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData&&e.objectIds!=null&&(g=e.objectIds);else if(e.objectIds!=null&&g&&g.length>0){let f=e.objectIds;e.objectIds=g.filter(u=>f.includes(u))}else if(e.objectIds!=null)g=e.objectIds;else{if(this.inclusionModeDefinition?.namedTypeDefinitions.has(t.objectType.name)&&(!this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name)?.members||this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name)?.members?.size<1))return e.objectIds=[],[];e.objectIds=g}if(e.outFields!=null){let f=e.outFields;f.includes("*")?t.fields.forEach(u=>{s.add(u.name)}):f.forEach(u=>{u!==L&&u!==t.geometryFieldName&&s.add(u)})}if(e.geometry!=null){let f=e.geometry,u,M=t.parentCompositeLayer.dataManager.knowledgeGraph.serviceDefinition,N=M?.spatialReference,S=M?.serviceCapabilities?.geometryCapabilities,h=S?.geometryMaxBoundingRectangleSizeX,I=S?.geometryMaxBoundingRectangleSizeY;if(f?.extent?.spatialReference&&!f.spatialReference?.isWGS84?(yield te(f.extent.spatialReference,G),u=B(f.extent,G)):u=f.extent,h&&I&&N){if(N.wkid!==4326){let w=new J({spatialReference:N,xmax:h,ymax:I}),y=B(w,G);h=y.xmax,I=y.ymax}if(u.xmax-u.xmin>h)throw new x("knowledge-graph:layer-data-manager",`Extent x bounds should be within ${h}\xB0 latitude, limit exceeded`);if(u.ymax-u.ymin>I)throw new x("knowledge-graph:layer-data-manager",`Extent y bounds should be within ${I}\xB0 longitude, limit exceeded`)}if(e.where!=null&&e.where!=="1=1"){let w=yield ae(e.where.toUpperCase(),t.fieldsIndex);t.fields.forEach(y=>{w.fieldNames.includes(y.name)&&s.add(y.name)})}c=m?`Match ()-[n:${t.objectType.name}]->() WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n), id(startNode(r)), id(endNode(r))`:`Match (n:${t.objectType.name}) WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n)`,t.geometryFieldName&&s.add(t.geometryFieldName),s.forEach(w=>{c+=`, n.${w}`,o.push(w)}),l=new q({openCypherQuery:c,bindParameters:{param_filter_geom:new X({rings:it(u)})}})}else{let f="";if(e.where!=null&&e.where!=="1=1"){let N=yield ae(e.where,t.fieldsIndex);t.fields.forEach(y=>{N.fieldNames.includes(y.name)&&s.add(y.name)});let S=new Set(["column-reference","string","number","binary-expression"]),h=new Set(["=","<","<=","<>",">",">=","AND","OR","LIKE"]),I=!1,w=y=>{if(y.type==="column-reference")return`n.${y.column}`;if(y.type==="string")return`'${y.value}'`;if(y.type==="number")return`${y.value}`;if(y.type==="binary-expression"&&S.has(y.left.type)&&S.has(y.right.type)&&h.has(y.operator))return`${w(y.left)} ${y.operator} ${w(y.right)}`;if(y.type==="binary-expression"&&y.operator==="LIKE"){let j="";if(y.left.type==="function"&&y.left.args.value[0].type==="column-reference")j+=`lower(n.${y.left.args.value[0].column})`;else{if(y.left.type!=="column-reference")return I=!0,"";j+=`lower(n.${y.left.column})`}if(j+=" CONTAINS (",y.right.type!=="string")return I=!0,"";{let b=y.right.value;b.charAt(0)==="%"&&(b=b.slice(1)),b.charAt(b.length-1)==="%"&&(b=b.slice(0,-1)),j+=`'${b.toLowerCase()}')`}return j}return I=!0,""};f=w(N.parseTree),I&&(f="")}let u="";u=m?`Match ()-[n:${t.objectType.name}]->()`:`Match (n:${t.objectType.name})`;let M=!1;g&&(M=!0,u+=" WHERE ID(n) IN $ids"),f&&(u+=M?" AND":" WHERE",u+=` ${f}`),u+=" return ID(n)",m&&(u+=", id(startNode(n)), id(endNode(n))"),e.returnGeometry&&t.geometryFieldName&&s.add(t.geometryFieldName),s.forEach(N=>{u+=`, n.${N}`,o.push(N)}),l=new q(g?{openCypherQuery:u,bindParameters:{ids:g}}:{openCypherQuery:u})}let E=(yield U(t.parentCompositeLayer.dataManager.knowledgeGraph,l,i)).resultRowsStream.getReader();for(;;){let{done:f,value:u}=yield E.read();if(f)break;let M=[];for(let N=0;N<u.length;N++){let S=u[N],h=0,I=0,w={properties:{}};for(w.id=S[h],h++,I++,m&&(w.originId=S[h],h++,I++,w.destinationId=S[h],h++,I++);h<S.length;h++)w.properties[o[h-I]]=S[h];M.push(w)}n=n.concat(r.writeToStore(M,L,t.parentCompositeLayer.dataManager.geographicLookup.get(t.objectType.name)?.name))}return n})}};a([p()],k.prototype,"knowledgeGraph",void 0),a([p()],k.prototype,"inclusionModeDefinition",void 0),a([p()],k.prototype,"entityTypeNames",void 0),a([p()],k.prototype,"relationshipTypeNames",void 0),a([p()],k.prototype,"geographicLookup",void 0),a([p()],k.prototype,"sublayerCaches",void 0),a([p()],k.prototype,"nodeConnectionsLookup",void 0),a([p()],k.prototype,"relationshipConnectionsLookup",void 0),a([p()],k.prototype,"memberIdTypeLookup",void 0),k=a([Q("esri.layers.knowledgeGraph.KnowledgeGraphLayerDataManager")],k);var ot=ze(),nt=e=>{let t=class extends e{constructor(){super(...arguments),this.fields=[],this.fieldsIndex=null}};return a([p(ot.fields)],t.prototype,"fields",void 0),a([p(ot.fieldsIndex)],t.prototype,"fieldsIndex",void 0),t=a([Q("esri.layers.knowledgeGraph.KnowledgeGraphSublayerBase")],t),t};function R(e){if(!e.json)return e;e.json.write=st(e.json.write);let t=e.json.origins;if(!t)return e;let i;for(i in t){let r=t[i];r&&(r.write=st(r.write))}return e}function st(e){return typeof e=="object"&&e?(e.enabled!==!1&&(e.overridePolicy=gt(e)),e):e===!0?H():e}function gt(e){let o=e,{target:t,writer:i,overridePolicy:r}=o,s=fe(o,["target","writer","overridePolicy"]);return function(l,c){let n=at.call(this,l,c);return n.enabled?$($({},s),n):n}}function H(){return{overridePolicy:at}}function at(e,t){let i=!!this.geometryType,r={enabled:i};return i&&(r=$($({},r),lt.call(this,e,t))),r}function lt(e,t){return{ignoreOrigin:this.originIdOf(t)>ge.DEFAULTS}}var d=class extends nt(Ge(Oe(De(Ue(Qe(Fe(Se(Ie(tt))))))))){constructor(e){super(e),this.blendMode="normal",this.capabilities=Re(!1,!1),this.charts=null,this.definitionExpression=null,this.displayField="",this.effect=null,this.elevationInfo=null,this.featureEffect=null,this.graphType=null,this.labelsVisible=!0,this.labelingInfo=null,this.layerType=null,this.legendEnabled=!0,this.maxScale=0,this.minScale=0,this.objectIdField=L,this.objectType=null,this.opacity=1,this.orderBy=null,this.parentCompositeLayer=null,this.persistenceEnabled=!0,this.popupEnabled=!0,this.popupTemplate=null,this.refreshInterval=0,this.source={openPorts:()=>this.load().then(()=>{let t=new MessageChannel;return new Be(t.port1,{channel:t,client:{queryFeatures:(i,r={})=>{let s=O.fromJSON(i);return this.queryFeaturesJSON(s,r)}}}),[t.port2]})},this.title=null,this.type="knowledge-graph-sublayer",this.useViewTime=!0,this.visible=!0}get defaultPopupTemplate(){return this.createPopupTemplate()}set featureReduction(e){let t=this._normalizeFeatureReduction(e);this._set("featureReduction",t)}get fields(){let e=[];return this.objectType?.properties?.forEach(t=>{let i=t.fieldType==="esriFieldTypeOID"?"esriFieldTypeInteger":t.fieldType;e.push(ee.fromJSON({name:t.name,type:i,alias:t.alias,defaultValue:t.defaultValue,editable:t.editable,nullable:t.nullable}))}),e.push(ee.fromJSON({name:this.objectIdField,type:"esriFieldTypeString",alias:this.objectIdField,editable:!1}),ee.fromJSON({name:ye,type:"esriFieldTypeInteger",alias:ye,editable:!1})),e}get geometryType(){if(this.parentCompositeLayer?.type==="link-chart")return this.graphType==="relationship"?"polyline":"point";let e=this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name),t=e?.geometryType;return t&&t!=="esriGeometryNull"?P.fromJSON(t):null}get geometryFieldName(){return this.parentCompositeLayer?.type==="link-chart"?ue:this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name)?.name??null}get graphTypeName(){return this.objectType?.name}get hasM(){let e=this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name),t=e?.name;return(t?this.objectType?.properties?.[t]:null)?.hasM??!1}get hasZ(){let e=this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name),t=e?.name;return(t?this.objectType?.properties?.[t]:null)?.hasZ??!1}set renderer(e){Ve(e,this.fieldsIndex),this._set("renderer",e)}get renderer(){return this._isOverridden("renderer")?this._get("renderer"):this.parentCompositeLayer?.type==="link-chart"?this.graphType==="relationship"?ie(re(P.toJSON("polyline")).renderer):ie(re(P.toJSON("point")).renderer):ie(re(P.toJSON(this.geometryType)).renderer)}get spatialReference(){return this.parentCompositeLayer?.dataManager?.knowledgeGraph?.dataModel?.spatialReference??se.WGS84}writeTitle(e,t){t.title=e??"Layer"}createPopupTemplate(e){return Je(this,e)}createQuery(){return new O({where:"1=1",outFields:["*"]})}getField(e){for(let t=0;t<this.fields.length;t++)if(this.fields[t].name===e)return this.fields[t];return null}getFieldDomain(e,t){return null}queryFeatures(e,t){return T(this,null,function*(){let{resolvedQuery:i,queryEngine:r}=yield this._setupQueryObjects(e),s=xe.fromJSON(yield r.executeQuery(i.toJSON(),t?.signal));return s.features.forEach(o=>{o.sourceLayer=this}),s})}queryFeaturesJSON(e,t){return T(this,null,function*(){let{resolvedQuery:i,queryEngine:r}=yield this._setupQueryObjects(e);return yield r.executeQuery(i.toJSON(),t?.signal)})}queryFeatureCount(e,t){return T(this,null,function*(){let{resolvedQuery:i,queryEngine:r}=yield this._setupQueryObjects(e);return r.executeQueryForCount(i.toJSON(),t?.signal)})}queryExtent(){return T(this,arguments,function*(e={},t){let i=he($({},e),{returnGeometry:!0}),{resolvedQuery:r,queryEngine:s}=yield this._setupQueryObjects(i),o=yield s.executeQueryForExtent(r.toJSON(),t?.signal),l;return l=o.extent?.xmin!=null&&o.extent?.xmax!=null&&o.extent?.ymin!=null&&o.extent?.ymax!=null?new J(o.extent):new J,{count:o.count,extent:l}})}queryObjectIds(e,t){return T(this,null,function*(){let i=O.from(e),r;if(this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)r=this._cachedQueryEngine;else{let s=yield this.parentCompositeLayer.dataManager.getData(i,this,t);r=this.loadQueryEngine(s)}return r.executeQueryForIds(i.toJSON(),t?.signal)})}loadQueryEngine(e){let t=new Ce({geometryType:P.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ}),i=new Le({fieldsIndex:this.fieldsIndex.toJSON(),geometryType:P.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:this.spatialReference.toJSON(),timeInfo:null,featureStore:t});return i.featureStore.addMany(e),i}refreshCachedQueryEngine(){return T(this,null,function*(){let e=yield this.parentCompositeLayer.dataManager.getData(new O({where:"1=1",outFields:[L]}),this);this._cachedQueryEngine=this.loadQueryEngine(e)})}_setupQueryObjects(e,t){return T(this,null,function*(){let i=O.from(e),r=i.geometry,s;if(r&&!r.spatialReference?.isWGS84&&(yield te(r.spatialReference,G),i.geometry=B(r instanceof X||r instanceof Ee?r:r.extent,G)),this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)s=this._cachedQueryEngine;else{let o=yield this.parentCompositeLayer.dataManager.getData(i,this,t);s=this.loadQueryEngine(o)}return{resolvedQuery:i,queryEngine:s}})}};a([p(R(F(_e)))],d.prototype,"blendMode",void 0),a([p()],d.prototype,"capabilities",void 0),a([p({json:{origins:{"web-scene":{write:!1}},write:H()}})],d.prototype,"charts",void 0),a([p({readOnly:!0})],d.prototype,"defaultPopupTemplate",null),a([p({type:String,json:{origins:{service:{read:!1}},name:"layerDefinition.definitionExpression",write:{ignoreOrigin:!0}}})],d.prototype,"definitionExpression",void 0),a([p()],d.prototype,"displayField",void 0),a([p(R(F(Me)))],d.prototype,"effect",void 0),a([p()],d.prototype,"elevationInfo",void 0),a([p(R(F(Ae)))],d.prototype,"featureEffect",void 0),a([p(R(F(je)))],d.prototype,"featureReduction",null),a([p()],d.prototype,"fields",null),a([p()],d.prototype,"geometryType",null),a([p()],d.prototype,"geometryFieldName",null),a([p({type:["entity","relationship"],nonNullable:!0,json:{write:{isRequired:!0,ignoreOrigin:!0}}})],d.prototype,"graphType",void 0),a([p({type:String,nonNullable:!0,json:{write:{isRequired:!0,ignoreOrigin:!0}}})],d.prototype,"graphTypeName",null),a([p()],d.prototype,"hasM",null),a([p()],d.prototype,"hasZ",null),a([p({type:String,json:{origins:{service:{read:!1},"portal-item":{read:!1}},write:{ignoreOrigin:!0}}})],d.prototype,"id",void 0),a([p(R(F(He)))],d.prototype,"labelsVisible",void 0),a([p({type:[qe],json:{name:"layerDefinition.drawingInfo.labelingInfo",read:We,write:H()}})],d.prototype,"labelingInfo",void 0),a([p({readOnly:!0,json:{read:!1,write:{writer(e,t){t.layerType=this.geometryType?"KnowledgeGraphSubLayer":"KnowledgeGraphSubTable"},isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],d.prototype,"layerType",void 0),a([p(R(F(Ke)))],d.prototype,"legendEnabled",void 0),a([p(R(F(et)))],d.prototype,"maxScale",void 0),a([p(R(F(Xe)))],d.prototype,"minScale",void 0),a([p()],d.prototype,"objectIdField",void 0),a([p()],d.prototype,"objectType",void 0),a([p(R(F(Ze)))],d.prototype,"opacity",void 0),a([p(R(F(Pe)))],d.prototype,"orderBy",void 0),a([p()],d.prototype,"parentCompositeLayer",void 0),a([p(R(F(Ye)))],d.prototype,"popupEnabled",void 0),a([p({type:ke,json:{name:"popupInfo",write:{ignoreOrigin:!0}}})],d.prototype,"popupTemplate",void 0),a([p({type:Number,json:{write:{overridePolicy:lt}}})],d.prototype,"refreshInterval",void 0),a([p({types:ve,json:{name:"layerDefinition.drawingInfo.renderer",write:H()}})],d.prototype,"renderer",null),a([p()],d.prototype,"source",void 0),a([p()],d.prototype,"spatialReference",null),a([p({type:String,json:{write:{isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],d.prototype,"title",void 0),a([be("title")],d.prototype,"writeTitle",null),a([p({json:{read:!1}})],d.prototype,"type",void 0),a([p(R(F($e)))],d.prototype,"useViewTime",void 0),a([p({type:Boolean,json:{name:"visibility",write:H()}})],d.prototype,"visible",void 0),d=a([Q("esri.layers.knowledgeGraph.KnowledgeGraphSublayer")],d);var xi=d;export{Jt as a,Bt as b,Vt as c,L as d,Er as e,Nr as f,ue as g,ye as h,k as i,xi as j};

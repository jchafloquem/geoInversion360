import{b as Le}from"./chunk-ILWXVJPX.js";import{b as de,c as fe,d as pe,e as _e,f as ge,g as xe,h as ye,i as Me,j as ve,k as Pe,l as we,m as C,n as V,o as be,p as Ie,q as ke}from"./chunk-6WAZ263G.js";import{c as Se}from"./chunk-RU5D3FPM.js";import{Sa as A,a as P}from"./chunk-HWE2MRBZ.js";import{m as ue,q as W}from"./chunk-MODIWOII.js";import{h as he,i as le}from"./chunk-SE7FIBEW.js";import{a as me}from"./chunk-NOUYXRP4.js";import{g as U,h as ce,k as O}from"./chunk-AC7AQWXQ.js";import{b as ee}from"./chunk-37H4LYIE.js";import{a as k}from"./chunk-2EA2KAER.js";import{b as L,c as oe,e as J,j as R,p as K}from"./chunk-J57HR4DB.js";import{n as Q,t as ne}from"./chunk-UHE637ZN.js";import{a as G}from"./chunk-TNPL7MIN.js";import{a as F}from"./chunk-AQ74ANSJ.js";import{u as ae}from"./chunk-7JLWSSXP.js";import{b as re,q as se,s as ie}from"./chunk-BRWS572J.js";import{m as B}from"./chunk-AKNRR36C.js";import{a as D,b as T,g as S}from"./chunk-JEGVIFEP.js";function ze(o,e,s){return o[0]=e[0]-s[0],o[1]=e[1]-s[1],o}function De(o,e){return Math.sqrt(o*o+e*e)}function Ee(o){let e=De(o[0],o[1]);o[0]/=e,o[1]/=e}function Ge(o,e){return De(o[0]-e[0],o[1]-e[1])}function Re(o,e){return o[e+1]}function Be(o){return o.length-1}function Oe(o){let e=0;for(let s=0;s<Be(o);s++)e+=Ce(o,s);return e}function Ce(o,e,s=1){let[t,r]=Re(o,e);return[t,r]=[Math.round(t),Math.round(r)],Math.sqrt(t*t+r*r)*s}var te=class o{constructor(e,s,t,r,i){this._segments=e,this._index=s,this._distance=t,this._xStart=r,this._yStart=i,this._done=!1}static create(e){return new o(e,0,0,e[0][0],e[0][1])}clone(){return new o(this._segments,this._index,this._distance,this.xStart,this.yStart)}equals(e){return this._index===e._index||e._index===this._index-1&&(this._distance===0||e._distance===1)||e._index===this._index+1&&(this._distance===1||e._distance===0)}leq(e){return this._index<e._index||this._index===e._index&&this._distance<=e._distance}geq(e){return this._index>e._index||this._index===e._index&&this._distance>=e._distance}get _segment(){return this._segments[this._index+1]}get angle(){let e=this.dy,s=(0*e+-1*-this.dx)/(1*this.length),t=Math.acos(s);return e>0&&(t=2*Math.PI-t),t}get xStart(){return this._xStart}get yStart(){return this._yStart}get x(){return this.xStart+this.distance*this.dx}get y(){return this.yStart+this.distance*this.dy}get dx(){return this._segment[0]}get dy(){return this._segment[1]}get xMidpoint(){return this.xStart+.5*this.dx}get yMidpoint(){return this.yStart+.5*this.dy}get xEnd(){return this.xStart+this.dx}get yEnd(){return this.yStart+this.dy}get length(){let{dx:e,dy:s}=this;return Math.sqrt(e*e+s*s)}get remainingLength(){return this.length*(1-this._distance)}get backwardLength(){return this.length*this._distance}get distance(){return this._distance}get done(){return this._done}hasPrev(){return this._index-1>=0}hasNext(){return this._index+1<Be(this._segments)}next(){return this.hasNext()?(this._xStart+=this.dx,this._yStart+=this.dy,this._distance=0,this._index+=1,this):null}prev(){return this.hasPrev()?(this._index-=1,this._xStart-=this.dx,this._yStart-=this.dy,this._distance=1,this):(this._done=!0,null)}_seekBackwards(e,s){let t=this.backwardLength;if(e<=t)return this._distance=(t-e)/this.length,this;let r=this.backwardLength;for(;this.prev();){if(r+this.length>e)return this._seekBackwards(e-r);r+=this.length}return this._distance=0,s?this:null}seek(e,s=!1){if(e<0)return this._seekBackwards(Math.abs(e),s);if(e<=this.remainingLength)return this._distance=(this.backwardLength+e)/this.length,this;let t=this.remainingLength;for(;this.next();){if(t+this.length>e)return this.seek(e-t,s);t+=this.length}return this._distance=1,s?this:null}};function q(o,e,s,t=!0){let r=Oe(o),i=te.create(o),a=r/2;if(!t)return i.seek(a),void(Math.abs(i.x)<1024&&Math.abs(i.y)<1024&&s(i.clone(),0,a+0*e,r));let h=Math.max((r-e)/2,0),l=Math.floor(h/e),u=a-l*e;i.seek(u);for(let c=-l;c<=l;c++)Math.abs(i.x)<1024&&Math.abs(i.y)<1024&&s(i.clone(),c,a+c*e,r),i.seek(e)}function j(o,e){let s=e;for(let t=0;t<o.length;t++){let r=o[t];Ve(r,s);let i=[];i.push(r[0]);for(let a=1;a<r.length;a++){let[h,l]=r[a-1],[u,c]=r[a],n=u-h,m=c-l;i.push([n,m])}o[t]=i,r=i}return o}function Ve(o,e){if(e<=0)return;let t=o.length;if(t<3)return;let r=[],i=0;r.push(0);for(let n=1;n<t;n++)i+=Ge(o[n],o[n-1]),r.push(i);e=Math.min(e,.2*i);let a=[];a.push(o[0][0]),a.push(o[0][1]);let h=o[t-1][0],l=o[t-1][1],u=ze([0,0],o[0],o[1]);Ee(u),o[0][0]+=e*u[0],o[0][1]+=e*u[1],ze(u,o[t-1],o[t-2]),Ee(u),o[t-1][0]+=e*u[0],o[t-1][1]+=e*u[1];for(let n=1;n<t;n++)r[n]+=e;r[t-1]+=e;let c=.5*e;for(let n=1;n<t-1;n++){let m=0,p=0,_=0;for(let d=n-1;d>=0&&!(r[d+1]<r[n]-c);d--){let f=c+r[d+1]-r[n],g=r[d+1]-r[d],x=r[n]-r[d]<c?1:f/g;if(Math.abs(x)<1e-6)break;let y=x*x,I=x*f-.5*y*g,w=x*g/e,M=o[d+1],v=o[d][0]-M[0],b=o[d][1]-M[1];m+=w/I*(M[0]*x*f+.5*y*(f*v-g*M[0])-y*x*g*v/3),p+=w/I*(M[1]*x*f+.5*y*(f*b-g*M[1])-y*x*g*b/3),_+=w}for(let d=n+1;d<t&&!(r[d-1]>r[n]+c);d++){let f=c-r[d-1]+r[n],g=r[d]-r[d-1],x=r[d]-r[n]<c?1:f/g;if(Math.abs(x)<1e-6)break;let y=x*x,I=x*f-.5*y*g,w=x*g/e,M=o[d-1],v=o[d][0]-M[0],b=o[d][1]-M[1];m+=w/I*(M[0]*x*f+.5*y*(f*v-g*M[0])-y*x*g*v/3),p+=w/I*(M[1]*x*f+.5*y*(f*b-g*M[1])-y*x*g*b/3),_+=w}a.push(m/_),a.push(p/_)}a.push(h),a.push(l);for(let n=0,m=0;n<t;n++)o[n][0]=a[m++],o[n][1]=a[m++]}var N=1,z=0,Ze=128,qe=ae(o=>{let e=0;if(o===0)return 1/0;for(;!(o%2);)e++,o/=2;return e}),X=class extends V{constructor(){super(...arguments),this._zoomLevel=0}_write(e,s,t,r){if(this._zoomLevel=r||0,t!=null)throw new Error("InternalError: EffectGeometry not support for LabelMeshWriter");switch(s.geometryType){case"esriGeometryPoint":{let i=s.readXForDisplay(),a=s.readYForDisplay();return this._writePoint(e,i,a,s)}case"esriGeometryEnvelope":case"esriGeometryPolygon":case"esriGeometryMultipoint":{let i=s.readCentroidForDisplay();if(!i)return;let[a,h]=i.coords;return this._writePoint(e,a,h,s)}case"esriGeometryPolyline":this._writeLines(e,s)}}_writePoint(e,s,t,r){let i=this._getShaping();if(!i)return;let a=this._getPointReferenceBounds();a||(a={offsetX:0,offsetY:0,size:0});let h=i.boundsT,l=he(this.evaluatedMeshParams.horizontalAlignment),u=le(this.evaluatedMeshParams.verticalAlignment),c=this.evaluatedMeshParams.scaleInfo?.maxScale??0,n=this.evaluatedMeshParams.scaleInfo?.minScale??0,m=A(r.getDisplayId());e.metricStart(new W(m,s,t,l,u,c,n,a)),e.metricBoxWrite(h),this._writeGlyphs(e,r.getDisplayId(),s,t,i,0,a),e.metricEnd()}_getPointReferenceBounds(){if(!this._references)return null;for(let e of this._references){let s=e.getBoundsInfo();if(s)return s}return null}_writeLines(e,s){let{scaleInfo:t,verticalAlignment:r}=this.evaluatedMeshParams,i=this.evaluatedMeshParams.repeatLabelDistance||128,a=this._getShaping("middle");if(!a)return;let h=(u,c,n,m)=>this._placeSubdivGlyphs(u,c,n,m),l=(a.bounds.width+i)/(1<<N);this._current={out:e,id:s.getDisplayId(),shaping:a,zoomRange:fe(t,this.getTileInfo()),referenceBounds:this._getPointReferenceBounds()||{offsetX:0,offsetY:0,size:0},offsetDirection:null},this._verticalPlacement=r==="bottom"?"above":r==="top"?"below":null,this._verticalPlacement?this._writeAboveAndBelowAlong(s,h,l):this._writeCenterAlong(s,h,l)}_writeAboveAndBelowAlong(e,s,t){let{repeatLabel:r,fontSize:i}=this.evaluatedMeshParams,{shaping:a}=this._current,h=F(i),l=e.readGeometryForDisplay();if(!l)return;let u=new G;ne(u,l,!1,!1,"esriGeometryPolyline",1);let c=Ae(new G,u,h),n=Ae(new G,u,-h),m=Q(n,"esriGeometryPolyline",!1,!1),p=Q(c,"esriGeometryPolyline",!1,!1),_=j(p.paths,a.bounds.width),d=j(m.paths,a.bounds.width);this._current.offsetDirection="above";for(let f of _)q(f,t,s,!!r);this._current.offsetDirection="below";for(let f of d)q(f,t,s,!!r)}_writeCenterAlong(e,s,t){let{repeatLabel:r}=this.evaluatedMeshParams,{shaping:i}=this._current,a=j(e.readLegacyGeometryForDisplay().paths,i.bounds.width);for(let h of a)q(h,t,s,!!r)}_placeSubdivGlyphs(e,s,t,r){let{allowOverrun:i,labelPosition:a,repeatLabelDistance:h}=this.evaluatedMeshParams,l=this._current.zoomRange[0],u=qe(s),c=this._current.shaping.bounds.width/(1<<N),n=Math.sqrt(h||Ze)/(1<<N),m=Math.min(t,r-t),p=this._current.shaping.isMultiline?C:Math.log2(m/(n+c/2)),_=s===0?p:Math.min(u,p),d=Math.max(l,this._zoomLevel+N-_),f=this._zoomLevel-d,g=this._current.shaping.bounds.width/2*2**f;this._current.shaping.isMultiline?s===0&&this._placeStraight(e,d):i&&f<0?this._placeStraightAlong(e,l):a==="parallel"?this._placeStraightAlong(e,d):a==="curved"&&this._placeCurved(e,d,g)}_placeStraight(e,s){let{out:t,id:r,shaping:i,referenceBounds:a}=this._current,{x:h,y:l}=e,u=A(r),c=this.evaluatedMeshParams.scaleInfo?.maxScale??0,n=this.evaluatedMeshParams.scaleInfo?.minScale??0;t.metricStart(new W(u,e.x,e.y,0,0,c,n,null)),t.metricBoxWrite(i.boundsT);let m=e.angle*(180/Math.PI)%360,p=(e.angle*(180/Math.PI)+180)%360;this._writeGlyphs(t,r,h,l,i,0,a,{clipAngle:m,mapAligned:!0,isLineLabel:!0,minZoom:s}),this._writeGlyphs(t,r,h,l,i,0,a,{clipAngle:p,mapAligned:!0,isLineLabel:!0,minZoom:s}),t.metricEnd()}_placeCurved(e,s,t){let{out:r,id:i}=this._current,a=e.clone(),h=e.angle*(180/Math.PI)%360,l=(e.angle*(180/Math.PI)+180)%360,u=A(i),c=this.evaluatedMeshParams.scaleInfo?.maxScale??0,n=this.evaluatedMeshParams.scaleInfo?.minScale??0;r.metricStart(new W(u,e.x,e.y,0,0,c,n,null)),this._verticalPlacement&&this._verticalPlacement!==this._current.offsetDirection||(this._placeFirst(a,s,1,h),this._placeBack(e,a,s,t,1,h),this._placeForward(e,a,s,t,1,h)),this._verticalPlacement&&this._verticalPlacement===this._current.offsetDirection||(this._placeFirst(a,s,0,l),this._placeBack(e,a,s,t,0,l),this._placeForward(e,a,s,t,0,l)),r.metricEnd()}_placeStraightAlong(e,s){let{out:t,id:r,shaping:i,zoomRange:a,referenceBounds:h}=this._current,{boxBorderLineColor:l,boxBackgroundColor:u}=this.evaluatedMeshParams,c=e.clone(),n=e.angle*(180/Math.PI)%360,m=(e.angle*(180/Math.PI)+180)%360;if(i.glyphs.length>0&&!(!l&&!u)){let f=Math.max(s,a[0],0),g=Math.min(C,a[1]),x=ce(O(),-e.angle),y={minZoom:f,maxZoom:g,clipAngle:n,mapAligned:!0,isLineLabel:!0},I=F(this.evaluatedMeshParams.offsetX),w=F(this.evaluatedMeshParams.offsetY);if(!this._verticalPlacement||this._verticalPlacement===this._current.offsetDirection){let M=ee(I,-1*w),[v,b]=i.shapeBackground(U(O(),x,M));t.recordStart(this.instanceId,this.attributeLayout,i.glyphs[0].textureBinding);let E=2*Math.max(v.width,v.height);t.recordBounds(e.x+v.x,e.y+v.y,E,E),this._writeTextBox(t,r,e.x,e.y,b,h,y),t.recordEnd()}if(!this._verticalPlacement||this._verticalPlacement!==this._current.offsetDirection){let M=ee(I,w),[v,b]=i.shapeBackground(U(O(),x,M));y.clipAngle=m,t.recordStart(this.instanceId,this.attributeLayout,i.glyphs[0].textureBinding);let E=2*Math.max(v.width,v.height);t.recordBounds(e.x+v.x,e.y+v.y,E,E),this._writeTextBox(t,r,e.x,e.y,b,h,y),t.recordEnd()}}let p=A(r),_=this.evaluatedMeshParams.scaleInfo?.maxScale??0,d=this.evaluatedMeshParams.scaleInfo?.minScale??0;t.metricStart(new W(p,e.x,e.y,0,0,_,d,null)),this._verticalPlacement&&this._verticalPlacement!==this._current.offsetDirection||this._placeFirst(c,s,1,n,!0),this._verticalPlacement&&this._verticalPlacement===this._current.offsetDirection||this._placeFirst(c,s,0,m,!0),t.metricEnd()}_placeBack(e,s,t,r,i,a){let h=e.clone(),l=e.backwardLength+z;for(;h.prev()&&!(l>=r);)this._placeOnSegment(h,s,l,t,-1,i,a),l+=h.length+z}_placeForward(e,s,t,r,i,a){let h=e.clone(),l=e.remainingLength+z;for(;h.next()&&!(l>=r);)this._placeOnSegment(h,s,l,t,1,i,a),l+=h.length+z}_placeFirst(e,s,t,r,i=!1){let{out:a,id:h,shaping:l,zoomRange:u,referenceBounds:c}=this._current,n=l.glyphs;for(let m of n){let p=m.x>l.bounds.x?t:1-t,_=p*e.remainingLength+(1-p)*e.backwardLength,d=Math.abs(m.x+m.width/2-l.bounds.x),f=Math.max(0,this._zoomLevel+Math.log2(d/(_+z))),g=Math.max(s,i?0:f);m.maxZoom=Math.min(u[1],C),m.angle=e.angle+(1-t)*Math.PI,m.minZoom=Math.max(u[0],g),this._writeLineGlyph(a,h,e.x,e.y,l.bounds,m,r,c,!0),t&&this._isVisible(m.minZoom,m.maxZoom)&&a.metricBoxWrite(m.bounds)}}_placeOnSegment(e,s,t,r,i,a,h){let{out:l,id:u,shaping:c,referenceBounds:n}=this._current,m=c.glyphs,p=e.dx/e.length,_=e.dy/e.length,d={x:e.x+t*-i*p,y:e.y+t*-i*_};for(let f of m){let g=f.x>c.bounds.x?a:1-a;if(!(g&&i===1||!g&&i===-1))continue;let x=Math.abs(f.x+f.width/2-c.bounds.x),y=Math.max(0,this._zoomLevel+Math.log2(x/t)-.1),I=Math.max(r,this._zoomLevel+Math.log2(x/(t+e.length+z)));if(y!==0&&(f.angle=e.angle+(1-a)*Math.PI,f.minZoom=I,f.maxZoom=y,this._writeLineGlyph(l,u,d.x,d.y,c.bounds,f,h,n,!0),a&&this._isVisible(f.minZoom,f.maxZoom))){let w=f.bounds,M=e.x-s.x,v=e.y-s.y,b=new me(w.center[0]+M,w.center[1]+v,w.width,w.height);l.metricBoxWrite(b)}}}_writeLineGlyph(e,s,t,r,i,a,h,l,u){let c=t+i.x,n=r+i.y,m=2*(this.evaluatedMeshParams.minPixelBuffer?this.evaluatedMeshParams.minPixelBuffer/this._textMeshTransformProps.fontSize:1),p=Math.max(i.width,i.height)*m;e.recordStart(this.instanceId,this.attributeLayout,a.textureBinding),e.recordBounds(c,n,p,p);let{texcoords:_,offsets:d}=a,f=this._textMeshTransformProps.fontSize;this._writeQuad(e,s,t,r,{texcoords:_,offsets:d,fontSize:f,color:pe(this.evaluatedMeshParams.color),isBackground:!1,referenceBounds:l,minZoom:Math.max(this._current.zoomRange[0],a.minZoom),maxZoom:Math.min(this._current.zoomRange[1],a.maxZoom),clipAngle:h,mapAligned:u,isLineLabel:!0}),e.recordEnd()}_isVisible(e,s){let t=this._zoomLevel;return e<=t&&t<=s}};function Ae(o,e,s){let{coords:t,lengths:r}=e,i=k(),a=k(),h=k(),l=k(),u=k(),c=k(),n=2,m=0;for(let p=0;p<r.length;p++){let _=r[p];for(let d=0;d<_;d++){let f=n*(d+m-1),g=n*(d+m),x=n*(d+m+1);d>0?L(i,t[f],t[f+1]):L(i,0,0),L(a,t[g],t[g+1]),d<_-1?L(h,t[x],t[x+1]):L(h,0,0),d===0?L(l,0,0):(K(l,a,i),R(l,l),L(l,l[1],-l[0])),d===_-1?L(u,0,0):(K(u,h,a),R(u,u),L(u,u[1],-u[0])),oe(c,l,u),R(c,c);let y=c[0]*u[0]+c[1]*u[1];y!==0&&J(c,c,y),J(c,c,s),o.coords.push(a[0]+c[0],a[1]+c[1])}o.lengths.push(_),m+=_}return o}var Y=class extends Se{constructor(e){super(),this._value=e}resize(e){}read(e,s){return this._value}readWithDefault(e,s,t){return this._value}referencesScale(){return!1}referencesGeometry(){return!1}};var je=()=>se.getLogger("esri.views.2d.engine.webgl.shaderGraph.techniques.mesh.MeshWriterInputEvaluator");function $(o,e,s=!1){return S(this,null,function*(){let{defaultValue:t,valueExpressionInfo:r,value:i}=e;if(r){let{expression:a}=r,h=yield o.createComputedField({expression:a},s);return h?T(D({},e),{computed:h,defaultValue:t}):null}return T(D({},e),{computed:new Y(i),defaultValue:t})})}function We(o,e){return S(this,null,function*(){let{defaultValue:s,valueExpressionInfo:t}=e,{expression:r}=t,i=yield o.createComputedField({expression:r});return i?T(D({},e),{computed:i,defaultValue:s}):null})}var Te=o=>typeof o!="boolean"&&typeof o!="number"&&"valueExpressionInfo"in o,Ne=o=>o.some(e=>{for(let s in e){let t=e[s];if(Te(t))return!0}return!1}),H=class o{static create(e,s,t){return S(this,null,function*(){let r={},i=new Map,a=new Map,h=new Map,l=new Map,u=new Map;for(let c in t){let n=t[c];if(n!=null&&typeof n=="object")if(Array.isArray(n)){if(typeof n[0]=="object")throw new Error(`InternalError: Cannot handle ${c}. Nested array params are not supported`);r[c]=n}else if("valueExpressionInfo"in n){if(n.value){r[c]=n.value;continue}let m=yield We(e,n);if(!m){r[c]=n.defaultValue;continue}i.set(c,m),r[c]=null}else switch(n.type){case"cim-effect-infos":if(n.effectInfos.some(m=>m.overrides.length)){a.set(c,{effects:yield Promise.all(n.effectInfos.map(m=>S(this,null,function*(){let p=m.overrides.map(_=>$(e,_));return{effect:m.effect,compiledOverrides:(yield Promise.all(p)).filter(B)}})))});break}r[c]=n.effectInfos.map(m=>m.effect);break;case"cim-marker-placement-param":n.overrides.length&&h.set(c,{placementInfo:n,compiledOverrides:(yield Promise.all(n.overrides.map(m=>$(e,m)))).filter(B)}),r[c]=n.placement;break;case"text-rasterization-param":{if(n.overrides.length){let p=n.overrides.map(_=>$(e,_,n.useLegacyLabelEvaluationRules));l.set(c,{compiledOverrides:(yield Promise.all(p)).filter(B),rasterizationParam:n,objectIdToResourceId:new Map});continue}let m={type:"cim-rasterization-info",resource:n.resource};r[c]=(yield s.fetchResourceImmediate(m))??null;break}case"sprite-rasterization-param":{if(n.overrides.length){let p=n.overrides.map(_=>$(e,_));l.set(c,{compiledOverrides:(yield Promise.all(p)).filter(B),rasterizationParam:n,objectIdToResourceId:new Map});continue}if(n.resource.type==="animated"){l.set(c,{compiledOverrides:[],rasterizationParam:n,objectIdToResourceId:new Map});continue}let m={type:"cim-rasterization-info",resource:n.resource};r[c]=(yield s.fetchResourceImmediate(m))??null;break}case"cim-marker-transform-param":{let{params:m}=n;if(Ne(m)){let p={compiledMarkerInfos:[]};yield Promise.all(m.map(_=>S(this,null,function*(){let d={props:{}};for(let f in _)if(Te(_[f])){let g=yield We(e,_[f]);d.compiledExpressionMap||(d.compiledExpressionMap=new Map);let x=d.compiledExpressionMap;g&&x.set(f,g)}else d.props[f]=_[f];p.compiledMarkerInfos.push(d)}))),u.set(c,p)}else r[c]={type:"cim-marker-transform-info",infos:m};break}default:r[c]=n}else r[c]=n}return new o(t,r,i,a,h,l,u)})}constructor(e,s,t,r,i,a,h){this.inputMeshParams=e,this._resolvedMeshParams=s,this._dynamicProperties=t,this._dynamicEffectProperties=r,this._dynamicPlacementProperties=i,this._dynamicAsyncProperties=a,this._dynamicTransformProperties=h,this.evaluator=l=>l}get hasDynamicProperties(){return!!(this._dynamicProperties.size||this._dynamicAsyncProperties.size||this._dynamicEffectProperties.size||this._dynamicTransformProperties.size||this._dynamicPlacementProperties.size)}get evaluatedMeshParams(){return this._evaluatedMeshParams||(this._evaluatedMeshParams=this.evaluator(this._resolvedMeshParams)),this._evaluatedMeshParams}enqueueRequest(e,s,t){for(let r of this._dynamicAsyncProperties.values()){let i=re(r.rasterizationParam.resource);r.rasterizationParam.resource.type==="animated"&&r.rasterizationParam.resource.randomizeStartTime&&(i.primitiveName="__RESERVED__PRIMITIVE__NAME__",i.startGroup=Le(s.getObjectId()||0));for(let{primitiveName:h,propertyName:l,computed:u,defaultValue:c,valueExpressionInfo:n}of r.compiledOverrides)try{let m=r.rasterizationParam.resource.type==="animated"?i.primitiveName:h;ue(i,m,l,u,s,t,c)}catch(m){je().errorOnce(new ie("invalid-arcade-expression",`Encountered an error when evaluating the arcade expression '${n?.expression}' (primitive: '${h}', property: '${l}')`,m))}let a=e.enqueueRequest({type:"cim-rasterization-info",resource:i});r.objectIdToResourceId.set(s.getObjectId(),a)}}evaluateMeshParams(e,s,t){for(let[r,i]of this._dynamicProperties.entries())this._resolvedMeshParams[r]=i.computed.readWithDefault(s,t,i.defaultValue);for(let[r,i]of this._dynamicPlacementProperties.entries())for(let{computed:a,defaultValue:h,propertyName:l}of i.compiledOverrides){let u=a.readWithDefault(s,t,h);i.placementInfo.placement[l]=u,this._resolvedMeshParams[r]=i.placementInfo.placement}for(let[r,i]of this._dynamicEffectProperties.entries())for(let a of i.effects){for(let{computed:h,defaultValue:l,propertyName:u}of a.compiledOverrides){let c=h.readWithDefault(s,t,l);a.effect[u]=c}this._resolvedMeshParams[r]=i.effects.map(h=>h.effect)}for(let[r,i]of this._dynamicTransformProperties.entries()){let a={type:"cim-marker-transform-info",infos:[]};for(let h of i.compiledMarkerInfos){let l=D({},h.props);if(h.compiledExpressionMap)for(let[u,c]of h.compiledExpressionMap){let n=c.computed.readWithDefault(s,t,c.defaultValue);l[u]=typeof n=="number"||typeof n=="boolean"?n:c.defaultValue}a.infos.push(l)}this._resolvedMeshParams[r]=a}for(let[r,i]of this._dynamicAsyncProperties.entries()){let a=i.objectIdToResourceId.get(s.getObjectId());if(a==null)continue;let h=e.getResource(a);this._resolvedMeshParams[r]=h}return this._evaluatedMeshParams=this.evaluator(this._resolvedMeshParams),this.evaluatedMeshParams}};var Fe=class{createMeshWriter(e,s,t,r){return S(this,null,function*(){let i=this._getMeshWriter(r.techniqueType),a=yield H.create(e,s,r.inputParams),h=new i(r.id,a,r.optionalAttributes,t);return yield h.loadDependencies(),h})}_getMeshWriter(e){switch(e){case P.Fill:return _e;case P.DotDensity:return de;case P.ComplexFill:return xe;case P.PatternFill:return ge;case P.OutlineFill:return Me;case P.PatternOutlineFill:return Pe;case P.ComplexOutlineFill:return ve;case P.Marker:return Ie;case P.PieChart:return ke;case P.Text:return V;case P.Line:return ye;case P.TexturedLine:return be;case P.Heatmap:return we;case P.Label:return X;case P.Test:throw new Error("Internal Error: Found invalid mesh writer")}}};export{Y as a,Fe as b};

import{a as g,b as x,c as N,d as y}from"./chunk-LOEAA5XF.js";import{a as k}from"./chunk-MAPO7YGF.js";import{a as E}from"./chunk-IFCRPPYQ.js";import{a as M}from"./chunk-PJQZD5QI.js";import{q as D}from"./chunk-BRWS572J.js";var U=()=>D.getLogger("esri.renderers.visualVariables.support.visualVariableUtils"),S=t=>U().warn(`The visualVariable should be an instance of esri.renderers.visualVariables.${t}`),w=()=>U().error("Use of arcade expressions requires an arcade context"),T=new k,z=Math.PI,ae=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i;function q(t,r,a){let e="visualVariables"in t&&t.visualVariables?t.visualVariables.find(c=>c.type==="color"):t;if(!e)return;if(e.declaredClass!=="esri.renderers.visualVariables.ColorVariable")return void S("ColorVariable");let i=typeof r=="number",n=i?null:r,l=n?.attributes,o=i?r:null,s=e.field,{ipData:f,hasExpression:v}=e.cache,u=e.cache.compiledFunc;if(!s&&!v){let c=e.stops;return c&&c[0]&&c[0].color}if(typeof o!="number")if(v){if(a?.arcade==null)return void w();let c={viewingMode:a.viewingMode,scale:a.scale,spatialReference:a.spatialReference},p=a.arcade.arcadeUtils,h=p.getViewInfo(c),V=p.createExecContext(n,h,a.timeZone);if(!u){let F=p.createSyntaxTree(e.valueExpression);u=p.createFunction(F),e.cache.compiledFunc=u}o=p.executeFunction(u,V)}else l&&(o=l[s]);let d=e.normalizationField,m=l!=null&&d!=null?parseFloat(l[d]):void 0;if(o!=null&&(!d||i||!isNaN(m)&&m!==0)){isNaN(m)||i||(o/=m);let c=C(o,f);if(c){let p=c[0],h=c[1],V=p===h?e.stops[p].color:E.blendColors(e.stops[p].color,e.stops[h].color,c[2],a?.color);return new E(V)}}}function A(t,r,a){let e="visualVariables"in t&&t.visualVariables?t.visualVariables.find(c=>c.type==="opacity"):t;if(!e)return;if(e.declaredClass!=="esri.renderers.visualVariables.OpacityVariable")return void S("OpacityVariable");let i=typeof r=="number",n=i?null:r,l=n?.attributes,o=i?r:null,s=e.field,{ipData:f,hasExpression:v}=e.cache,u=e.cache.compiledFunc;if(!s&&!v){let c=e.stops;return c&&c[0]&&c[0].opacity}if(typeof o!="number")if(v){if(a?.arcade==null)return void w();let c={viewingMode:a.viewingMode,scale:a.scale,spatialReference:a.spatialReference},p=a.arcade.arcadeUtils,h=p.getViewInfo(c),V=p.createExecContext(n,h,a.timeZone);if(!u){let F=p.createSyntaxTree(e.valueExpression);u=p.createFunction(F),e.cache.compiledFunc=u}o=p.executeFunction(u,V)}else l&&(o=l[s]);let d=e.normalizationField,m=l!=null&&d!=null?parseFloat(l[d]):void 0;if(o!=null&&(!d||i||!isNaN(m)&&m!==0)){isNaN(m)||i||(o/=m);let c=C(o,f);if(c){let p=c[0],h=c[1];if(p===h)return e.stops[p].opacity;{let V=e.stops[p].opacity;return V+(e.stops[h].opacity-V)*c[2]}}}}function O(t,r,a){let e="visualVariables"in t&&t.visualVariables?t.visualVariables.find(m=>m.type==="rotation"):t;if(!e)return;if(e.declaredClass!=="esri.renderers.visualVariables.RotationVariable")return void S("RotationVariable");let i=e.axis||"heading",n=i==="heading"&&e.rotationType==="arithmetic"?90:0,l=i==="heading"&&e.rotationType==="arithmetic"?-1:1,o=typeof r=="number"?null:r,s=o?.attributes,f=e.field,{hasExpression:v}=e.cache,u=e.cache.compiledFunc,d=0;if(!f&&!v)return d;if(v){if(a?.arcade==null)return void w();let m={viewingMode:a.viewingMode,scale:a.scale,spatialReference:a.spatialReference},c=a.arcade.arcadeUtils,p=c.getViewInfo(m),h=c.createExecContext(o,p,a.timeZone);if(!u){let V=c.createSyntaxTree(e.valueExpression);u=c.createFunction(V),e.cache.compiledFunc=u}d=c.executeFunction(u,h)}else s&&(d=s[f]||0);return d=typeof d!="number"||isNaN(d)?null:n+l*d,d}function Z(t,r,a){let e=typeof r=="number",i=e?null:r,n=i?.attributes,l=e?r:null,{isScaleDriven:o}=t.cache,s=t.cache.compiledFunc;if(o){let v=a?.scale,u=a?.view;l=v==null||u==="3d"?$(t):v}else if(!e)switch(t.inputValueType){case g.Expression:{if(a?.arcade==null)return void w();let v={viewingMode:a.viewingMode,scale:a.scale,spatialReference:a.spatialReference},u=a.arcade.arcadeUtils,d=u.getViewInfo(v),m=u.createExecContext(i,d,a.timeZone);if(!s){let c=u.createSyntaxTree(t.valueExpression);s=u.createFunction(c),t.cache.compiledFunc=s}l=u.executeFunction(s,m);break}case g.Field:n&&(l=n[t.field]);break;case g.Unknown:l=null}if(!y(l))return null;if(e||!t.normalizationField)return l;let f=n?parseFloat(n[t.normalizationField]):null;return y(f)&&f!==0?l/f:null}function $(t){let r=null,a=null,e=t.stops;return e?(r=e[0].value,a=e[e.length-1].value):(r=t.minDataValue||0,a=t.maxDataValue||0),(r+a)/2}function R(t,r,a){let e="visualVariables"in t&&t.visualVariables?t.visualVariables.find(n=>n.type==="size"):t;if(!e)return;if(e.declaredClass!=="esri.renderers.visualVariables.SizeVariable")return void S("SizeVariable");let i=H(Z(e,r,a),e,r,a,e.cache.ipData);return i==null||isNaN(i)?0:i}function b(t,r,a){return t==null?null:N(t)?R(t,r,a):y(t)?t:null}function I(t,r,a){return y(a)&&t>a?a:y(r)&&t<r?r:t}function L(t,r,a,e){return t+((b(r.minSize,a,e)||r.minDataValue)??0)}function P(t,r,a){let e=t.stops,i=e?.length&&e[0].size;return i==null&&(i=t.minSize),b(i,r,a)}function B(t,r,a,e){let i=(t-r.minDataValue)/(r.maxDataValue-r.minDataValue),n=b(r.minSize,a,e),l=b(r.maxSize,a,e),o=e?.shape;if(t<=r.minDataValue)return n;if(t>=r.maxDataValue)return l;if(n==null||l==null)return null;if(r.scaleBy==="area"&&o){let s=o==="circle",f=s?z*(n/2)**2:n*n,v=f+i*((s?z*(l/2)**2:l*l)-f);return s?2*Math.sqrt(v/z):Math.sqrt(v)}return n+i*(l-n)}function W(t,r,a,e){let i=e?.shape,n=t/r.minDataValue,l=b(r.minSize,a,e),o=b(r.maxSize,a,e),s=null;return s=i==="circle"?2*Math.sqrt(n*(l/2)**2):i==="square"||i==="diamond"||i==="image"?Math.sqrt(n*l**2):n*l,I(s,l,o)}function j(t,r,a,e,i){let[n,l,o]=C(t,i);if(n===l)return b(r.stops?.[n].size,a,e);{let s=b(r.stops?.[n].size,a,e);return s+(b(r.stops?.[l].size,a,e)-s)*o}}function G(t,r,a,e){let i=(e?.resolution??1)*M[r.valueUnit],n=b(r.minSize,a,e),l=b(r.maxSize,a,e),{valueRepresentation:o}=r,s=null;return s=o==="area"?2*Math.sqrt(t/z)/i:o==="radius"||o==="distance"?2*t/i:t/i,I(s,n,l)}function H(t,r,a,e,i){switch(r.transformationType){case x.Additive:return L(t,r,a,e);case x.Constant:return P(r,a,e);case x.ClampedLinear:return B(t,r,a,e);case x.Proportional:return W(t,r,a,e);case x.Stops:return j(t,r,a,e,i);case x.RealWorldSize:return G(t,r,a,e);case x.Identity:return t;case x.Unknown:return null}}function te(t,r,a){let{isScaleDriven:e}=t.cache;if(!(e&&a==="3d"||r))return null;let i={scale:r,view:a},n=b(t.minSize,T,i),l=b(t.maxSize,T,i);if(n!=null||l!=null){if(n>l){let o=l;l=n,n=o}return{minSize:n,maxSize:l}}}function re(t,r,a){if(!t.visualVariables)return;let e=[],i=[],n=[],l=[],o=[];for(let s of t.visualVariables)switch(s.type){case"color":i.push(s);break;case"opacity":n.push(s);break;case"rotation":o.push(s);break;case"size":l.push(s)}return i.forEach(s=>{let f=q(s,r,a);e.push({variable:s,value:f})}),n.forEach(s=>{let f=A(s,r,a);e.push({variable:s,value:f})}),o.forEach(s=>{let f=O(s,r,a);e.push({variable:s,value:f})}),l.forEach(s=>{let f=R(s,r,a);e.push({variable:s,value:f})}),e.filter(s=>s.value!=null)}function C(t,r){if(!r)return;let a=0,e=r.length-1;return r.some((i,n)=>t<i?(e=n,!0):(a=n,!1)),[a,e,(t-r[a])/(r[e]-r[a])]}function ne(t,r,a){let e=["proportional","proportional","proportional"];for(let i of t){let n=i.useSymbolValue?"symbol-value":R(i,r,a);switch(i.axis){case"width":e[0]=n;break;case"depth":e[1]=n;break;case"height":e[2]=n;break;case"width-and-depth":e[0]=n,e[1]=n;break;case"all":case void 0:case null:e[0]=n,e[1]=n,e[2]=n;break;default:i.axis}}return e}export{ae as a,q as b,A as c,O as d,R as e,b as f,H as g,te as h,re as i,ne as j};
